<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construction Estimate Calculator</title>
    <!-- Link to Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Link to Chart.js for the pie chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Base styles and UI improvements */
        body {
            margin: 0;
            font-family: 'Inter var', system-ui, -apple-system, sans-serif; /* Added Inter var for modern feel */
            background: linear-gradient(135deg, #e0f2fe 0%, #c1e0fa 100%); /* Lighter, softer blue gradient */
            min-height: 100vh;
            color: #374151; /* Default text color */
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .card {
            background: white;
            border-radius: 16px; /* Slightly more rounded */
            box-shadow: 0 6px 25px rgba(0,0,0,0.08); /* Softer, larger shadow */
            padding: 30px; /* More padding */
            margin-bottom: 25px;
        }
        .input-field {
            width: 100%;
            padding: 10px 14px; /* Larger padding */
            border: 1px solid #d1d5db; /* Softer border */
            border-radius: 8px; /* More rounded */
            font-size: 15px; /* Slightly larger font */
            transition: border-color 0.2s, box-shadow 0.2s;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.04); /* Subtle inner shadow */
        }
        .input-field:focus {
            outline: none;
            border-color: #60a5fa; /* Lighter blue focus */
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.3); /* Subtle blue glow */
        }
        .btn {
            padding: 12px 25px; /* More padding */
            border-radius: 10px; /* More rounded */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out; /* Smoother transition */
            border: none;
            font-size: 15px;
        }
        .btn-primary {
            background: #2563eb; /* Deeper blue (Tailwind blue-600) */
            color: white;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.2);
        }
        .btn-primary:hover {
            background: #1D4ED8; /* Even deeper blue (Tailwind blue-700) */
            box-shadow: 0 6px 20px rgba(29, 78, 216, 0.3);
            transform: translateY(-1px); /* Slight lift */
        }
        .btn-green {
            background: #10b981; /* Brighter green (Tailwind emerald-500) */
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2);
        }
        .btn-green:hover {
            background: #059669; /* Deeper green (Tailwind emerald-600) */
            box-shadow: 0 6px 20px rgba(5, 150, 105, 0.3);
            transform: translateY(-1px);
        }
        .btn-red {
            background: #ef4444; /* Brighter red (Tailwind red-500) */
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.2);
        }
        .btn-red:hover {
            background: #dc2626; /* Deeper red (Tailwind red-600) */
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.3);
            transform: translateY(-1px);
        }

        table {
            width: 100%;
            border-collapse: separate; /* Allows border-radius on cells */
            border-spacing: 0; /* Remove space between cells */
        }
        th, td {
            padding: 15px; /* More padding */
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap; /* Prevent text wrapping in table headers/cells */
        }
        th {
            background: #f3f4f6; /* Softer header background */
            font-weight: 600;
            color: #4b5563;
            position: sticky; /* Sticky header for scrollable tables */
            top: 0;
            z-index: 1;
        }
        /* Rounded corners for table header */
        th:first-child { border-top-left-radius: 10px; }
        th:last-child { border-top-right-radius: 10px; } /* This might apply to the last TH of the whole table. Need to be mindful of multi-colspan headers. */

        tr:nth-child(even) {
            background: #f8fafc; /* Subtle zebra striping */
        }
        tr:hover {
            background: #e0f2fe; /* Light blue on hover */
            transition: background 0.15s ease-in-out;
        }
        .setup-wizard {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6); /* Slightly darker overlay */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px); /* Subtle blur effect */
        }
        .wizard-content {
            background: white;
            border-radius: 20px; /* More rounded */
            padding: 45px; /* More padding */
            max-width: 650px; /* Slightly wider */
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); /* Stronger shadow */
        }
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 35px; /* More spacing */
        }
        .step {
            width: 45px; /* Larger step circles */
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 12px;
            font-weight: bold;
            font-size: 18px; /* Larger number */
            transition: background 0.3s, color 0.3s;
        }
        .step.active {
            background: #3b82f6;
            color: white;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
        }
        .step.inactive {
            background: #e5e7eb;
            color: #6b7280;
        }
        .form-group {
            margin-bottom: 25px; /* More spacing between form groups */
        }
        .label {
            display: block;
            margin-bottom: 8px; /* More space below label */
            font-weight: 600;
            color: #4b5563; /* Softer label color */
            font-size: 15px;
        }
        h1 {
            font-size: 32px;
            color: #1f2937;
            margin-bottom: 15px !important; /* Ensure consistent heading margin */
        }
        h2 {
            font-size: 26px;
            color: #1f2937;
            margin-bottom: 25px !important;
        }
        h3 {
            font-size: 22px;
            color: #1f2937;
            margin-bottom: 20px !important;
        }
        /* Specific styles for the project info header in main app */
        .header-info-container {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap; /* Allows wrapping on smaller screens */
        }
        /* Reverted header-icon-box to be a rounded rectangle, matching the "most up-to-date" immersive from the user's prompt */
        .header-icon-box {
            background: #3b82f6;
            padding: 15px;
            border-radius: 12px; /* Rounded rectangle */
            display: flex;
            align-items: center;
            justify-content: center;
            width: 64px; /* Fixed size */
            height: 64px;
            overflow: hidden; /* Hide overflow for images */
        }
        .header-logo-img { /* Style for the actual logo image */
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; /* Ensure image fits without cropping */
        }
        .header-title-container {
            line-height: 1.3;
        }
        .header-title {
            margin: 0;
            color: #1f2937;
            font-size: 28px;
            font-weight: 700; /* Make title bolder */
        }
        .header-subtitle {
            margin: 5px 0 0 0;
            color: #6b7280;
            font-size: 16px;
        }
        /* Small adjustment for the action buttons in the header */
        .header-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px; /* Add margin for small screens */
        }

        /* Top Summary Row Styles (3 columns: Proposal, Hours, Chart) */
        .top-summary-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* Explicitly 3 columns on large screens */
            gap: 20px;
            margin-bottom: 25px;
        }
        .summary-overall-metric-card {
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%); /* Deeper blue gradient for prominence */
            color: white;
            text-align: center;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(29, 78, 216, 0.3);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 150px; /* Ensure some height */
        }
        .summary-overall-metric-card .label {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: rgba(255,255,255,0.9);
        }
        .summary-overall-metric-card .value {
            font-size: 3rem; /* Larger font for main value */
            font-weight: 800;
            line-height: 1;
        }
         /* Pie Chart specific styles (now in top row, also a card) */
        .chart-container.card { /* Make it a card for consistent styling */
            padding: 20px; /* Adjust padding for visual balance */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 150px; /* Match height of other top cards if possible */
        }
        .chart-canvas {
            max-width: 100%; /* Make chart responsive */
            max-height: 200px; /* Adjust max height for top row display */
            height: auto;
            width: auto; /* Allow chart.js to manage width within limits */
        }
        .chart-container.card h4 { /* Style the title of the chart in the new layout */
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 10px;
            text-align: center;
        }


        /* Executive Summary Grid (now 3 columns) specific styles */
        .executive-summary-grid-3col { /* Renamed class for clarity */
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* Explicitly 3 columns on large screens */
            gap: 20px;
        }
        .executive-summary-grid-3col .card { /* Ensure cards within this grid don't have extra bottom margin */
            margin-bottom: 0;
        }
        .summary-block h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 10px;
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 0.95rem;
            color: #4b5563;
        }
        .summary-item strong {
            color: #1f2937;
        }
        .summary-item.total {
            font-weight: bold;
            font-size: 1.1rem;
            color: #0d47a1; /* Darker blue for totals */
            border-top: 1px dashed #cbd5e1;
            margin-top: 8px;
            padding-top: 8px;
        }


        /* Responsive adjustments */
        @media (max-width: 1024px) { /* Adjust grid for medium screens */
            .top-summary-row {
                grid-template-columns: repeat(2, 1fr); /* 2 columns on medium screens */
            }
            .executive-summary-grid-3col { /* Renamed class */
                grid-template-columns: repeat(2, 1fr); /* 2 columns on medium screens */
            }
            /* Adjust table for smaller screens */
            table, thead, tbody, th, td, tr {
                display: block; /* Make table elements stack for smaller screens */
            }
            thead tr {
                position: absolute;
                top: -9999px; /* Hide table headers visually on small screens */
                left: -9999px;
            }
            tr {
                border: 1px solid #ccc; /* Add border to rows */
                margin-bottom: 10px;
                border-radius: 8px; /* Rounded corners for rows */
                overflow: hidden; /* Hide overflow for rounded corners */
            }
            td {
                border: none; /* Remove individual cell borders */
                position: relative;
                padding-left: 50%; /* Make space for pseudo-element labels */
                text-align: right;
                font-size: 14px;
            }
            td:before {
                /* Create a label for each cell using data-label attribute */
                content: attr(data-label);
                position: absolute;
                left: 6px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
                color: #4b5563;
            }
            /* Specific adjustments for input fields in responsive table cells */
            td .input-field, td select {
                width: calc(100% - 10px); /* Adjust width to fit within cell padding */
                text-align: right; /* Align input text to the right */
            }
            td:nth-of-type(1):before { content: "Task Name:"; }
            td:nth-of-type(2):before { content: "Description:"; }
            td:nth-of-type(3):before { content: "OT/DT Multiplier:"; }
            td:nth-of-type(4):before { content: "Skill:"; }
            td:nth-of-type(5):before { content: "$/hr:"; }
            td:nth-of-type(6):before { content: "# hrs:"; }
            td:nth-of-type(7):before { content: "Labor Total:"; }
            td:nth-of-type(8):before { content: "QTY / UNIT:"; }
            td:nth-of-type(9):before { content: "$ / UNIT:"; }
            td:nth-of-type(10):before { content: "Materials Total:"; }
            td:nth-of-type(11):before { content: "Equipment / Rental:"; }
            td:nth-of-type(12):before { content: "Subcontractor:"; }
            td:nth-of-type(13):before { content: "Misc.:"; }
            td:nth-of-type(14):before { content: "Other Total:"; }
            td:nth-of-type(15):before { content: "TOTAL:"; }
            td:nth-of-type(16):before { content: "Actions:"; }

        }

        @media (max-width: 768px) {
            .card, .wizard-content {
                padding: 20px;
                margin-bottom: 15px;
            }
            .btn {
                padding: 10px 20px;
                font-size: 14px;
            }
            .header-title {
                font-size: 24px;
            }
            .header-subtitle {
                font-size: 15px;
            }
            /* Removed th, td font-size adjust for more consistent mobile labels */

            .summary-overall-metric-card {
                padding: 20px;
            }
            .summary-overall-metric-card .label {
                font-size: 1.2rem;
            }
            .summary-overall-metric-card .value {
                font-size: 2.5rem;
            }
            .top-summary-row, .executive-summary-grid-3col { /* Renamed class */
                grid-template-columns: 1fr; /* Stack columns on small screens */
            }
            .chart-container.card h4 {
                font-size: 1rem; /* Smaller title for chart on mobile */
            }
        }

        /* Specific styles for multi-select dropdown */
        .multi-select-container {
            position: relative;
        }
        .multi-select-dropdown {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 8px;
            max-height: 150px;
            overflow-y: auto;
            background-color: white;
            position: absolute;
            width: 100%;
            z-index: 10;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .multi-select-dropdown label {
            display: block;
            padding: 6px 10px;
            cursor: pointer;
        }
        .multi-select-dropdown label:hover {
            background-color: #f3f4f6;
        }
        .multi-select-dropdown input[type="checkbox"] {
            margin-right: 8px;
        }
        .selected-trades-display {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            min-height: 40px;
            cursor: pointer;
            background-color: white;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }
        .selected-trade-tag {
            background-color: #e0f2fe; /* Light blue tag */
            color: #1e40af; /* Dark blue text */
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .selected-trade-tag .remove-tag {
            cursor: pointer;
            font-weight: bold;
            color: #94a3b8; /* Gray for X */
        }
        /* Styles for dynamic labor rate inputs in wizard */
        .trade-labor-rates-group {
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px; /* Space between trade groups */
            background-color: #fcfcfc;
        }
        .trade-labor-rates-group h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.25rem;
            color: #1f2937;
            padding-bottom: 10px; /* Space below header */
            border-bottom: 1px solid #e5e7eb; /* Separator for trade header */
        }

        .skill-level-row {
            display: flex;
            align-items: center; /* Align to the center of the content in the row */
            margin-bottom: 15px;
            gap: 15px; /* Increased space between skill name and rate input */
            padding-bottom: 10px; /* Add some padding below each row */
            border-bottom: 1px dashed #e5e7eb; /* Subtle separator for skill rows */
            justify-content: space-between; /* Pushes skill name to left, rate input to right */
        }
        .skill-level-row:last-child {
            margin-bottom: 0;
            border-bottom: none; /* No border for the last one */
            padding-bottom: 0;
        }

        .skill-name-display { /* New class for plain text skill name */
            font-weight: 600;
            color: #1f2937;
            font-size: 15px;
            flex-shrink: 0; /* Prevent shrinking if content is long */
            width: 150px; /* Give it a fixed width for alignment */
        }

        /* Adjustments for the rate input to align with the design */
        .rate-input-group { /* Combined rate label, input, and delete button */
            display: flex;
            align-items: center;
            gap: 8px; /* Space between rate label, input, and delete button */
            flex-grow: 1; /* Allow to grow and take remaining space */
            justify-content: flex-end; /* Push rate input to the right within its group */
        }
        .rate-label {
            white-space: nowrap; /* Prevent label from wrapping */
            font-weight: 600;
            color: #4b5563;
            font-size: 15px;
            margin-right: 0; /* Remove previous margin-right */
        }
        .rate-input { /* Specific class for the rate input field */
            width: 100px; /* Fixed width for rate input for consistent alignment */
            flex-shrink: 0; /* Prevent shrinking */
        }
        /* Style for editable skill name input */
        .skill-name-input.editable {
            width: 150px; /* Match width of skill-name-display */
            padding: 10px 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 15px;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.04);
            transition: border-color 0.2s, box-shadow 0.2s;
            flex-shrink: 0;
            box-sizing: border-box; /* Include padding and border in the width */
        }
        .skill-name-input.editable:focus {
            outline: none;
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.3);
        }


        /* Smaller, aligned remove button */
        .remove-skill-btn {
            background-color: #ef4444; /* Red */
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px; /* Smaller width */
            height: 24px; /* Smaller height */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px; /* Smaller font for minus/X */
            line-height: 1;
            cursor: pointer;
            flex-shrink: 0; /* Don't shrink the button */
            transition: background-color 0.2s ease;
            margin-bottom: 0; /* No bottom margin needed */
            margin-left: 0; /* No explicit margin-left needed, gap handles it */
            position: static; /* Remove relative positioning */
            top: auto; /* Remove top adjustment */
        }
        .remove-skill-btn:hover {
            background-color: #dc2626; /* Darker red */
        }

        .advanced-link-wrapper {
            width: 100%;
            text-align: left; /* Align to the left */
            margin-top: 20px; /* Space above the button bar */
        }
        .advanced-link {
            color: #2563eb; /* Primary blue color for the link */
            text-decoration: underline;
            font-size: 0.95rem;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .advanced-link:hover {
            color: #1D4ED8; /* Darker blue on hover */
        }

        /* Styles for the logo upload area (Step 1 of wizard) - REVERTED TO RECTANGULAR */
        .logo-upload-area {
            background: #f8fafc; /* Light gray background */
            border: 2px dashed #cbd5e1; /* Dashed border */
            border-radius: 12px; /* Rectangular with rounded corners */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px; /* Generous padding */
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            min-height: 120px; /* Ensure some minimum height */
            gap: 10px; /* Space between crane and text */
            position: relative; /* For positioning the image */
            overflow: hidden; /* Hide overflow for image */
        }
        .logo-upload-area:hover {
            background: #e0f2fe; /* Lighter blue on hover */
            border-color: #60a5fa; /* Blue border on hover */
        }
        .logo-upload-area.drag-over {
            background: #dbeafe; /* Even lighter blue when dragging over */
            border-color: #3b82f6; /* Solid blue border when dragging over */
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.4);
        }

        /* Image preview within the upload area (for wizard) */
        .logo-upload-area .wizard-logo-img-preview {
            max-width: 100%;
            max-height: 100px; /* Limit height of uploaded logo in wizard */
            object-fit: contain; /* Ensure image fits without cropping */
            border-radius: 8px; /* Slightly rounded corners for the logo itself */
        }

        /* Default icon and text when no logo is loaded (always visible in this format) */
        .logo-upload-area .default-icon {
            font-size: 32px;
            color: #3b82f6;
        }
        .logo-upload-area .upload-text {
            font-size: 0.9rem;
            color: #6b7280;
        }
        /* Removed .logo-upload-overlay and its related styles as per the new requested format */

        /* Hide spinner arrows for number input fields within the table */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield; /* Firefox */
        }

        /* Custom styles for Task Name and Description fields to make them wider */
        .task-name-col {
            width: 18%; /* Allocate more width to Task Name */
        }
        .description-col {
            width: 25%; /* Allocate more width to Description */
        }
        /* Adjust other columns if necessary to fit */
        .labor-col, .materials-col, .other-col, .total-col, .actions-col {
             /* Example: Distribute remaining space, adjust as needed */
             /* Removed fixed widths to allow more flexibility */
        }

    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Main Application Interface -->
    <div id="mainApp" class="container hidden">
        <div class="card mb-6">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
                <div class="header-info-container">
                    <div class="header-icon-box">
                        <img id="mainAppLogo" class="header-logo-img" src="" alt="Contractor Logo" onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNmZmZmZmYiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSIxMCI+PC9jaXJjbGU+PHBhdGggZD0iTTE2LjIgNy44TDIwLjIgMTEuOE0zLjggMTIuMkw3LjggMTYuMiIvPjxwYXRoIGQ9Ik03LjggNy44TDExLjggMy44TDEyLjIgMy44TDE2LjIgNy44Ii8+PHBhdGggZD0iTTE2LjIgMTYuMkwxMi4yIDIwLjJMMTguOCAyMC4yTDcuOCAxNi4yIi8+PC9zdmc+'">
                        <!-- Default SVG if no logo or error -->
                    </div>
                    <div class="header-title-container">
                        <h1 class="header-title">Construction Estimate Calculator</h1>
                        <p class="header-subtitle" id="projectInfo">Commercial Construction Project</p>
                    </div>
                </div>
                <div class="header-buttons">
                    <button class="btn btn-primary" onclick="showSetup()">‚öôÔ∏è Reconfigure</button>
                    <button class="btn btn-green" onclick="generateReport()">üìÑ Generate Report</button>
                </div>
            </div>
        </div>

        <!-- NEW: Top-level summary boxes with Executive Summary -->
        <div class="top-summary-row mb-6">
            <div class="summary-overall-metric-card">
                <span class="label">Total Proposal</span>
                <span class="value" id="summaryTotalProposal">$0.00</span>
            </div>
            <div class="summary-overall-metric-card">
                <span class="label">Total Labor Hours</span>
                <span class="value" id="summaryOverallLaborHours">0</span>
            </div>
            <!-- Executive Summary (MOVED HERE) -->
            <div class="card summary-block">
                <h4>Executive Summary</h4>
                <div class="summary-item"><span>Total Project Cost:</span> <strong id="summaryProjectCost">$0.00</strong></div>
                <div class="summary-item"><span>Total Misc Cost:</span> <strong id="summaryMiscCost">$0.00</strong></div>
                <div class="summary-item"><span>Total Overhead:</span> <strong id="summaryOverhead">$0.00</strong></div>
                <div class="summary-item"><span>Total Markup:</span> <strong id="summaryMarkup">$0.00</strong></div>
                <div class="summary-item"><span>Estimate Subtotal:</span> <strong id="summaryEstimateSubtotal">$0.00</strong></div>
                <div class="summary-item"><span>Profit Margin (%):</span> <strong id="summaryProfitMargin">0.00%</strong></div>
                <div class="summary-item"><span>Sales Tax (%):</span> <strong id="summarySalesTax">0.00%</strong></div>
                <div class="summary-item"><span>Misc. (%):</span> <strong id="summaryMiscPercent">0.00%</strong></div>
                <div class="summary-item"><span>Additional Considerations:</span> <strong id="summaryAdditionalConsiderations">$0.00</strong></div>
            </div>
        </div>

        <!-- Executive Summary Grid (now 3 columns, but without Executive Summary card) -->
        <div class="executive-summary-section mb-6">
            <div class="executive-summary-grid-3col">
                <div class="card summary-block">
                    <h4>Labor Breakdown (Hours)</h4>
                    <div class="summary-item"><span>Project Manager:</span> <strong id="laborPMTotal">0.00</strong></div>
                    <div class="summary-item"><span>Superintendent:</span> <strong id="laborSuperintendentTotal">0.00</strong></div>
                    <div class="summary-item"><span>General Foreman:</span> <strong id="laborGeneralForemanTotal">0.00</strong></div>
                    <div class="summary-item"><span>Foreman:</span> <strong id="laborForemanTotal">0.00</strong></div>
                    <div class="summary-item"><span>Journeyman:</span> <strong id="laborJourneymanTotal">0.00</strong></div>
                    <div class="summary-item"><span>Apprentice:</span> <strong id="laborApprenticeTotal">0.00</strong></div>
                </div>

                <div class="card summary-block">
                    <h4>Project Cost Breakdown</h4>
                    <div class="summary-item"><span>Labor Total:</span> <strong id="breakdownLaborTotal">$0.00</strong></div>
                    <div class="summary-item"><span>Material Total:</span> <strong id="breakdownMaterialTotal">$0.00</strong></div>
                    <div class="summary-item"><span>Equipment Total:</span> <strong id="breakdownEquipmentTotal">$0.00</strong></div>
                    <div class="summary-item"><span>Sub-contractor Total:</span> <strong id="breakdownSubcontractorTotal">$0.00</strong></div>
                    <div class="summary-item"><span>Misc. Total (Line Items):</span> <strong id="breakdownMiscCost">0.00</strong></div>
                    <div class="summary-item total"><span>Total Other Costs:</span> <strong id="breakdownOtherTotal">$0.00</strong></div>
                </div>

                <!-- Pie Chart Container (MOVED HERE) -->
                <div class="chart-container card">
                    <h4 style="margin-top:0;">Labor vs. Material Cost Distribution</h4>
                    <canvas id="laborMaterialPieChart" class="chart-canvas"></canvas>
                </div>
            </div>
        </div>

        <div class="card overflow-x-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-semibold text-gray-800">Estimate Line Items</h3>
                <button class="btn btn-green" onclick="addItem()">‚ûï Add Item</button>
            </div>
            <table class="min-w-full">
                <thead>
                    <tr>
                        <th class="task-name-col">Task Name</th>
                        <th class="description-col">Description</th>
                        <th colspan="5" class="text-center labor-col">LABOR</th>
                        <th colspan="3" class="text-center materials-col">MATERIALS</th>
                        <th colspan="3" class="text-center other-col">OTHER</th>
                        <th class="total-col">TOTAL</th>
                        <th class="actions-col">Actions</th>
                    </tr>
                    <tr>
                        <!-- Placeholder for Task Name and Description columns in the second header row -->
                        <th></th>
                        <th></th>
                        <th>OT/DT</th>
                        <th>Skill</th>
                        <th>$/hr</th>
                        <th># hrs</th>
                        <th>Labor Total</th>
                        <th>QTY / UNIT</th>
                        <th>$ / UNIT</th>
                        <th>Materials Total</th>
                        <th>Equipment / Rental</th>
                        <th>Subcontractor</th>
                        <th>Misc.</th>
                        <!-- Note: 'Other Total' removed from this row as it's a sum at the next level -->
                        <th></th> <!-- Placeholder for TOTAL -->
                        <th></th> <!-- Placeholder for Actions -->
                    </tr>
                </thead>
                <tbody id="estimateTableBody">
                    </tbody>
            </table>
        </div>
    </div>

    <div id="setupWizard" class="setup-wizard">
        <div class="wizard-content">
            <div style="text-align: center; margin-bottom: 30px;">
                <!-- Logo Upload Area -->
                <input type="file" id="logoUploadInput" accept="image/*" style="display: none;">
                <div id="logoUploadArea" class="logo-upload-area"
                     ondragover="event.preventDefault(); this.classList.add('drag-over');"
                     ondragleave="this.classList.remove('drag-over');"
                     ondrop="handleLogoDrop(event); this.classList.remove('drag-over');"
                     onclick="document.getElementById('logoUploadInput').click();">
                    <img id="wizardLogoPreview" class="uploaded-logo hidden" src="" alt="Contractor Logo">
                    <span id="defaultLogoIcon" class="default-icon">üèóÔ∏è</span>
                    <p id="uploadText" class="upload-text">Drag & drop your logo here, or click to upload</p>
                </div>

                <h1>Project Setup</h1>
                <p style="color: #6b7280;">Let's configure your estimate for accuracy</p>
            </div>

            <div class="step-indicator">
                <div id="step1" class="step active">1</div>
                <div id="step2" class="step inactive">2</div>
                <div id="step3" class="step inactive">3</div>
            </div>

            <div id="wizardStep1">
                <h2 class="text-xl font-semibold mb-6">Project Information</h2>
                <div class="form-group">
                    <label for="projectName" class="label">Project Name:</label>
                    <input type="text" id="projectName" class="input-field" value="Commercial Construction Project" required>
                </div>
                <div class="form-group">
                    <label for="clientName" class="label">Client Name/Company:</label>
                    <input type="text" id="clientName" class="input-field" placeholder="e.g., Acme Corp." required>
                </div>
                <div class="form-group">
                    <label for="projectType" class="label">Project Type:</label>
                    <select id="projectType" class="input-field" required>
                        <option value="Commercial">Commercial</option>
                        <option value="Residential">Residential</option>
                        <option value="Industrial">Industrial</option>
                        <option value="Renovation">Renovation</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="projectState" class="label">State/Location:</label>
                    <select id="projectState" class="input-field" required>
                        <option value="CA">California</option>
                        <option value="TX">Texas</option>
                        <option value="NY">New York</option>
                        <option value="FL">Florida</option>
                        <option value="WA">Washington</option>
                        <option value="IL">Illinois</option>
                        <option value="AL">Alabama</option> <option value="AK">Alaska</option> <option value="AZ">Arizona</option> <option value="AR">Arkansas</option> <option value="CO">Colorado</option> <option value="CT">Connecticut</option> <option value="DE">Delaware</option> <option value="GA">Georgia</option> <option value="HI">Hawaii</option> <option value="ID">Idaho</option> <option value="IN">Indiana</option> <option value="IA">Iowa</option> <option value="KS">Kansas</option> <option value="KY">Kentucky</option> <option value="LA">Louisiana</option> <option value="ME">Maine</option> <option value="MD">Maryland</option> <option value="MA">Massachusetts</option> <option value="MI">Michigan</option> <option value="MN">Minnesota</option> <option value="MS">Mississippi</option> <option value="MO">Missouri</option> <option value="MT">Montana</option> <option value="NE">Nebraska</option> <option value="NV">Nevada</s option> <option value="NH">New Hampshire</option> <option value="NJ">New Jersey</option> <option value="NM">New Mexico</option> <option value="NC">North Carolina</option> <option value="ND">North Dakota</option> <option value="OH">Ohio</option> <option value="OK">Oklahoma</option> <option value="OR">Oregon</option> <option value="PA">Pennsylvania</option> <option value="RI">Rhode Island</option> <option value="SC">South Carolina</option> <option value="SD">South Dakota</option> <option value="TN">Tennessee</s option> <option value="UT">Utah</option> <option value="VT">Vermont</option> <option value="VA">Virginia</s option> <option value="WV">West Virginia</option> <option value="WI">Wisconsin</option> <option value="WY">Wyoming</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="tradesInvolved" class="label">Trades Involved (Select multiple):</label>
                    <div class="multi-select-container">
                        <input type="text" id="tradeSearchInput" class="input-field mb-2" placeholder="Search trades..." onfocus="showTradeDropdown()" onblur="hideTradeDropdown()">
                        <div id="selectedTradesDisplay" class="selected-trades-display" onclick="toggleTradeDropdown()">
                            Click to select trades...
                        </div>
                        <div id="tradesDropdown" class="multi-select-dropdown hidden">
                            <!-- Checkboxes will be populated here by JS -->
                        </div>
                    </div>
                </div>

                <!-- Advanced Details Section -->
                <div class="advanced-link-wrapper mt-6">
                    <a href="#" class="advanced-link" id="showAdvancedDetailsLink" onclick="toggleAdvancedDetails(event)">Show Advanced Details</a>
                </div>

                <div id="advancedDetailsSection" class="hidden mt-4 pt-4 border-t border-gray-200">
                    <h4 class="font-semibold text-lg mb-3">Additional Project Information</h4>
                    <div class="form-group">
                        <label for="projectAddress" class="label">Project Street Address:</label>
                        <input type="text" id="projectAddress" class="input-field" placeholder="e.g., 123 Main St.">
                    </div>
                    <div class="form-group">
                        <label for="projectCity" class="label">City:</label>
                        <input type="text" id="projectCity" class="input-field" placeholder="e.g., Anytown">
                    </div>
                    <div class="form-group">
                        <label for="projectZip" class="label">Zip Code:</label>
                        <input type="text" id="projectZip" class="input-field" placeholder="e.g., 90210">
                    </div>
                    <div class="form-group">
                        <label for="startDate" class="label">Start Date:</label>
                        <input type="date" id="startDate" class="input-field">
                    </div>
                    <div class="form-group">
                        <label for="endDate" class="label">End Date (Optional):</label>
                        <input type="date" id="endDate" class="input-field">
                    </div>
                    <div class="form-group">
                        <label for="projectID" class="label">Project ID/Number:</label>
                        <input type="text" id="projectID" class="input-field" placeholder="e.g., PROJ-001">
                    </div>
                     <div class="form-group">
                        <label for="projectDescription" class="label">Project Description/Scope Summary:</label>
                        <textarea id="projectDescription" class="input-field" rows="4" placeholder="Briefly describe the project scope..."></textarea>
                    </div>
                </div>


                <div class="flex justify-end gap-3 mt-8">
                    <button class="btn btn-primary" onclick="nextStep(1)">Next</button>
                </div>
            </div>

            <div id="wizardStep2" class="hidden">
                <h2 class="text-xl font-semibold mb-6">Labor Rates Configuration</h2>
                <p class="text-gray-600 mb-4">Enter the hourly rates for each skill level within the selected trades.</p>
                
                <!-- Container for dynamic labor rate inputs (now a simple list) -->
                <div id="dynamicLaborRateInputs" class="grid gap-4"> 
                    <!-- Dynamic labor rate items will be injected here -->
                </div>

                <!-- Advanced link at the bottom-left -->
                <div class="advanced-link-wrapper">
                    <a href="#" class="advanced-link" id="advancedLink" onclick="toggleAdvancedRates(event)">Show Advanced Options</a>
                </div>
                
                <!-- Advanced section for adding new skill levels - hidden by default -->
                <div id="advancedSkillLevelControls" class="hidden mt-6 pt-4 border-t border-gray-200">
                    <h4 class="font-semibold text-lg mb-3">Add Custom Skill Level</h4>
                    <div class="form-group">
                        <label for="newSkillTitle" class="label">New Skill Title:</label>
                        <input type="text" id="newSkillTitle" class="input-field" placeholder="e.g., Lead Journeyman">
                    </div>
                    <div class="form-group">
                        <label for="newSkillRate" class="label">New Skill Rate ($/hr):</label>
                        <input type="number" id="newSkillRate" class="input-field" value="0">
                    </div>
                    <button class="btn btn-primary w-full mt-2" onclick="addSkillLevelFromAdvanced()">Add Skill Level</button>
                </div>

                <div class="flex justify-between gap-3 mt-8">
                    <button class="btn btn-primary" onclick="prevStep(2)">Previous</button>
                    <button class="btn btn-primary" onclick="nextStep(2)">Next</button>
                </div>
            </div>

            <div id="wizardStep3" class="hidden">
                <h2 class="text-xl font-semibold mb-6">Project Settings</h2>

                <!-- Overhead -->
                <div class="form-group">
                    <label for="overhead" class="label">Overhead (%):</label>
                    <input type="number" id="overhead" class="input-field" value="0" step="0.01">
                </div>

                <!-- Desired Profit -->
                <div class="form-group">
                    <label for="profitMargin" class="label">Desired Profit (%):</label>
                    <input type="number" id="profitMargin" class="input-field" value="0" step="0.01">
                </div>

                <!-- Sales Tax -->
                <div class="form-group">
                    <label for="salesTax" class="label">Sales Tax (%):</label>
                    <input type="number" id="salesTax" class="input-field" value="0" step="0.01">
                </div>
                
                <div class="form-group">
                    <label for="miscellaneous" class="label">Miscellaneous (%):</label>
                    <input type="number" id="miscellaneous" class="input-field" value="0" step="0.01">
                </div>

                <!-- Additional Project Considerations with Toggle -->
                <div class="form-group">
                    <label class="label">Additional Project Considerations:</label>
                    <div class="flex items-center gap-3">
                        <input type="number" id="additionalConsiderationsValue" class="input-field flex-grow" value="0" step="0.01">
                        <span id="additionalConsiderationsUnit" class="font-semibold text-gray-600 w-10 text-center">%</span>
                        <button type="button" class="btn btn-primary btn-sm" onclick="toggleAdditionalConsiderationsType()">Toggle</button>
                    </div>
                </div>

                <div class="flex justify-between gap-3 mt-8">
                    <button class="btn btn-primary" onclick="prevStep(3)">Previous</button>
                    <button class="btn btn-green" onclick="startEstimating()">Start Estimating</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Helper function for currency formatting
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        // Helper function for hours formatting (2 decimal places)
        function formatHours(hours) {
            return parseFloat(hours).toFixed(2);
        }

        // Global variables for project settings
        let projectSettings = {
            projectName: "Commercial Construction Project",
            clientName: "",
            projectAddress: "",
            projectCity: "",
            projectZip: "",
            startDate: "",
            endDate: "",
            projectID: "",
            projectDescription: "",
            contractorLogo: "",
            projectType: "Commercial",
            projectState: "CA",
            profitMargin: 0,
            salesTax: 0,
            miscellaneous: 0,
            overhead: 0,
            additionalConsiderationsType: '%',
            additionalConsiderationsValue: 0,
            // Define labor rates nested by trade
            allTradeLaborRates: {
                "General": {
                    "Project Manager": 120,
                    "Superintendent": 100,
                    "General Foreman": 90,
                    "Foreman": 85,
                    "Journeyman": 75,
                    "Apprentice": 50
                },
                "Electrical": {
                    "Project Manager": 135,
                    "Superintendent": 110,
                    "General Foreman": 100,
                    "Foreman": 95,
                    "Journeyman": 80,
                    "Apprentice": 55
                },
                "Plumbing": {
                    "Project Manager": 125,
                    "Superintendent": 105,
                    "General Foreman": 95,
                    "Foreman": 90,
                    "Journeyman": 78,
                    "Apprentice": 52
                },
                "HVAC": {
                    "Project Manager": 130,
                    "Superintendent": 108,
                    "General Foreman": 98,
                    "Foreman": 92,
                    "Journeyman": 77,
                    "Apprentice": 53
                },
                "Carpentry": {
                    "Project Manager": 115,
                    "Superintendent": 95,
                    "General Foreman": 85,
                    "Foreman": 80,
                    "Journeyman": 70,
                    "Apprentice": 48
                },
                "Concrete": { "Project Manager": 110, "Superintendent": 90, "General Foreman": 80, "Foreman": 75, "Journeyman": 68, "Apprentice": 45 },
                "Roofing": { "Project Manager": 120, "Superintendent": 98, "General Foreman": 88, "Foreman": 83, "Journeyman": 73, "Apprentice": 47 },
                "Painting": { "Project Manager": 105, "Superintendent": 88, "General Foreman": 78, "Foreman": 73, "Journeyman": 65, "Apprentice": 42 },
                "Drywall": { "Project Manager": 112, "Superintendent": 92, "General Foreman": 82, "Foreman": 77, "Journeyman": 69, "Apprentice": 44 },
                "Masonry": { "Project Manager": 128, "Superintendent": 102, "General Foreman": 93, "Foreman": 88, "Journeyman": 76, "Apprentice": 51 },
                "Landscaping": { "Project Manager": 100, "Superintendent": 85, "General Foreman": 75, "Foreman": 70, "Journeyman": 60, "Apprentice": 40 }
            },
            activeTrades: ["General"],
            travelCost: 0,
            equipmentCost: 0,
            fixedCost: 0,
            subcontractorCost: 0,
            allowanceCost: 0
        };

        // Estimate data structure
        let estimateItems = [
            {
                id: Date.now() + 1,
                taskName: 'GENERAL REQUIREMENTS',
                description: 'Plans, specifications, engineering, permits, zoning, building, environmental, and survey',
                trade: 'General',
                rateRole: 'Journeyman',
                hours: 0,
                otDtMultiplier: 1.0,
                materialQuantity: 0,
                materialUnitCost: 0,
                equipmentRentalCost: 0,
                subcontractorCostLineItem: 0,
                miscLineItem: 0 // New field
            },
            {
                id: Date.now() + 2,
                taskName: 'Plans and Specifications',
                description: '',
                trade: 'General',
                rateRole: 'Journeyman',
                hours: 0,
                otDtMultiplier: 1.0,
                materialQuantity: 0,
                materialUnitCost: 0,
                equipmentRentalCost: 0,
                subcontractorCostLineItem: 0,
                miscLineItem: 0
            },
            {
                id: Date.now() + 3,
                taskName: 'Plan Review',
                description: '',
                trade: 'General',
                rateRole: 'Journeyman',
                hours: 0,
                otDtMultiplier: 1.0,
                materialQuantity: 0,
                materialUnitCost: 0,
                equipmentRentalCost: 0,
                subcontractorCostLineItem: 0,
                miscLineItem: 0
            },
            {
                id: Date.now() + 4,
                taskName: 'Permits: Zoning, Building, Environmental, Other',
                description: '',
                trade: 'General',
                rateRole: 'Journeyman',
                hours: 0,
                otDtMultiplier: 1.0,
                materialQuantity: 0,
                materialUnitCost: 0,
                equipmentRentalCost: 0,
                subcontractorCostLineItem: 0,
                miscLineItem: 0
            },
            {
                id: Date.now() + 5,
                taskName: 'Survey',
                description: '',
                trade: 'General',
                rateRole: 'Journeyman',
                hours: 0,
                otDtMultiplier: 1.0,
                materialQuantity: 0,
                materialUnitCost: 0,
                equipmentRentalCost: 0,
                subcontractorCostLineItem: 0,
                miscLineItem: 0
            },
            {
                id: Date.now() + 6,
                taskName: 'Impact Fee',
                description: '',
                trade: 'General',
                rateRole: 'Journeyman',
                hours: 0,
                otDtMultiplier: 1.0,
                materialQuantity: 0,
                materialUnitCost: 0,
                equipmentRentalCost: 0,
                subcontractorCostLineItem: 0,
                miscLineItem: 0
            },
            {
                id: Date.now() + 7,
                taskName: 'Administrative Costs',
                description: '',
                trade: 'General',
                rateRole: 'Journeyman',
                hours: 0,
                otDtMultiplier: 1.0,
                materialQuantity: 0,
                materialUnitCost: 0,
                equipmentRentalCost: 0,
                subcontractorCostLineItem: 0,
                miscLineItem: 0
            },
            {
                id: Date.now() + 8,
                taskName: 'Financing Costs',
                description: '',
                trade: 'General',
                rateRole: 'Journeyman',
                hours: 0,
                otDtMultiplier: 1.0,
                materialQuantity: 0,
                materialUnitCost: 0,
                equipmentRentalCost: 0,
                subcontractorCostLineItem: 0,
                miscLineItem: 0
            },
            {
                id: Date.now() + 9,
                taskName: 'Legal Fees',
                description: '',
                trade: 'General',
                rateRole: 'Journeyman',
                hours: 0,
                otDtMultiplier: 1.0,
                materialQuantity: 0,
                materialUnitCost: 0,
                equipmentRentalCost: 0,
                subcontractorCostLineItem: 0,
                miscLineItem: 0
            },
            {
                id: Date.now() + 10,
                taskName: 'Engineering Fees',
                description: '',
                trade: 'General',
                rateRole: 'Journeyman',
                hours: 0,
                otDtMultiplier: 1.0,
                materialQuantity: 0,
                materialUnitCost: 0,
                equipmentRentalCost: 0,
                subcontractorCostLineItem: 0,
                miscLineItem: 0
            },
            {
                id: Date.now() + 11,
                taskName: 'Insurance',
                description: '',
                trade: 'General',
                rateRole: 'Journeyman',
                hours: 0,
                otDtMultiplier: 1.0,
                materialQuantity: 0,
                materialUnitCost: 0,
                equipmentRentalCost: 0,
                subcontractorCostLineItem: 0,
                miscLineItem: 0
            }
        ];

        // UI Element references
        const setupWizard = document.getElementById('setupWizard');
        const mainApp = document.getElementById('mainApp');
        const wizardSteps = [
            document.getElementById('wizardStep1'),
            document.getElementById('wizardStep2'),
            document.getElementById('wizardStep3')
        ];
        const stepIndicators = [
            document.getElementById('step1'),
            document.getElementById('step2'),
            document.getElementById('step3')
        ];
        const estimateTableBody = document.getElementById('estimateTableBody');
        const dynamicLaborRateInputs = document.getElementById('dynamicLaborRateInputs');
        const advancedLink = document.getElementById('advancedLink');
        const advancedSkillLevelControls = document.getElementById('advancedSkillLevelControls');

        const showAdvancedDetailsLink = document.getElementById('showAdvancedDetailsLink');
        const advancedDetailsSection = document.getElementById('advancedDetailsSection');

        const tradeSearchInput = document.getElementById('tradeSearchInput');

        const logoUploadInput = document.getElementById('logoUploadInput');
        const logoUploadArea = document.getElementById('logoUploadArea');
        const wizardLogoPreview = document.getElementById('wizardLogoPreview');
        const defaultLogoIcon = document.getElementById('defaultLogoIcon');
        const uploadText = document.getElementById('uploadText');

        const mainAppLogo = document.getElementById('mainAppLogo');


        // State for advanced mode in Step 2
        let isAdvancedModeActive = false;

        // State for advanced details in Step 1
        let isAdvancedDetailsActive = false;

        // Top-level summary elements
        const summaryTotalProposalElem = document.getElementById('summaryTotalProposal');
        const summaryOverallLaborHoursElem = document.getElementById('summaryOverallLaborHours');

        // Executive Summary elements
        const summaryProjectCost = document.getElementById('summaryProjectCost');
        const summaryMiscCost = document.getElementById('summaryMiscCost');
        const summaryMarkup = document.getElementById('summaryMarkup');
        const summaryEstimateSubtotal = document.getElementById('summaryEstimateSubtotal');
        const summaryProfitMargin = document.getElementById('summaryProfitMargin');
        const summarySalesTax = document.getElementById('summarySalesTax');
        const summaryMiscPercent = document.getElementById('summaryMiscPercent');
        const summaryOverhead = document.getElementById('summaryOverhead');
        const summaryAdditionalConsiderations = document.getElementById('summaryAdditionalConsiderations');


        // Note: These now represent *hours* in the Labor Breakdown summary
        const laborPMTotal = document.getElementById('laborPMTotal');
        const laborSuperintendentTotal = document.getElementById('laborSuperintendentTotal');
        const laborGeneralForemanTotal = document.getElementById('laborGeneralForemanTotal');
        const laborForemanTotal = document.getElementById('laborForemanTotal');
        const laborJourneymanTotal = document.getElementById('laborJourneymanTotal');
        const laborApprenticeTotal = document.getElementById('laborApprenticeTotal');

        const breakdownLaborTotal = document.getElementById('breakdownLaborTotal');
        const breakdownMaterialTotal = document.getElementById('breakdownMaterialTotal');
        const breakdownTravelTotal = document.getElementById('breakdownTravelTotal');
        const breakdownEquipmentTotal = document.getElementById('breakdownEquipmentTotal');
        const breakdownFixedTotal = document.getElementById('breakdownFixedTotal');
        const breakdownSubcontractorTotal = document.getElementById('breakdownSubcontractorTotal');
        const breakdownAllowanceTotal = document.getElementById('breakdownAllowanceTotal');
        const breakdownOtherTotal = document.getElementById('breakdownOtherTotal');

        const projectInfoElem = document.getElementById('projectInfo');
        const laborMaterialPieChartCanvas = document.getElementById('laborMaterialPieChart');
        let laborMaterialPieChart;

        // Trade multi-select elements
        const tradesDropdown = document.getElementById('tradesDropdown');
        const selectedTradesDisplay = document.getElementById('selectedTradesDisplay');

        // Initial setup - show wizard
        document.addEventListener('DOMContentLoaded', () => {
            showSetup();
            updateSalesTaxForState(projectSettings.projectState); // Will set based on default CA, overriding the 0
            populateTradesDropdown();
            updateSelectedTradesDisplay();
            renderItems(); // Render the pre-filled items
        });

        // --- Logo Upload Logic ---
        logoUploadInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                handleFile(this.files[0]);
            }
        });

        function handleLogoDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');

            if (event.dataTransfer.files && event.dataTransfer.files[0]) {
                handleFile(event.dataTransfer.files[0]);
            }
        }

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                renderMessageBox('Please drop an image file (e.g., JPG, PNG, GIF).');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                projectSettings.contractorLogo = e.target.result;
                displayLogo(e.target.result);
            };
            reader.readAsDataURL(file);
        }

        function displayLogo(base64Image) {
            wizardLogoPreview.src = base64Image;
            wizardLogoPreview.classList.remove('hidden');
            defaultLogoIcon.classList.add('hidden');
            uploadText.classList.add('hidden');

            mainAppLogo.src = base64Image;
        }

        function loadSavedLogo() {
            if (projectSettings.contractorLogo) {
                displayLogo(projectSettings.contractorLogo);
            } else {
                wizardLogoPreview.classList.add('hidden');
                defaultLogoIcon.classList.remove('hidden');
                uploadText.classList.remove('hidden');
                mainAppLogo.src = '';
            }
        }


        // --- Wizard Navigation ---
        let currentStep = 1;

        function showStep(stepNumber) {
            wizardSteps.forEach((stepDiv, index) => {
                if (index + 1 === stepNumber) {
                    stepDiv.classList.remove('hidden');
                } else {
                    stepDiv.classList.add('hidden');
                }
            });
            stepIndicators.forEach((indicator, index) => {
                if (index + 1 === stepNumber) {
                    indicator.classList.add('active');
                    indicator.classList.remove('inactive');
                } else {
                    indicator.classList.remove('active');
                    indicator.classList.add('inactive');
                }
            });
            currentStep = stepNumber;

            if (stepNumber === 1) {
                isAdvancedDetailsActive = false;
                showAdvancedDetailsLink.textContent = 'Show Advanced Details';
                advancedDetailsSection.classList.add('hidden');
                populateWizardInputs();
                loadSavedLogo();
            }
            if (stepNumber === 2) {
                isAdvancedModeActive = false;
                advancedLink.textContent = 'Show Advanced Options';
                advancedSkillLevelControls.classList.add('hidden');
                populateWizardStep2LaborRates();
            }
            if (stepNumber === 3) {
                populateWizardStep3Settings();
            }
        }

        function nextStep(stepNumber) {
            if (stepNumber === 1) {
                const projectName = document.getElementById('projectName').value.trim();
                const clientName = document.getElementById('clientName').value.trim();
                const projectType = document.getElementById('projectType').value.trim();
                const projectState = document.getElementById('projectState').value.trim();

                if (!projectName) { renderMessageBox("Please enter a Project Name."); return; }
                if (!clientName) { renderMessageBox("Please enter a Client Name/Company."); return; }
                if (!projectType) { renderMessageBox("Please select a Project Type."); return; }
                if (!projectState) { renderMessageBox("Please select a State/Location."); return; }
                if (projectSettings.activeTrades.length === 0) { renderMessageBox("Please select at least one Trade Involved."); return; }

                projectSettings.projectName = projectName;
                projectSettings.clientName = clientName;
                projectSettings.projectAddress = document.getElementById('projectAddress').value;
                projectSettings.projectCity = document.getElementById('projectCity').value;
                projectSettings.projectZip = document.getElementById('projectZip').value;
                projectSettings.startDate = document.getElementById('startDate').value;
                projectSettings.endDate = document.getElementById('endDate').value;
                projectSettings.projectID = document.getElementById('projectID').value;
                projectSettings.projectDescription = document.getElementById('projectDescription').value;
                projectSettings.projectType = projectType;
                projectSettings.projectState = projectState;
                updateSalesTaxForState(projectSettings.projectState);

            } else if (stepNumber === 2) {
                for (const trade of projectSettings.activeTrades) {
                    for (const role in projectSettings.allTradeLaborRates[trade]) {
                        const rate = projectSettings.allTradeLaborRates[trade][role];
                        if (isNaN(rate) || rate < 0) {
                            renderMessageBox(`Labor rate for "${role}" in "${trade}" is not valid (${rate}). Please ensure all rates are non-negative numbers.`);
                            return;
                        }
                    }
                }
            }
            showStep(stepNumber + 1);
        }

        function prevStep(stepNumber) {
            showStep(stepNumber - 1);
        }

        function showSetup() {
            setupWizard.classList.remove('hidden');
            mainApp.classList.add('hidden');
            showStep(1);
            populateTradesDropdown();
            updateSelectedTradesDisplay();
        }

        function startEstimating() {
            const projectName = document.getElementById('projectName').value.trim();
            const clientName = document.getElementById('clientName').value.trim();
            const projectType = document.getElementById('projectType').value.trim();
            const projectState = document.getElementById('projectState').value.trim();

            if (!projectName) { renderMessageBox("Please enter a Project Name."); return; }
            if (!clientName) { renderMessageBox("Please enter a Client Name/Company."); return; }
            if (!projectType) { renderMessageBox("Please select a Project Type."); return; }
            if (!projectState) { renderMessageBox("Please select a State/Location."); return; }
            if (projectSettings.activeTrades.length === 0) {
                renderMessageBox("Please select at least one trade involved in the project before starting the estimate.");
                return;
            }

            for (const trade of projectSettings.activeTrades) {
                if (!projectSettings.allTradeLaborRates[trade]) {
                    renderMessageBox(`Labor rates for trade "${trade}" are not defined. Please define them or deselect this trade.`);
                    return;
                }
                for (const role in projectSettings.allTradeLaborRates[trade]) {
                    const rate = projectSettings.allTradeLaborRates[trade][role];
                    if (isNaN(rate) || rate < 0) {
                        renderMessageBox(`Labor rate for "${role}" in "${trade}" is not valid (${rate}). Please ensure all rates are non-negative numbers.`);
                        return;
                    }
                }
            }

            projectSettings.projectName = document.getElementById('projectName').value;
            projectSettings.clientName = document.getElementById('clientName').value;
            projectSettings.projectAddress = document.getElementById('projectAddress').value;
            projectSettings.projectCity = document.getElementById('projectCity').value;
            projectSettings.projectZip = document.getElementById('projectZip').value;
            projectSettings.startDate = document.getElementById('startDate').value;
            projectSettings.endDate = document.getElementById('endDate').value;
            projectSettings.projectID = document.getElementById('projectID').value;
            projectSettings.projectDescription = document.getElementById('projectDescription').value;
            projectSettings.projectType = document.getElementById('projectType').value;
            projectSettings.projectState = document.getElementById('projectState').value;
            
            projectSettings.profitMargin = parseFloat(document.getElementById('profitMargin').value) || 0;
            projectSettings.salesTax = parseFloat(document.getElementById('salesTax').value) || 0;
            projectSettings.miscellaneous = parseFloat(document.getElementById('miscellaneous').value) || 0;
            projectSettings.overhead = parseFloat(document.getElementById('overhead').value) || 0;
            projectSettings.additionalConsiderationsValue = parseFloat(document.getElementById('additionalConsiderationsValue').value) || 0;

            setupWizard.classList.add('hidden');
            mainApp.classList.remove('hidden');

            projectInfoElem.textContent = `${projectSettings.projectType} - ${projectSettings.projectName} - ${projectSettings.projectState}`;

            if (estimateItems.length === 0) {
                // If somehow no initial items were added, add a default one
                addItem();
            } else {
                renderItems();
            }
        }

        // --- Data Management Functions ---

        function populateWizardInputs() {
            document.getElementById('projectName').value = projectSettings.projectName;
            document.getElementById('clientName').value = projectSettings.clientName;
            document.getElementById('projectType').value = projectSettings.projectType;
            document.getElementById('projectState').value = projectSettings.projectState;

            document.getElementById('projectAddress').value = projectSettings.projectAddress;
            document.getElementById('projectCity').value = projectSettings.projectCity;
            document.getElementById('projectZip').value = projectSettings.projectZip;
            document.getElementById('startDate').value = projectSettings.startDate;
            document.getElementById('endDate').value = projectSettings.endDate;
            document.getElementById('projectID').value = projectSettings.projectID;
            projectSettings.projectDescription = document.getElementById('projectDescription').value;

            if (isAdvancedDetailsActive) {
                advancedDetailsSection.classList.remove('hidden');
                showAdvancedDetailsLink.textContent = 'Hide Advanced Details';
            } else {
                advancedDetailsSection.classList.add('hidden');
                showAdvancedDetailsLink.textContent = 'Show Advanced Details';
            }
            populateWizardStep3Settings();
        }

        function populateWizardStep3Settings() {
            document.getElementById('profitMargin').value = projectSettings.profitMargin;
            document.getElementById('salesTax').value = projectSettings.salesTax;
            document.getElementById('miscellaneous').value = projectSettings.miscellaneous;
            document.getElementById('overhead').value = projectSettings.overhead;
            document.getElementById('additionalConsiderationsValue').value = projectSettings.additionalConsiderationsValue;
            document.getElementById('additionalConsiderationsUnit').textContent = projectSettings.additionalConsiderationsType;
        }


        const stateSalesTax = {
            'CA': 8.25, 'TX': 6.25, 'NY': 4.0, 'FL': 6.0, 'WA': 6.5, 'IL': 6.25,
            'AL': 4.0, 'AK': 0.0, 'AZ': 5.6, 'AR': 6.5, 'CO': 2.9, 'CT': 6.35, 'DE': 0.0,
            'GA': 4.0, 'HI': 4.0, 'ID': 6.0, 'IN': 7.0, 'IA': 6.0, 'KS': 6.5, 'KY': 6.0,
            'LA': 4.45, 'ME': 5.5, 'MD': 6.0, 'MA': 6.25, 'MI': 6.0, 'MN': 6.875, 'MS': 7.0,
            'MO': 4.225, 'MT': 0.0, 'NE': 5.5, 'NV': 6.85, 'NH': 0.0, 'NJ': 6.625, 'NM': 5.125,
            'NC': 4.75, 'ND': 5.0, 'OH': 5.75, 'OK': 4.5, 'OR': 0.0, 'PA': 6.0, 'RI': 7.0,
            'SC': 6.0, 'SD': 4.5, 'TN': 7.0, 'UT': 4.85, 'VT': 6.0, 'VA': 5.3, 'WV': 6.0,
            'WI': 5.0, 'WY': 4.0
        };

        function updateSalesTaxForState(stateCode) {
            const taxRate = stateSalesTax[stateCode] || 0;
            document.getElementById('salesTax').value = taxRate;
            projectSettings.salesTax = taxRate;
        }

        document.getElementById('projectState').addEventListener('change', (event) => {
            updateSalesTaxForState(event.target.value);
        });

        function toggleAdditionalConsiderationsType() {
            if (projectSettings.additionalConsiderationsType === '%') {
                projectSettings.additionalConsiderationsType = '$';
            } else {
                projectSettings.additionalConsiderationsType = '%';
            }
            document.getElementById('additionalConsiderationsUnit').textContent = projectSettings.additionalConsiderationsType;
        }


        function populateWizardStep2LaborRates() {
            dynamicLaborRateInputs.innerHTML = '';

            if (projectSettings.activeTrades.length === 0) {
                dynamicLaborRateInputs.innerHTML = `<p class="text-gray-600">Please select trades in Step 1 to configure their labor rates here.</p>`;
                return;
            }

            const defaultRoles = ["Project Manager", "Superintendent", "General Foreman", "Foreman", "Journeyman", "Apprentice"];

            projectSettings.activeTrades.forEach(trade => {
                const tradeGroupDiv = document.createElement('div');
                tradeGroupDiv.className = 'trade-labor-rates-group';
                tradeGroupDiv.innerHTML = `<h3>${trade} Labor Rates</h3>`;

                const rolesWithRates = Object.entries(projectSettings.allTradeLaborRates[trade] || {});

                rolesWithRates.sort(([, rateA], [, rateB]) => {
                    if (rateA !== rateB) {
                        return rateB - rateA;
                    }
                    const roleNameA = arguments[0][0];
                    const roleNameB = arguments[1][0];
                    return roleNameA.localeCompare(roleNameB);
                });

                let skillLevelsHtml = '';
                rolesWithRates.forEach(([role, rate]) => {
                    const rateInputId = `rate-${trade.replace(/\s/g, '')}-${role.replace(/\s/g, '')}`;
                    const skillNameElementId = `skillname-${trade.replace(/\s/g, '')}-${role.replace(/\s/g, '')}`;

                    skillLevelsHtml += `
                        <div class="skill-level-row">
                            ${isAdvancedModeActive ? `
                                <input type="text" id="${skillNameElementId}" class="skill-name-input editable" value="${role}"
                                    onchange="updateSkillTitle('${trade}', '${role}', this.value)">
                            ` : `
                                <span id="${skillNameElementId}" class="skill-name-display">${role}</span>
                            `}
                            <div class="rate-input-group">
                                <label for="${rateInputId}" class="rate-label">Rate ($/hr):</label>
                                <input type="number" id="${rateInputId}" class="input-field rate-input" value="${rate}"
                                    onchange="updateLaborRate('${trade}', '${role}', this.value)">
                                ${isAdvancedModeActive ? `
                                    <button class="remove-skill-btn" onclick="confirmRemoveSkillLevel('${trade}', '${role}')">
                                        &minus;
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                tradeGroupDiv.innerHTML += skillLevelsHtml;
                dynamicLaborRateInputs.appendChild(tradeGroupDiv);
            });
        }

        function updateLaborRate(trade, role, value) {
            const parsedValue = parseFloat(value);
            if (!isNaN(parsedValue) && parsedValue >= 0) {
                projectSettings.allTradeLaborRates[trade][role] = parsedValue;
                populateWizardStep2LaborRates();
            } else {
                console.error(`Invalid input for ${trade} ${role} rate: ${value}`);
                const inputId = `rate-${trade.replace(/\s/g, '')}-${role.replace(/\s/g, '')}`;
                document.getElementById(inputId).value = projectSettings.allTradeLaborRates[trade][role] || 0;
            }
        }

        function updateSkillTitle(trade, oldRole, newRole) {
            const trimmedNewRole = newRole.trim();
            console.log(`Attempting to update skill title for trade: ${trade}, oldRole: ${oldRole}, newRole: ${trimmedNewRole}`);

            if (trimmedNewRole === oldRole) {
                console.log('New role is same as old role. No update needed.');
                return;
            }
            if (!trimmedNewRole) {
                renderMessageBox("Skill level title cannot be empty. Reverting to original name.");
                document.getElementById(`skillname-${trade.replace(/\s/g, '')}-${oldRole.replace(/\s/g, '')}`).value = oldRole;
                return;
            }
            const existingRoles = Object.keys(projectSettings.allTradeLaborRates[trade]).map(r => r.toLowerCase());
            if (existingRoles.includes(trimmedNewRole.toLowerCase()) && trimmedNewRole.toLowerCase() !== oldRole.toLowerCase()) {
                renderMessageBox(`Skill level "${trimmedNewRole}" already exists for ${trade}. Please choose a different name.`);
                document.getElementById(`skillname-${trade.replace(/\s/g, '')}-${oldRole.replace(/\s/g, '')}`).value = oldRole;
                return;
            }

            if (projectSettings.allTradeLaborRates[trade] && projectSettings.allTradeLaborRates[trade][oldRole] !== undefined) {
                const rate = projectSettings.allTradeLaborRates[trade][oldRole];
                delete projectSettings.allTradeLaborRates[trade][oldRole];
                projectSettings.allTradeLaborRates[trade][trimmedNewRole] = rate;
                console.log(`Successfully updated skill title for trade: ${trade}, from ${oldRole} to ${trimmedNewRole}.`);

                estimateItems.forEach(item => {
                    if (item.trade === trade && item.rateRole === oldRole) {
                        item.rateRole = trimmedNewRole;
                    }
                });
                populateWizardStep2LaborRates();
                renderItems();
            } else {
                console.warn(`Could not find old role "${oldRole}" in trade "${trade}" for update.`);
            }
        }


        function toggleAdvancedRates(event) {
            event.preventDefault();
            isAdvancedModeActive = !isAdvancedModeActive;
            if (isAdvancedModeActive) {
                advancedLink.textContent = 'Hide Advanced Options';
                advancedSkillLevelControls.classList.remove('hidden');
            } else {
                advancedLink.textContent = 'Show Advanced Options';
                advancedSkillLevelControls.classList.add('hidden');
            }
            populateWizardStep2LaborRates();
        }

        function toggleAdvancedDetails(event) {
            event.preventDefault();
            isAdvancedDetailsActive = !isAdvancedDetailsActive;
            if (isAdvancedDetailsActive) {
                showAdvancedDetailsLink.textContent = 'Hide Advanced Details';
                advancedDetailsSection.classList.remove('hidden');
            } else {
                advancedDetailsSection.classList.add('hidden');
                showAdvancedDetailsLink.textContent = 'Show Advanced Details';
            }
        }


        function addSkillLevelFromAdvanced() {
            if (projectSettings.activeTrades.length === 0) {
                renderMessageBox("Please select at least one trade in Step 1 before adding new skill levels.");
                return;
            }
            
            const newSkillTitleInput = document.getElementById('newSkillTitle');
            const newSkillRateInput = document.getElementById('newSkillRate');

            const newTitle = newSkillTitleInput.value.trim();
            const newRate = parseFloat(newSkillRateInput.value);
            console.log(`Attempting to add new skill: ${newTitle} with rate ${newRate}`);

            if (!newTitle) {
                renderMessageBox("Please enter a title for the new skill level.");
                return;
            }
            if (isNaN(newRate) || newRate < 0) {
                renderMessageBox("Please enter a valid non-negative number for the new skill rate.");
                return;
            }

            let newSkillAdded = false;
            let alreadyExistsForSome = false;
            projectSettings.activeTrades.forEach(trade => {
                if (!projectSettings.allTradeLaborRates[trade]) {
                    projectSettings.allTradeLaborRates[trade] = {};
                }
                const existingRolesForTrade = Object.keys(projectSettings.allTradeLaborRates[trade]).map(r => r.toLowerCase());
                if (!existingRolesForTrade.includes(newTitle.toLowerCase())) {
                    projectSettings.allTradeLaborRates[trade][newTitle] = newRate;
                    newSkillAdded = true;
                    console.log(`Added skill "${newTitle}" to trade "${trade}".`);
                } else {
                    alreadyExistsForSome = true;
                    console.warn(`Skill level "${newTitle}" already exists for ${trade}, skipping.`);
                }
            });

            if (newSkillAdded) {
                newSkillTitleInput.value = '';
                newSkillRateInput.value = '0';
                populateWizardStep2LaborRates();
            } else if (alreadyExistsForSome) {
                renderMessageBox(`Skill level "${newTitle}" already exists for some or all selected trades. It was not added where it already existed.`);
            } else {
                 renderMessageBox(`Skill level "${newTitle}" already exists for all selected trades or no trades are selected.`);
            }
        }


        function confirmRemoveSkillLevel(trade, role) {
            console.log(`Confirming removal of skill: ${role} from trade: ${trade}`);
            renderMessageBox(`Are you sure you want to remove the skill level "${role}" from ${trade}? This will remove it from all line items using it.`,
                () => {
                    removeSkillLevel(trade, role);
                    closeMessageBox();
                },
                true
            );
        }

        function removeSkillLevel(trade, role) {
            console.log(`Attempting to remove skill: ${role} from trade: ${trade}`);
            const defaultRoles = ["Project Manager", "Superintendent", "General Foreman", "Foreman", "Journeyman", "Apprentice"];
            if (defaultRoles.includes(role)) {
                renderMessageBox(`"${role}" is a default skill level and cannot be removed.`);
                console.log(`Cannot remove default skill: ${role}`);
                return;
            }

            if (projectSettings.allTradeLaborRates[trade] && projectSettings.allTradeLaborRates[trade][role] !== undefined) {
                delete projectSettings.allTradeLaborRates[trade][role];
                console.log(`Successfully removed skill: ${role} from trade: ${trade}`);

                estimateItems.forEach(item => {
                    if (item.trade === trade && item.rateRole === role) {
                        const availableRoles = Object.keys(projectSettings.allTradeLaborRates[item.trade] || {});
                        item.rateRole = availableRoles.length > 0 ? availableRoles[0] : "Journeyman";
                        console.log(`Updated line item rate role from ${role} to ${item.rateRole}`);
                    }
                });

                populateWizardStep2LaborRates();
                renderItems();
            } else {
                console.warn(`Could not find skill "${role}" in trade "${trade}" for update.`);
            }
        }

        function renderMessageBox(message, onConfirmCallback = null, isConfirm = false) {
            const messageBoxOverlay = document.createElement('div');
            messageBoxOverlay.id = 'messageBoxOverlay';
            messageBoxOverlay.className = 'fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[1001] backdrop-filter backdrop-blur-sm';
            
            const messageBox = document.createElement('div');
            messageBox.className = 'bg-white rounded-xl p-8 shadow-2xl max-w-sm mx-auto text-center';
            
            let buttonsHtml = `<button class="btn btn-primary" onclick="closeMessageBox()">OK</button>`;
            if (isConfirm) {
                buttonsHtml = `
                    <button class="btn btn-red mr-3" id="confirmYesBtn">Yes</button>
                    <button class="btn btn-primary" onclick="closeMessageBox()">No</button>
                `;
            }

            messageBox.innerHTML = `
                <p class="text-lg font-semibold text-gray-800 mb-6">${message}</p>
                <div class="flex justify-center gap-3">
                    ${buttonsHtml}
                </div>
            `;
            messageBoxOverlay.appendChild(messageBox);
            document.body.appendChild(messageBoxOverlay);

            if (isConfirm && onConfirmCallback) {
                document.getElementById('confirmYesBtn').addEventListener('click', onConfirmCallback);
            }
        }

        function closeMessageBox() {
            const messageBoxOverlay = document.getElementById('messageBoxOverlay');
            if (messageBoxOverlay) {
                messageBoxOverlay.remove();
            }
        }

        function populateTradesDropdown() {
            tradesDropdown.innerHTML = '';
            const allTrades = Object.keys(projectSettings.allTradeLaborRates);

            const searchTerm = tradeSearchInput.value.toLowerCase();
            const filteredTrades = allTrades.filter(trade => 
                trade.toLowerCase().includes(searchTerm)
            );

            if (filteredTrades.length === 0 && searchTerm) {
                tradesDropdown.innerHTML = `<p class="text-gray-600 text-center py-4">No trades found matching "${searchTerm}"</p>`;
            } else if (filteredTrades.length === 0 && !searchTerm) {
                tradesDropdown.innerHTML = `<p class="text-gray-600 text-center py-4">No trades available.</p>`;
            } else {
                filteredTrades.forEach(trade => {
                    const checkboxId = `trade-${trade.replace(/\s/g, '-')}`;
                    const isChecked = projectSettings.activeTrades.includes(trade);

                    const label = document.createElement('label');
                    label.className = 'flex items-center';
                    label.innerHTML = `
                        <input type="checkbox" id="${checkboxId}" value="${trade}" ${isChecked ? 'checked' : ''} onchange="handleTradeSelection(this)">
                        <span>${trade}</span>
                    `;
                    tradesDropdown.appendChild(label);
                });
            }
        }

        function updateSelectedTradesDisplay() {
            selectedTradesDisplay.innerHTML = '';
            if (projectSettings.activeTrades.length === 0) {
                selectedTradesDisplay.textContent = 'Click to select trades...';
                return;
            }
            projectSettings.activeTrades.forEach(trade => {
                const span = document.createElement('span');
                span.className = 'selected-trade-tag';
                span.innerHTML = `${trade} <span class="remove-tag" data-trade="${trade}">&times;</span>`;
                selectedTradesDisplay.appendChild(span);
            });
        }


        function handleTradeSelection(checkbox) {
            const trade = checkbox.value;
            if (checkbox.checked) {
                if (!projectSettings.activeTrades.includes(trade)) {
                    projectSettings.activeTrades.push(trade);
                    if (!projectSettings.allTradeLaborRates[trade]) {
                        projectSettings.allTradeLaborRates[trade] = {
                            "Project Manager": 120, "Superintendent": 100, "General Foreman": 90,
                            "Foreman": 85, "Journeyman": 75, "Apprentice": 50
                        };
                    }
                }
            } else {
                projectSettings.activeTrades = projectSettings.activeTrades.filter(t => t !== trade);
                // Also remove line items associated with this trade
                estimateItems = estimateItems.filter(item => item.trade !== trade);
            }
            updateSelectedTradesDisplay();
            renderItems();
            populateWizardStep2LaborRates();
        }

        function toggleTradeDropdown() {
            tradesDropdown.classList.toggle('hidden');
            if (!tradesDropdown.classList.contains('hidden')) {
                tradeSearchInput.value = '';
                populateTradesDropdown();
            }
        }
        
        function hideTradeDropdown() {
            setTimeout(() => {
                if (!tradesDropdown.matches(':hover')) {
                    tradesDropdown.classList.add('hidden');
                }
            }, 100);
        }

        function showTradeDropdown() {
            tradesDropdown.classList.remove('hidden');
        }


        selectedTradesDisplay.addEventListener('click', (event) => {
            if (event.target.classList.contains('remove-tag')) {
                const tradeToRemove = event.target.dataset.trade;
                const checkboxId = `trade-${tradeToRemove.replace(/\s/g, '-')}`;
                const checkbox = document.getElementById(checkboxId);
                if (checkbox) {
                    checkbox.checked = false;
                    handleTradeSelection(checkbox);
                }
            }
        });

        tradeSearchInput.addEventListener('input', populateTradesDropdown);


        // --- Estimate Item Management ---

        function addItem() {
            const defaultTrade = projectSettings.activeTrades.length > 0 ? projectSettings.activeTrades[0] : "General";
            const defaultRole = projectSettings.allTradeLaborRates[defaultTrade] && Object.keys(projectSettings.allTradeLaborRates[defaultTrade]).length > 0 ? Object.keys(projectSettings.allTradeLaborRates[defaultTrade])[0] : "Journeyman";

            const newItem = {
                id: Date.now(),
                taskName: 'New Task',
                description: 'Description for new task',
                trade: defaultTrade,
                rateRole: defaultRole,
                hours: 0,
                otDtMultiplier: 1.0,
                materialQuantity: 0, // was materialUnits
                materialUnitCost: 0, // was materialPerUnit
                equipmentRentalCost: 0, // was equipmentTravel
                subcontractorCostLineItem: 0,
                miscLineItem: 0 // New field
            };
            estimateItems.push(newItem);
            renderItems();
        }

        function deleteItem(id) {
            estimateItems = estimateItems.filter(item => item.id !== id);
            renderItems();
        }

        function updateItem(id, field, value) {
            const item = estimateItems.find(item => item.id === id);
            if (item) {
                if (['hours', 'materialQuantity', 'materialUnitCost', 'equipmentRentalCost', 'subcontractorCostLineItem', 'miscLineItem', 'otDtMultiplier'].includes(field)) {
                    item[field] = parseFloat(value) || 0;
                } else {
                    item[field] = value;
                }
                renderItems();
            }
        }

        function renderItems() {
            estimateTableBody.innerHTML = '';
            let totalLaborHoursVal = 0;

            estimateItems.forEach(item => {
                // Ensure trade and role are valid, fallback if needed
                if (!projectSettings.activeTrades.includes(item.trade)) {
                    item.trade = projectSettings.activeTrades.length > 0 ? projectSettings.activeTrades[0] : "General";
                }
                if (!projectSettings.allTradeLaborRates[item.trade] || !projectSettings.allTradeLaborRates[item.trade][item.rateRole]) {
                     const availableRoles = Object.keys(projectSettings.allTradeLaborRates[item.trade] || {});
                     item.rateRole = availableRoles.length > 0 ? availableRoles[0] : "Journeyman";
                }

                const laborRate = projectSettings.allTradeLaborRates[item.trade]?.[item.rateRole] || 0;
                const effectiveLaborRate = laborRate * (item.otDtMultiplier || 1.0);
                const laborTotal = item.hours * effectiveLaborRate;
                const materialsTotal = item.materialQuantity * item.materialUnitCost;
                const otherCategoryTotal = item.equipmentRentalCost + item.subcontractorCostLineItem + item.miscLineItem;
                
                const lineTotal = laborTotal + materialsTotal + otherCategoryTotal;

                totalLaborHoursVal += item.hours;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="Task Name"><input type="text" value="${item.taskName}" onchange="updateItem(${item.id}, 'taskName', this.value)" class="input-field"></td>
                    <td data-label="Description"><input type="text" value="${item.description}" onchange="updateItem(${item.id}, 'description', this.value)" class="input-field"></td>
                    
                    <td data-label="OT/DT Multiplier">
                        <select onchange="updateItem(${item.id}, 'otDtMultiplier', this.value)" class="input-field">
                            <option value="1.0" ${item.otDtMultiplier === 1.0 ? 'selected' : ''}>1.0</option>
                            <option value="1.5" ${item.otDtMultiplier === 1.5 ? 'selected' : ''}>1.5</option>
                            <option value="2.0" ${item.otDtMultiplier === 2.0 ? 'selected' : ''}>2.0</option>
                        </select>
                    </td>
                    <td data-label="Skill">
                        <select onchange="updateItem(${item.id}, 'rateRole', this.value)" class="input-field">
                            ${(projectSettings.allTradeLaborRates[item.trade] ? Object.keys(projectSettings.allTradeLaborRates[item.trade]) : []).map(role => {
                                return `<option value="${role}" ${item.rateRole === role ? 'selected' : ''}>
                                            ${role}
                                        </option>`;
                            }).join('')}
                            ${!projectSettings.allTradeLaborRates[item.trade] || Object.keys(projectSettings.allTradeLaborRates[item.trade]).length === 0 ? '<option value="" selected>No Skills</option>' : ''}
                        </select>
                    </td>
                    <td data-label="$/hr">${formatCurrency(laborRate)}</td>
                    <td data-label="# hrs"><input type="number" value="${item.hours}" onchange="updateItem(${item.id}, 'hours', this.value)" class="input-field"></td>
                    <td data-label="Labor Total">${formatCurrency(laborTotal)}</td>
                    
                    <td data-label="Material Qty"><input type="number" value="${item.materialQuantity}" onchange="updateItem(${item.id}, 'materialQuantity', this.value)" class="input-field"></td>
                    <td data-label="Material $/Unit"><input type="number" value="${item.materialUnitCost}" onchange="updateItem(${item.id}, 'materialUnitCost', this.value)" class="input-field"></td>
                    <td data-label="Materials Total">${formatCurrency(materialsTotal)}</td>
                    
                    <td data-label="Equipment/Rental"><input type="number" value="${item.equipmentRentalCost}" onchange="updateItem(${item.id}, 'equipmentRentalCost', this.value)" class="input-field"></td>
                    <td data-label="Subcontractor"><input type="number" value="${item.subcontractorCostLineItem}" onchange="updateItem(${item.id}, 'subcontractorCostLineItem', this.value)" class="input-field"></td>
                    <td data-label="Misc. Cost"><input type="number" value="${item.miscLineItem}" onchange="updateItem(${item.id}, 'miscLineItem', this.value)" class="input-field"></td>
                    <td data-label="Other Total">${formatCurrency(otherCategoryTotal)}</td>
                    
                    <td data-label="Line Total" class="font-bold text-gray-900">${formatCurrency(lineTotal)}</td>
                    <td><button class="btn btn-red btn-sm" onclick="deleteItem(${item.id})">üóëÔ∏è</button></td>
                `;
                estimateTableBody.appendChild(row);
            });
            summaryOverallLaborHoursElem.textContent = totalLaborHoursVal.toFixed(2);
            calculateTotals();
        }

        // --- Calculations ---

        function calculateTotals() {
            let totalProjectSubtotal = 0;
            let totalLaborCost = 0;
            let totalMaterialCost = 0;
            let totalLineItemOtherCostsSum = 0;
            // Removed allowance totals from here as they are no longer in line items per new layout

            let laborBreakdown = {};
            let laborHoursBreakdown = {};

            const allPossibleRoles = new Set();
            Object.keys(projectSettings.allTradeLaborRates).forEach(trade => {
                if (projectSettings.allTradeLaborRates[trade]) {
                    Object.keys(projectSettings.allTradeLaborRates[trade]).forEach(role => allPossibleRoles.add(role));
                }
            });
            allPossibleRoles.forEach(role => {
                laborBreakdown[role] = 0;
                laborHoursBreakdown[role] = 0;
            });


            estimateItems.forEach(item => {
                const laborRate = projectSettings.allTradeLaborRates[item.trade]?.[item.rateRole] || 0;
                const effectiveLaborRate = laborRate * (item.otDtMultiplier || 1.0);
                const laborTotal = item.hours * effectiveLaborRate;
                const materialsTotal = item.materialQuantity * item.materialUnitCost;
                const otherCategoryTotal = item.equipmentRentalCost + item.subcontractorCostLineItem + item.miscLineItem;
                
                const lineTotalEstimate = laborTotal + materialsTotal + otherCategoryTotal;

                totalProjectSubtotal += lineTotalEstimate;
                totalLaborCost += laborTotal;
                totalMaterialCost += materialsTotal;
                totalLineItemOtherCostsSum += otherCategoryTotal;

                if (laborBreakdown[item.rateRole] !== undefined) {
                    laborBreakdown[item.rateRole] += laborTotal;
                    laborHoursBreakdown[item.rateRole] += item.hours;
                }
            });

            // Note: Global other costs (travel, equipment, fixed, subcontractor, allowance) are not explicitly
            // requested in the executive summary breakdown based on the new line item layout.
            // If these are still needed in the total calculation or executive summary, they should be added back
            // into projectSettings and referenced here. For now, we will assume line item level costs
            // are the primary input for project cost breakdown.
            const globalOtherCosts = projectSettings.travelCost + projectSettings.equipmentCost +
                                     projectSettings.fixedCost + projectSettings.subcontractorCost +
                                     projectSettings.allowanceCost;
            
            // The previous otherTotal was totalLineItemOtherCostsSum + globalOtherCosts.
            // With the new layout, we assume 'Other' is strictly from line items.
            // If global costs are still desired, they need to be defined outside line items.
            // For now, aligning with the new 'OTHER' section in the table.
            const breakdownTotalOtherCosts = totalLineItemOtherCostsSum; 


            const totalOverheadCost = totalProjectSubtotal * (projectSettings.overhead / 100);

            const totalMiscCostAmount = totalProjectSubtotal * (projectSettings.miscellaneous / 100); // This is project-level misc now
            const subtotalBeforeProfitTax = totalProjectSubtotal + totalMiscCostAmount + totalOverheadCost;

            const totalMarkupAmount = subtotalBeforeProfitTax * (projectSettings.profitMargin / 100);
            const estimateSubtotalAmount = subtotalBeforeProfitTax + totalMarkupAmount;

            const salesTaxAmount = estimateSubtotalAmount * (projectSettings.salesTax / 100);
            
            let additionalConsiderationAmount = 0;
            if (projectSettings.additionalConsiderationsType === '%') {
                additionalConsiderationAmount = estimateSubtotalAmount * (projectSettings.additionalConsiderationsValue / 100);
            } else {
                additionalConsiderationAmount = projectSettings.additionalConsiderationsValue;
            }

            // Recalculating grandTotal based on new columns
            const grandTotal = estimateSubtotalAmount + salesTaxAmount + additionalConsiderationAmount;


            // Update Top-level Summary UI
            summaryTotalProposalElem.textContent = formatCurrency(grandTotal);
            summaryOverallLaborHoursElem.textContent = estimateItems.reduce((acc, item) => acc + item.hours, 0).toFixed(2);


            // Update Executive Summary UI (now in top row)
            summaryProjectCost.textContent = formatCurrency(totalProjectSubtotal);
            summaryMiscCost.textContent = formatCurrency(totalMiscCostAmount); // This is project-level misc now
            summaryOverhead.textContent = formatCurrency(totalOverheadCost);
            summaryMarkup.textContent = formatCurrency(totalMarkupAmount);
            summaryEstimateSubtotal.textContent = formatCurrency(estimateSubtotalAmount);
            summaryProfitMargin.textContent = `${projectSettings.profitMargin.toFixed(2)}%`;
            summarySalesTax.textContent = `${projectSettings.salesTax.toFixed(2)}%`;
            summaryMiscPercent.textContent = `${projectSettings.miscellaneous.toFixed(2)}%`;
            summaryAdditionalConsiderations.textContent = formatCurrency(additionalConsiderationAmount);

            // Update Labor Breakdown (middle card, now in second row)
            const defaultRoles = ["Project Manager", "Superintendent", "General Foreman", "Foreman", "Journeyman", "Apprentice"];
            const laborBreakdownContainer = document.querySelector('.executive-summary-grid-3col .summary-block:nth-child(1)'); // Adjusted selector
            let currentHtml = `<h4>Labor Breakdown (Hours)</h4>`;
                                
            defaultRoles.forEach(role => {
                currentHtml += `<div class="summary-item"><span>${role}:</span> <strong id="labor${role.replace(/\s/g, '')}Total">${formatHours(laborHoursBreakdown[role] || 0)}</strong></div>`;
            });
            Object.keys(laborHoursBreakdown).sort().forEach(role => {
                if (!defaultRoles.includes(role)) {
                    currentHtml += `<div class="summary-item"><span>${role}:</span> <strong>${formatHours(laborHoursBreakdown[role] || 0)}</strong></div>`;
                }
            });
            laborBreakdownContainer.innerHTML = currentHtml;


            // Update Project Cost Breakdown (right card, still in second row)
            breakdownLaborTotal.textContent = formatCurrency(totalLaborCost);
            breakdownMaterialTotal.textContent = formatCurrency(totalMaterialCost);
            
            // These used to be global, now assuming they come from line items or are removed for simplicity of this table
            breakdownTravelTotal.textContent = formatCurrency(0); // Travel was part of equipmentTravel before
            breakdownEquipmentTotal.textContent = formatCurrency(0); // Equipment was part of equipmentTravel before
            breakdownFixedTotal.textContent = formatCurrency(0); // Fixed cost removed from line item structure
            breakdownSubcontractorTotal.textContent = formatCurrency(0); // This is now a line item specific input
            breakdownAllowanceTotal.textContent = formatCurrency(0); // Allowances removed from line item structure
            breakdownOtherTotal.textContent = formatCurrency(breakdownTotalOtherCosts); // This is sum of line item other costs

            // To make Project Cost Breakdown accurate based on new line item structure,
            // we should sum respective values across all estimateItems.
            const totalEquipmentRentalCost = estimateItems.reduce((acc, item) => acc + item.equipmentRentalCost, 0);
            const totalSubcontractorLineItemCost = estimateItems.reduce((acc, item) => acc + item.subcontractorCostLineItem, 0);
            const totalMiscLineItemCost = estimateItems.reduce((acc, item) => acc + item.miscLineItem, 0);

            // Added for clarity, as previous code had a 'Travel Total' and 'Fixed Total'
            // For now, setting them to 0 as they aren't explicit line item fields in the new spec.
            // If the user wants them to sum certain 'other' fields, we'd need to adjust.
            breakdownTravelTotal.textContent = formatCurrency(0);
            breakdownFixedTotal.textContent = formatCurrency(0);
            breakdownEquipmentTotal.textContent = formatCurrency(totalEquipmentRentalCost);
            breakdownSubcontractorTotal.textContent = formatCurrency(totalSubcontractorLineItemCost);
            // This element doesn't exist, will need to be added to HTML for a separate display or combined into breakdownOtherTotal
            // breakdownMiscCost.textContent = formatCurrency(totalMiscLineItemCost);
            
            // Redoing other totals for project cost breakdown.
            breakdownOtherTotal.textContent = formatCurrency(totalEquipmentRentalCost + totalSubcontractorLineItemCost + totalMiscLineItemCost);


            // Render Pie Chart (now in second row)
            renderPieChart(totalLaborCost, totalMaterialCost);
        }

        // --- Pie Chart Rendering ---
        function renderPieChart(laborTotal, materialTotal) {
            if (laborMaterialPieChart) {
                laborMaterialPieChart.destroy();
            }

            const ctx = laborMaterialPieChartCanvas.getContext('2d');
            laborMaterialPieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Labor Cost', 'Material Cost'],
                    datasets: [{
                        data: [laborTotal, materialTotal],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(16, 185, 129, 0.8)'
                        ],
                        borderColor: [
                            'rgba(255, 255, 255, 1)',
                            'rgba(255, 255, 255, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += formatCurrency(context.parsed);
                                    }
                                    return label;
                                }
                            }
                        },
                        title: {
                            display: false,
                            text: 'Labor vs. Material Cost Distribution',
                            font: {
                                size: 16
                            },
                            color: '#1f2937'
                        }
                    }
                }
            });
        }

        // --- Report Generation ---

        function generateReport() {
            let totalProjectSubtotal = 0;
            let totalLaborCost = 0;
            let totalMaterialCost = 0;
            let totalLineItemOtherCostsSum = 0;
            // Removed allowance totals from report generation as they are no longer in line items per new layout

            let laborBreakdownReport = {};
            let laborHoursBreakdownReport = {};
            let totalLaborHoursReport = 0;

            const allPossibleRolesReport = new Set();
            Object.keys(projectSettings.allTradeLaborRates).forEach(trade => {
                if (projectSettings.allTradeLaborRates[trade]) {
                    Object.keys(projectSettings.allTradeLaborRates[trade]).forEach(role => allPossibleRolesReport.add(role));
                }
            });
            allPossibleRolesReport.forEach(role => {
                laborBreakdownReport[role] = 0;
                laborHoursBreakdownReport[role] = 0;
            });


            estimateItems.forEach((item) => {
                const laborRate = projectSettings.allTradeLaborRates[item.trade]?.[item.rateRole] || 0;
                const effectiveLaborRate = laborRate * (item.otDtMultiplier || 1.0);
                const laborTotal = item.hours * effectiveLaborRate;
                const materialsTotal = item.materialQuantity * item.materialUnitCost;
                const otherCategoryTotal = item.equipmentRentalCost + item.subcontractorCostLineItem + item.miscLineItem;

                const lineTotalEstimate = laborTotal + materialsTotal + otherCategoryTotal;

                totalProjectSubtotal += lineTotalEstimate;
                totalLaborCost += laborTotal;
                totalMaterialCost += materialsTotal;
                totalLineItemOtherCostsSum += otherCategoryTotal;
                totalLaborHoursReport += item.hours;

                if (laborBreakdownReport[item.rateRole] !== undefined) {
                    laborBreakdownReport[item.rateRole] += laborTotal;
                    laborHoursBreakdownReport[item.rateRole] += item.hours;
                }
            });

            // Re-evaluating global other costs for report based on removed line item columns
            const totalEquipmentRentalCostSum = estimateItems.reduce((acc, item) => acc + item.equipmentRentalCost, 0);
            const totalSubcontractorLineItemCostSum = estimateItems.reduce((acc, item) => acc + item.subcontractorCostLineItem, 0);
            const totalMiscLineItemCostSum = estimateItems.reduce((acc, item) => acc + item.miscLineItem, 0);

            const breakdownTotalOtherCosts = totalEquipmentRentalCostSum + totalSubcontractorLineItemCostSum + totalMiscLineItemCostSum;


            const totalOverheadCost = totalProjectSubtotal * (projectSettings.overhead / 100);

            const totalMiscCostAmount = totalProjectSubtotal * (projectSettings.miscellaneous / 100);
            const subtotalBeforeProfitTax = totalProjectSubtotal + totalMiscCostAmount + totalOverheadCost;
            const totalMarkupAmount = subtotalBeforeProfitTax * (projectSettings.profitMargin / 100);
            const estimateSubtotalAmount = subtotalBeforeProfitTax + totalMarkupAmount;

            const salesTaxAmount = estimateSubtotalAmount * (projectSettings.salesTax / 100);
            
            let additionalConsiderationAmount = 0;
            if (projectSettings.additionalConsiderationsType === '%') {
                additionalConsiderationAmount = estimateSubtotalAmount * (projectSettings.additionalConsiderationsValue / 100);
            } else {
                additionalConsiderationAmount = projectSettings.additionalConsiderationsValue;
            }

            const grandTotal = estimateSubtotalAmount + salesTaxAmount + additionalConsiderationAmount;


            let reportContent = `CONSTRUCTION ESTIMATE REPORT\n`;
            reportContent += `============================\n\n`;
            
            reportContent += `Project: ${projectSettings.projectName}\n`;
            reportContent += `Client: ${projectSettings.clientName || 'N/A'}\n`;
            reportContent += `Address: ${projectSettings.projectAddress || 'N/A'}\n`;
            reportContent += `City: ${projectSettings.projectCity || 'N/A'}\n`;
            reportContent += `Zip Code: ${projectSettings.projectZip || 'N/A'}\n`;
            reportContent += `State/Location: ${projectSettings.projectState}\n`;
            reportContent += `Start Date: ${projectSettings.startDate || 'N/A'}\n`;
            reportContent += `End Date: ${projectSettings.endDate || 'N/A'}\n`;
            reportContent += `Project ID: ${projectSettings.projectID || 'N/A'}\n`;
            reportContent += `Project Type: ${projectSettings.projectType}\n`;
            reportContent += `Description: ${projectSettings.projectDescription || 'No description provided.'}\n`;
            reportContent += `Date: ${new Date().toLocaleDateString()}\n\n`;

            reportContent += `OVERALL SUMMARY:\n`;
            reportContent += `-------------------------------------------------\n`;
            reportContent += `Total Proposal: ${formatCurrency(grandTotal)}\n`;
            reportContent += `Total Labor Hours: ${totalLaborHoursReport.toFixed(2)}\n\n`;


            reportContent += `EXECUTIVE SUMMARY DETAILS:\n`;
            reportContent += `-------------------------------------------------\n`;
            reportContent += `Total Project Cost (Line Items Base): ${formatCurrency(totalProjectSubtotal)}\n`;
            reportContent += `Total Miscellaneous Cost (${projectSettings.miscellaneous.toFixed(2)}%): ${formatCurrency(totalMiscCostAmount)}\n`;
            reportContent += `Total Overhead Cost (${projectSettings.overhead.toFixed(2)}%): ${formatCurrency(totalOverheadCost)}\n`;
            reportContent += `Total Markup (${projectSettings.profitMargin.toFixed(2)}%): ${formatCurrency(totalMarkupAmount)}\n`;
            reportContent += `Estimate Subtotal (before sales tax): ${formatCurrency(estimateSubtotalAmount)}\n`;
            reportContent += `Sales Tax (${projectSettings.salesTax.toFixed(2)}%): ${formatCurrency(salesTaxAmount)}\n`;
            reportContent += `Additional Considerations (${projectSettings.additionalConsiderationsValue.toFixed(2)}${projectSettings.additionalConsiderationsType}): ${formatCurrency(additionalConsiderationAmount)}\n\n`;


            reportContent += `LABOR BREAKDOWN (HOURS):\n`;
            reportContent += `-------------------------------------------------\n`;
            const defaultRolesReport = ["Project Manager", "Superintendent", "General Foreman", "Foreman", "Journeyman", "Apprentice"];
            defaultRolesReport.forEach(role => {
                reportContent += `${role}: ${formatHours(laborHoursBreakdownReport[role] || 0)}\n`;
            });
            Object.keys(laborHoursBreakdownReport).sort().forEach(role => {
                if (!defaultRolesReport.includes(role)) {
                    reportContent += `${role}: ${formatHours(laborHoursBreakdownReport[role])}\n`;
                }
            });
            reportContent += `\n`;

            reportContent += `PROJECT COST BREAKDOWN:\n`;
            reportContent += `-------------------------------------------------\n`;
            reportContent += `Labor Total: ${formatCurrency(totalLaborCost)}\n`;
            reportContent += `Material Total: ${formatCurrency(totalMaterialCost)}\n`;
            reportContent += `Equipment/Rental Total: ${formatCurrency(totalEquipmentRentalCostSum)}\n`;
            reportContent += `Sub-contractor Total: ${formatCurrency(totalSubcontractorLineItemCostSum)}\n`;
            reportContent += `Misc. Total (Line Items): ${formatCurrency(totalMiscLineItemCostSum)}\n`;
            reportContent += `Total Other Costs (Aggregated): ${formatCurrency(breakdownTotalOtherCosts)}\n\n`;


            reportContent += `ESTIMATE LINE ITEMS:\n`;
            reportContent += `====================\n`;

            estimateItems.forEach((item, index) => {
                const laborRate = projectSettings.allTradeLaborRates[item.trade]?.[item.rateRole] || 0;
                const effectiveLaborRate = laborRate * (item.otDtMultiplier || 1.0);
                const laborTotal = item.hours * effectiveLaborRate;
                const materialsTotal = item.materialQuantity * item.materialUnitCost;
                const otherCategoryTotal = item.equipmentRentalCost + item.subcontractorCostLineItem + item.miscLineItem;

                const lineTotal = laborTotal + materialsTotal + otherCategoryTotal;

                reportContent += `\nItem ${index + 1}: ${item.taskName || 'N/A'}\n`;
                reportContent += `  Description: ${item.description || 'No description'}\n`;
                reportContent += `  --- LABOR ---\n`;
                reportContent += `    OT/DT Multiplier: ${item.otDtMultiplier.toFixed(1)}\n`;
                reportContent += `    Skill: ${item.rateRole} (${formatCurrency(laborRate)}/hr)\n`;
                reportContent += `    # Hours: ${item.hours.toFixed(2)}\n`;
                reportContent += `    Labor Total: ${formatCurrency(laborTotal)}\n`;
                reportContent += `  --- MATERIALS ---\n`;
                reportContent += `    Quantity / Unit: ${item.materialQuantity}\n`;
                reportContent += `    $ / Unit: ${formatCurrency(item.materialUnitCost)}\n`;
                reportContent += `    Materials Total: ${formatCurrency(materialsTotal)}\n`;
                reportContent += `  --- OTHER ---\n`;
                reportContent += `    Equipment / Rental: ${formatCurrency(item.equipmentRentalCost)}\n`;
                reportContent += `    Subcontractor: ${formatCurrency(item.subcontractorCostLineItem)}\n`;
                reportContent += `    Misc. Cost: ${formatCurrency(item.miscLineItem)}\n`;
                reportContent += `    Other Total: ${formatCurrency(otherCategoryTotal)}\n`;
                reportContent += `  Line Item Total: ${formatCurrency(lineTotal)}\n`;
            });

            reportContent += `\nEnd of Report\n`;

            const blob = new Blob([reportContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${projectSettings.projectName.replace(/\s/g, '_')}_Estimate_Report.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
