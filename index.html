<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construction Estimate Calculator</title>
    <!-- Link to Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Link to Chart.js for the pie chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Base styles and UI improvements */
        body {
            margin: 0;
            font-family: 'Inter var', system-ui, -apple-system, sans-serif; /* Added Inter var for modern feel */
            background: linear-gradient(135deg, #e0f2fe 0%, #c1e0fa 100%); /* Lighter, softer blue gradient */
            min-height: 100vh;
            color: #374151; /* Default text color */
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .card {
            background: white;
            border-radius: 16px; /* Slightly more rounded */
            box-shadow: 0 6px 25px rgba(0,0,0,0.08); /* Softer, larger shadow */
            padding: 30px; /* More padding */
            margin-bottom: 25px;
        }
        .input-field {
            width: 100%;
            padding: 10px 14px; /* Larger padding */
            border: 1px solid #d1d5db; /* Softer border */
            border-radius: 8px; /* More rounded */
            font-size: 15px; /* Slightly larger font */
            transition: border-color 0.2s, box-shadow 0.2s;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.04); /* Subtle inner shadow */
        }
        .input-field:focus {
            outline: none;
            border-color: #60a5fa; /* Lighter blue focus */
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.3); /* Subtle blue glow */
        }
        .btn {
            padding: 12px 25px; /* More padding */
            border-radius: 10px; /* More rounded */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out; /* Smoother transition */
            border: none;
            font-size: 15px;
        }
        .btn-primary {
            background: #2563eb; /* Deeper blue (Tailwind blue-600) */
            color: white;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.2);
        }
        .btn-primary:hover {
            background: #1D4ED8; /* Even deeper blue (Tailwind blue-700) */
            box-shadow: 0 6px 20px rgba(29, 78, 216, 0.3);
            transform: translateY(-1px); /* Slight lift */
        }
        .btn-green {
            background: #10b981; /* Brighter green (Tailwind emerald-500) */
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2);
        }
        .btn-green:hover {
            background: #059669; /* Deeper green (Tailwind emerald-600) */
            box-shadow: 0 6px 20px rgba(5, 150, 105, 0.3);
            transform: translateY(-1px);
        }
        .btn-red {
            background: #ef4444; /* Brighter red (Tailwind red-500) */
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.2);
        }
        .btn-red:hover {
            background: #dc2626; /* Deeper red (Tailwind red-600) */
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.3);
            transform: translateY(-1px);
        }

        table {
            width: 100%;
            border-collapse: separate; /* Allows border-radius on cells */
            border-spacing: 0; /* Remove space between cells */
        }
        th, td {
            padding: 15px; /* More padding */
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        th {
            background: #f3f4f6; /* Softer header background */
            font-weight: 600;
            color: #4b5563;
            position: sticky; /* Sticky header for scrollable tables */
            top: 0;
            z-index: 1;
        }
        /* Rounded corners for table header */
        th:first-child { border-top-left-radius: 10px; }
        th:last-child { border-top-right-radius: 10px; }

        tr:nth-child(even) {
            background: #f8fafc; /* Subtle zebra striping */
        }
        tr:hover {
            background: #e0f2fe; /* Light blue on hover */
            transition: background 0.15s ease-in-out;
        }
        .setup-wizard {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6); /* Slightly darker overlay */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px); /* Subtle blur effect */
        }
        .wizard-content {
            background: white;
            border-radius: 20px; /* More rounded */
            padding: 45px; /* More padding */
            max-width: 650px; /* Slightly wider */
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); /* Stronger shadow */
        }
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 35px; /* More spacing */
        }
        .step {
            width: 45px; /* Larger step circles */
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 12px;
            font-weight: bold;
            font-size: 18px; /* Larger number */
            transition: background 0.3s, color 0.3s;
        }
        .step.active {
            background: #3b82f6;
            color: white;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
        }
        .step.inactive {
            background: #e5e7eb;
            color: #6b7280;
        }
        .form-group {
            margin-bottom: 25px; /* More spacing between form groups */
        }
        .label {
            display: block;
            margin-bottom: 8px; /* More space below label */
            font-weight: 600;
            color: #4b5563; /* Softer label color */
            font-size: 15px;
        }
        h1 {
            font-size: 32px;
            color: #1f2937;
            margin-bottom: 15px !important; /* Ensure consistent heading margin */
        }
        h2 {
            font-size: 26px;
            color: #1f2937;
            margin-bottom: 25px !important;
        }
        h3 {
            font-size: 22px;
            color: #1f2937;
            margin-bottom: 20px !important;
        }
        /* Specific styles for the project info header in main app */
        .header-info-container {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap; /* Allows wrapping on smaller screens */
        }
        .header-icon-box {
            background: #3b82f6;
            padding: 15px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .header-title-container {
            line-height: 1.3;
        }
        .header-title {
            margin: 0;
            color: #1f2937;
            font-size: 28px;
            font-weight: 700; /* Make title bolder */
        }
        .header-subtitle {
            margin: 5px 0 0 0;
            color: #6b7280;
            font-size: 16px;
        }
        /* Small adjustment for the action buttons in the header */
        .header-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px; /* Add margin for small screens */
        }

        /* NEW: Top Summary Row Styles (now 3 columns for Proposal, Hours, Chart) */
        .top-summary-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3 columns on large screens */
            gap: 20px;
            margin-bottom: 25px;
        }
        .summary-overall-metric-card {
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%); /* Deeper blue gradient for prominence */
            color: white;
            text-align: center;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(29, 78, 216, 0.3);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 150px; /* Ensure some height */
        }
        .summary-overall-metric-card .label {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: rgba(255,255,255,0.9);
        }
        .summary-overall-metric-card .value {
            font-size: 3rem; /* Larger font for main value */
            font-weight: 800;
            line-height: 1;
        }
         /* Pie Chart specific styles (now in top row, also a card) */
        .chart-container.card { /* Make it a card for consistent styling */
            padding: 20px; /* Adjust padding for visual balance */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 150px; /* Match height of other top cards if possible */
        }
        .chart-canvas {
            max-width: 100%; /* Make chart responsive */
            max-height: 200px; /* Adjust max height for top row display */
            height: auto;
            width: auto; /* Allow chart.js to manage width within limits */
        }
        .chart-container.card h4 { /* Style the title of the chart in the new layout */
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 10px;
            text-align: center;
        }


        /* Executive Summary Grid (now 3 columns) specific styles */
        .executive-summary-grid-3col { /* Renamed class for clarity */
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* Explicitly 3 columns on large screens */
            gap: 20px;
        }
        .executive-summary-grid-3col .card { /* Ensure cards within this grid don't have extra bottom margin */
            margin-bottom: 0;
        }
        .summary-block h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 10px;
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 0.95rem;
            color: #4b5563;
        }
        .summary-item strong {
            color: #1f2937;
        }
        .summary-item.total {
            font-weight: bold;
            font-size: 1.1rem;
            color: #0d47a1; /* Darker blue for totals */
            border-top: 1px dashed #cbd5e1;
            margin-top: 8px;
            padding-top: 8px;
        }


        /* Responsive adjustments */
        @media (max-width: 1024px) { /* Adjust grid for medium screens */
            .top-summary-row {
                grid-template-columns: repeat(2, 1fr); /* 2 columns on medium screens */
            }
            .executive-summary-grid-3col { /* Renamed class */
                grid-template-columns: repeat(2, 1fr); /* 2 columns on medium screens */
            }
        }

        @media (max-width: 768px) {
            .card, .wizard-content {
                padding: 20px;
                margin-bottom: 15px;
            }
            .btn {
                padding: 10px 20px;
                font-size: 14px;
            }
            .header-title {
                font-size: 24px;
            }
            .header-subtitle {
                font-size: 15px;
            }
            th, td {
                padding: 10px;
                font-size: 14px;
            }
            .summary-overall-metric-card {
                padding: 20px;
            }
            .summary-overall-metric-card .label {
                font-size: 1.2rem;
            }
            .summary-overall-metric-card .value {
                font-size: 2.5rem;
            }
            .top-summary-row, .executive-summary-grid-3col { /* Renamed class */
                grid-template-columns: 1fr; /* Stack columns on small screens */
            }
            .chart-container.card h4 {
                font-size: 1rem; /* Smaller title for chart on mobile */
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Main Application Interface -->
    <div id="mainApp" class="container hidden">
        <div class="card mb-6">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
                <div class="header-info-container">
                    <div class="header-icon-box">
                        <span style="color: white; font-size: 32px;">🏗️</span>
                    </div>
                    <div class="header-title-container">
                        <h1 class="header-title">Construction Estimate Calculator</h1>
                        <p class="header-subtitle" id="projectInfo">Commercial Construction Project</p>
                    </div>
                </div>
                <div class="header-buttons">
                    <button class="btn btn-primary" onclick="showSetup()">⚙️ Reconfigure</button>
                    <button class="btn btn-green" onclick="generateReport()">📄 Generate Report</button>
                </div>
            </div>
        </div>

        <!-- NEW: Top-level summary boxes with Pie Chart (3 columns) -->
        <div class="top-summary-row mb-6">
            <div class="summary-overall-metric-card">
                <span class="label">Total Proposal</span>
                <span class="value" id="summaryTotalProposal">$0.00</span>
            </div>
            <div class="summary-overall-metric-card">
                <span class="label">Total Labor Hours</span>
                <span class="value" id="summaryOverallLaborHours">0</span>
            </div>
            <!-- Pie Chart Container moved here -->
            <div class="chart-container card">
                <h4 style="margin-top:0;">Labor vs. Material Cost Distribution</h4>
                <canvas id="laborMaterialPieChart" class="chart-canvas"></canvas>
            </div>
        </div>

        <!-- Executive Summary Grid (now 3 columns) -->
        <div class="executive-summary-section mb-6">
            <div class="executive-summary-grid-3col"> <!-- Class name changed -->
                <div class="card summary-block">
                    <h4>Executive Summary</h4>
                    <div class="summary-item"><span>Total Project Cost:</span> <strong id="summaryProjectCost">$0.00</strong></div>
                    <div class="summary-item"><span>Total Misc Cost:</span> <strong id="summaryMiscCost">$0.00</strong></div>
                    <div class="summary-item"><span>Total Markup:</span> <strong id="summaryMarkup">$0.00</strong></div>
                    <div class="summary-item"><span>Estimate Subtotal:</span> <strong id="summaryEstimateSubtotal">$0.00</strong></div>
                    <div class="summary-item"><span>Profit Margin (%):</span> <strong id="summaryProfitMargin">15.00%</strong></div>
                    <div class="summary-item"><span>Sales Tax (%):</span> <strong id="summarySalesTax">8.25%</strong></div>
                    <div class="summary-item"><span>Misc. (%):</span> <strong id="summaryMiscPercent">5.00%</strong></div>
                </div>

                <div class="card summary-block">
                    <h4>Labor Breakdown</h4>
                    <div class="summary-item"><span>Project Manager:</span> <strong id="laborPMTotal">$0.00</strong></div>
                    <div class="summary-item"><span>Superintendent:</span> <strong id="laborSuperintendentTotal">$0.00</strong></div>
                    <div class="summary-item"><span>General Foreman:</span> <strong id="laborGeneralForemanTotal">$0.00</strong></div>
                    <div class="summary-item"><span>Foreman:</span> <strong id="laborForemanTotal">$0.00</strong></div>
                    <div class="summary-item"><span>Journeyman:</span> <strong id="laborJourneymanTotal">$0.00</strong></div>
                    <div class="summary-item"><span>Apprentice:</span> <strong id="laborApprenticeTotal">$0.00</strong></div>
                </div>

                <div class="card summary-block">
                    <h4>Project Cost Breakdown</h4>
                    <div class="summary-item"><span>Labor Total:</span> <strong id="breakdownLaborTotal">$0.00</strong></div>
                    <div class="summary-item"><span>Material Total:</span> <strong id="breakdownMaterialTotal">$0.00</strong></div>
                    <div class="summary-item"><span>Travel Total:</span> <strong id="breakdownTravelTotal">$0.00</strong></div>
                    <div class="summary-item"><span>Equipment Total:</span> <strong id="breakdownEquipmentTotal">$0.00</strong></div>
                    <div class="summary-item"><span>Fixed Total:</span> <strong id="breakdownFixedTotal">$0.00</strong></div>
                    <div class="summary-item"><span>Sub-contractor Total:</span> <strong id="breakdownSubcontractorTotal">$0.00</strong></div>
                    <div class="summary-item"><span>Allowance Total:</span> <strong id="breakdownAllowanceTotal">$0.00</strong></div>
                    <div class="summary-item total"><span>Total Other Costs:</span> <strong id="breakdownOtherTotal">$0.00</strong></div>
                </div>
            </div>
        </div>

        <div class="card overflow-x-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-semibold text-gray-800">Estimate Line Items</h3>
                <button class="btn btn-green" onclick="addItem()">➕ Add Item</button>
            </div>
            <table class="min-w-full">
                <thead>
                    <tr>
                        <th>Task Name</th>
                        <th>Description</th>
                        <th>Hours</th>
                        <th>Rate ($/hr)</th>
                        <th>OT/DT</th> <th>Labor Total</th>
                        <th>Materials</th>
                        <th>Other Costs</th>
                        <th>Line Total</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="estimateTableBody">
                    </tbody>
            </table>
        </div>
    </div>

    <div id="setupWizard" class="setup-wizard">
        <div class="wizard-content">
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="background: #3b82f6; width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;">
                    <span style="color: white; font-size: 36px;">🏗️</span>
                </div>
                <h1>Project Setup</h1>
                <p style="color: #6b7280;">Let's configure your estimate for accuracy</p>
            </div>

            <div class="step-indicator">
                <div id="step1" class="step active">1</div>
                <div id="step2" class="step inactive">2</div>
                <div id="step3" class="step inactive">3</div>
            </div>

            <div id="wizardStep1">
                <h2 class="text-xl font-semibold mb-6">Project Information</h2>
                <div class="form-group">
                    <label for="projectName" class="label">Project Name:</label>
                    <input type="text" id="projectName" class="input-field" value="Commercial Construction Project">
                </div>
                <div class="form-group">
                    <label for="projectType" class="label">Project Type:</label>
                    <select id="projectType" class="input-field">
                        <option value="Commercial">Commercial</option>
                        <option value="Residential">Residential</option>
                        <option value="Industrial">Industrial</option>
                        <option value="Renovation">Renovation</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="projectState" class="label">State/Location:</label>
                    <select id="projectState" class="input-field">
                        <option value="CA">California</option>
                        <option value="TX">Texas</option>
                        <option value="NY">New York</option>
                        <option value="FL">Florida</option>
                        <option value="WA">Washington</option>
                        <option value="IL">Illinois</option>
                        <option value="AL">Alabama</option> <option value="AK">Alaska</option> <option value="AZ">Arizona</option> <option value="AR">Arkansas</option> <option value="CO">Colorado</option> <option value="CT">Connecticut</option> <option value="DE">Delaware</option> <option value="GA">Georgia</option> <option value="HI">Hawaii</option> <option value="ID">Idaho</option> <option value="IN">Indiana</option> <option value="IA">Iowa</option> <option value="KS">Kansas</option> <option value="KY">Kentucky</option> <option value="LA">Louisiana</option> <option value="ME">Maine</option> <option value="MD">Maryland</option> <option value="MA">Massachusetts</option> <option value="MI">Michigan</option> <option value="MN">Minnesota</option> <option value="MS">Mississippi</option> <option value="MO">Missouri</option> <option value="MT">Montana</option> <option value="NE">Nebraska</option> <option value="NV">Nevada</option> <option value="NH">New Hampshire</option> <option value="NJ">New Jersey</option> <option value="NM">New Mexico</option> <option value="NC">North Carolina</option> <option value="ND">North Dakota</option> <option value="OH">Ohio</option> <option value="OK">Oklahoma</option> <option value="OR">Oregon</option> <option value="PA">Pennsylvania</option> <option value="RI">Rhode Island</option> <option value="SC">South Carolina</option> <option value="SD">South Dakota</option> <option value="TN">Tennessee</option> <option value="UT">Utah</option> <option value="VT">Vermont</option> <option value="VA">Virginia</option> <option value="WV">West Virginia</option> <option value="WI">Wisconsin</option> <option value="WY">Wyoming</option>
                    </select>
                </div>
                <div class="flex justify-end gap-3 mt-8">
                    <button class="btn btn-primary" onclick="nextStep(1)">Next</button>
                </div>
            </div>

            <div id="wizardStep2" class="hidden">
                <h2 class="text-xl font-semibold mb-6">Labor Rates Configuration</h2>
                <div class="form-group">
                    <label for="ratePM" class="label">Project Manager ($/hr):</label>
                    <input type="number" id="ratePM" class="input-field" value="120">
                </div>
                <div class="form-group">
                    <label for="rateSuperintendent" class="label">Superintendent ($/hr):</label>
                    <input type="number" id="rateSuperintendent" class="input-field" value="100">
                </div>
                <div class="form-group">
                    <label for="rateGeneralForeman" class="label">General Foreman ($/hr):</label>
                    <input type="number" id="rateGeneralForeman" class="input-field" value="90">
                </div>
                <div class="form-group">
                    <label for="rateForeman" class="label">Foreman ($/hr):</label>
                    <input type="number" id="rateForeman" class="input-field" value="85">
                </div>
                <div class="form-group">
                    <label for="rateJourneyman" class="label">Journeyman ($/hr):</label>
                    <input type="number" id="rateJourneyman" class="input-field" value="75">
                </div>
                <div class="form-group">
                    <label for="rateApprentice" class="label">Apprentice ($/hr):</label>
                    <input type="number" id="rateApprentice" class="input-field" value="50">
                </div>
                <div class="flex justify-between gap-3 mt-8">
                    <button class="btn btn-primary" onclick="prevStep(2)">Previous</button>
                    <button class="btn btn-primary" onclick="nextStep(2)">Next</button>
                </div>
            </div>

            <div id="wizardStep3" class="hidden">
                <h2 class="text-xl font-semibold mb-6">Project Settings</h2>
                <div class="form-group">
                    <label for="profitMargin" class="label">Profit Margin (%):</label>
                    <input type="number" id="profitMargin" class="input-field" value="15">
                </div>
                <div class="form-group">
                    <label for="salesTax" class="label">Sales Tax (%):</label>
                    <input type="number" id="salesTax" class="input-field" value="8.25" step="0.01">
                </div>
                <div class="form-group">
                    <label for="miscellaneous" class="label">Miscellaneous (%):</label>
                    <input type="number" id="miscellaneous" class="input-field" value="5">
                </div>
                <div class="flex justify-between gap-3 mt-8">
                    <button class="btn btn-primary" onclick="prevStep(3)">Previous</button>
                    <button class="btn btn-green" onclick="startEstimating()">Start Estimating</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Helper function for currency formatting
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        // Global variables for project settings
        let projectSettings = {
            projectName: "Commercial Construction Project",
            projectType: "Commercial",
            projectState: "CA",
            profitMargin: 15,
            salesTax: 8.25,
            miscellaneous: 5,
            laborRates: {
                "Project Manager": 120,
                "Superintendent": 100,
                "General Foreman": 90,
                "Foreman": 85,
                "Journeyman": 75,
                "Apprentice": 50
            },
            // New breakdown categories - kept as placeholders for now
            travelCost: 1000,
            equipmentCost: 2000,
            fixedCost: 500,
            subcontractorCost: 3000,
            allowanceCost: 1500
        };

        // Estimate data structure
        let estimateItems = [];

        // UI Element references
        const setupWizard = document.getElementById('setupWizard');
        const mainApp = document.getElementById('mainApp');
        const wizardSteps = [
            document.getElementById('wizardStep1'),
            document.getElementById('wizardStep2'),
            document.getElementById('wizardStep3')
        ];
        const stepIndicators = [
            document.getElementById('step1'),
            document.getElementById('step2'),
            document.getElementById('step3')
        ];
        const estimateTableBody = document.getElementById('estimateTableBody');

        // NEW: Top-level summary elements
        const summaryTotalProposalElem = document.getElementById('summaryTotalProposal');
        const summaryOverallLaborHoursElem = document.getElementById('summaryOverallLaborHours');

        // Executive Summary elements
        const summaryProjectCost = document.getElementById('summaryProjectCost');
        const summaryMiscCost = document.getElementById('summaryMiscCost');
        const summaryMarkup = document.getElementById('summaryMarkup');
        const summaryEstimateSubtotal = document.getElementById('summaryEstimateSubtotal');
        const summaryProfitMargin = document.getElementById('summaryProfitMargin');
        const summarySalesTax = document.getElementById('summarySalesTax');
        const summaryMiscPercent = document.getElementById('summaryMiscPercent');

        const laborPMTotal = document.getElementById('laborPMTotal');
        const laborSuperintendentTotal = document.getElementById('laborSuperintendentTotal');
        const laborGeneralForemanTotal = document.getElementById('laborGeneralForemanTotal');
        const laborForemanTotal = document.getElementById('laborForemanTotal');
        const laborJourneymanTotal = document.getElementById('laborJourneymanTotal');
        const laborApprenticeTotal = document.getElementById('laborApprenticeTotal');

        const breakdownLaborTotal = document.getElementById('breakdownLaborTotal');
        const breakdownMaterialTotal = document.getElementById('breakdownMaterialTotal');
        const breakdownTravelTotal = document.getElementById('breakdownTravelTotal');
        const breakdownEquipmentTotal = document.getElementById('breakdownEquipmentTotal');
        const breakdownFixedTotal = document.getElementById('breakdownFixedTotal');
        const breakdownSubcontractorTotal = document.getElementById('breakdownSubcontractorTotal');
        const breakdownAllowanceTotal = document.getElementById('breakdownAllowanceTotal');
        const breakdownOtherTotal = document.getElementById('breakdownOtherTotal'); // Sum of all other costs

        const projectInfoElem = document.getElementById('projectInfo');
        const laborMaterialPieChartCanvas = document.getElementById('laborMaterialPieChart');
        let laborMaterialPieChart; // To store the Chart.js instance

        // Initial setup - show wizard
        document.addEventListener('DOMContentLoaded', () => {
            showSetup();
            // Populate initial rates for the first time
            populateLaborRatesToUI();
            // Set initial state tax
            updateSalesTaxForState(projectSettings.projectState);
        });

        // --- Wizard Navigation ---
        let currentStep = 1;

        function showStep(stepNumber) {
            wizardSteps.forEach((stepDiv, index) => {
                if (index + 1 === stepNumber) {
                    stepDiv.classList.remove('hidden');
                } else {
                    stepDiv.classList.add('hidden');
                }
            });
            stepIndicators.forEach((indicator, index) => {
                if (index + 1 === stepNumber) {
                    indicator.classList.add('active');
                    indicator.classList.remove('inactive');
                } else {
                    indicator.classList.remove('active');
                    indicator.classList.add('inactive');
                }
            });
            currentStep = stepNumber;
        }

        function nextStep(stepNumber) {
            if (stepNumber === 1) {
                // Save Project Info
                projectSettings.projectName = document.getElementById('projectName').value;
                projectSettings.projectType = document.getElementById('projectType').value;
                projectSettings.projectState = document.getElementById('projectState').value;
                updateSalesTaxForState(projectSettings.projectState);
                populateLaborRatesToUI(); // Ensure step 2 fields are populated
            } else if (stepNumber === 2) {
                // Save Labor Rates
                saveLaborRatesFromUI();
            }
            showStep(stepNumber + 1);
        }

        function prevStep(stepNumber) {
            showStep(stepNumber - 1);
        }

        function showSetup() {
            setupWizard.classList.remove('hidden');
            mainApp.classList.add('hidden');
            showStep(1); // Always start from step 1 when reconfiguring
            populateWizardInputs(); // Load current settings into wizard inputs
        }

        function startEstimating() {
            // Save final settings from Wizard
            projectSettings.projectName = document.getElementById('projectName').value;
            projectSettings.projectType = document.getElementById('projectType').value;
            projectSettings.projectState = document.getElementById('projectState').value;
            saveLaborRatesFromUI();
            projectSettings.profitMargin = parseFloat(document.getElementById('profitMargin').value) || 0;
            projectSettings.salesTax = parseFloat(document.getElementById('salesTax').value) || 0;
            projectSettings.miscellaneous = parseFloat(document.getElementById('miscellaneous').value) || 0;

            // Hide wizard, show main app
            setupWizard.classList.add('hidden');
            mainApp.classList.remove('hidden');

            // Update project info in main app header
            projectInfoElem.textContent = `${projectSettings.projectType} - ${projectSettings.projectName} - ${projectSettings.projectState}`;

            // Initial render of items (if any exist) and calculate totals
            renderItems();
        }

        // --- Data Management Functions ---

        function populateWizardInputs() {
            document.getElementById('projectName').value = projectSettings.projectName;
            document.getElementById('projectType').value = projectSettings.projectType;
            document.getElementById('projectState').value = projectSettings.projectState;
            document.getElementById('profitMargin').value = projectSettings.profitMargin;
            document.getElementById('salesTax').value = projectSettings.salesTax;
            document.getElementById('miscellaneous').value = projectSettings.miscellaneous;
            populateLaborRatesToUI(); // Populate Step 2 inputs
        }

        function populateLaborRatesToUI() {
            for (const role in projectSettings.laborRates) {
                const inputId = 'rate' + role.replace(/\s/g, ''); // e.g., 'Project Manager' -> 'rateProjectManager'
                const inputElem = document.getElementById(inputId);
                if (inputElem) {
                    inputElem.value = projectSettings.laborRates[role];
                }
            }
        }

        function saveLaborRatesFromUI() {
            projectSettings.laborRates["Project Manager"] = parseFloat(document.getElementById('ratePM').value) || 0;
            projectSettings.laborRates["Superintendent"] = parseFloat(document.getElementById('rateSuperintendent').value) || 0;
            projectSettings.laborRates["General Foreman"] = parseFloat(document.getElementById('rateGeneralForeman').value) || 0;
            projectSettings.laborRates["Foreman"] = parseFloat(document.getElementById('rateForeman').value) || 0;
            projectSettings.laborRates["Journeyman"] = parseFloat(document.getElementById('rateJourneyman').value) || 0;
            projectSettings.laborRates["Apprentice"] = parseFloat(document.getElementById('rateApprentice').value) || 0;
        }

        const stateSalesTax = {
            'CA': 8.25, 'TX': 6.25, 'NY': 4.0, 'FL': 6.0, 'WA': 6.5, 'IL': 6.25,
            'AL': 4.0, 'AK': 0.0, 'AZ': 5.6, 'AR': 6.5, 'CO': 2.9, 'CT': 6.35, 'DE': 0.0,
            'GA': 4.0, 'HI': 4.0, 'ID': 6.0, 'IN': 7.0, 'IA': 6.0, 'KS': 6.5, 'KY': 6.0,
            'LA': 4.45, 'ME': 5.5, 'MD': 6.0, 'MA': 6.25, 'MI': 6.0, 'MN': 6.875, 'MS': 7.0,
            'MO': 4.225, 'MT': 0.0, 'NE': 5.5, 'NV': 6.85, 'NH': 0.0, 'NJ': 6.625, 'NM': 5.125,
            'NC': 4.75, 'ND': 5.0, 'OH': 5.75, 'OK': 4.5, 'OR': 0.0, 'PA': 6.0, 'RI': 7.0,
            'SC': 6.0, 'SD': 4.5, 'TN': 7.0, 'UT': 4.85, 'VT': 6.0, 'VA': 5.3, 'WV': 6.0,
            'WI': 5.0, 'WY': 4.0
        };

        function updateSalesTaxForState(stateCode) {
            const taxRate = stateSalesTax[stateCode] || 0; // Default to 0 if state not found
            document.getElementById('salesTax').value = taxRate;
            projectSettings.salesTax = taxRate; // Update project settings immediately
        }

        document.getElementById('projectState').addEventListener('change', (event) => {
            updateSalesTaxForState(event.target.value);
        });

        // --- Estimate Item Management ---

        function addItem() {
            const newItem = {
                id: Date.now(), // Unique ID for each item
                taskName: '',
                description: '',
                hours: 0,
                rateRole: 'Journeyman', // Default to Journeyman
                otDtMultiplier: 1.0, // New: OT/DT multiplier
                materials: 0,
                otherCosts: 0 // This will now represent a sum of the new categories if not specified globally
            };
            estimateItems.push(newItem);
            renderItems();
        }

        function deleteItem(id) {
            estimateItems = estimateItems.filter(item => item.id !== id);
            renderItems();
        }

        function updateItem(id, field, value) {
            const item = estimateItems.find(item => item.id === id);
            if (item) {
                if (['hours', 'materials', 'otherCosts'].includes(field)) {
                    item[field] = parseFloat(value) || 0;
                } else if (field === 'otDtMultiplier') {
                    item[field] = parseFloat(value) || 1.0; // Ensure multiplier is a number
                }
                else { // For text fields like taskName, description, rateRole
                    item[field] = value;
                }
                renderItems(); // Re-render to update calculations
            }
        }

        function renderItems() {
            estimateTableBody.innerHTML = ''; // Clear existing rows
            let totalLaborHoursVal = 0; // To accumulate total labor hours for the overall metric

            estimateItems.forEach(item => {
                const laborRate = projectSettings.laborRates[item.rateRole] || 0;
                const effectiveLaborRate = laborRate * (item.otDtMultiplier || 1.0); // Apply OT/DT multiplier
                const laborTotal = item.hours * effectiveLaborRate;
                const lineTotal = laborTotal + item.materials + item.otherCosts;

                totalLaborHoursVal += item.hours;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="text" value="${item.taskName}" onchange="updateItem(${item.id}, 'taskName', this.value)" class="input-field"></td>
                    <td><input type="text" value="${item.description}" onchange="updateItem(${item.id}, 'description', this.value)" class="input-field"></td>
                    <td><input type="number" value="${item.hours}" onchange="updateItem(${item.id}, 'hours', this.value)" class="input-field"></td>
                    <td>
                        <select onchange="updateItem(${item.id}, 'rateRole', this.value)" class="input-field">
                            ${Object.keys(projectSettings.laborRates).map(role => `
                                <option value="${role}" ${item.rateRole === role ? 'selected' : ''}>
                                    ${role} (${formatCurrency(projectSettings.laborRates[role])}/hr)
                                </option>
                            `).join('')}
                        </select>
                    </td>
                    <td>
                        <select onchange="updateItem(${item.id}, 'otDtMultiplier', this.value)" class="input-field">
                            <option value="1.0" ${item.otDtMultiplier === 1.0 ? 'selected' : ''}>1.0</option>
                            <option value="1.5" ${item.otDtMultiplier === 1.5 ? 'selected' : ''}>1.5</option>
                            <option value="2.0" ${item.otDtMultiplier === 2.0 ? 'selected' : ''}>2.0</option>
                        </select>
                    </td>
                    <td>${formatCurrency(laborTotal)}</td>
                    <td><input type="number" value="${item.materials}" onchange="updateItem(${item.id}, 'materials', this.value)" class="input-field"></td>
                    <td><input type="number" value="${item.otherCosts}" onchange="updateItem(${item.id}, 'otherCosts', this.value)" class="input-field"></td>
                    <td class="font-bold text-gray-900">${formatCurrency(lineTotal)}</td>
                    <td><button class="btn btn-red btn-sm" onclick="deleteItem(${item.id})">🗑️</button></td>
                `;
                estimateTableBody.appendChild(row);
            });
            summaryOverallLaborHoursElem.textContent = totalLaborHoursVal.toFixed(2); // Update overall labor hours
            calculateTotals(); // Recalculate and update executive summary
        }

        // --- Calculations ---

        function calculateTotals() {
            let totalProjectSubtotal = 0; // Sum of all line item totals
            let totalLaborCost = 0;
            let totalMaterialCost = 0;
            let totalLineItemOtherCosts = 0; // This aggregates the 'otherCosts' from line items
            let laborBreakdown = {}; // To store labor cost per role
            let totalHoursByRole = {}; // To store total hours per role

            // Initialize labor breakdown totals
            for (const role in projectSettings.laborRates) {
                laborBreakdown[role] = 0;
                totalHoursByRole[role] = 0;
            }

            estimateItems.forEach(item => {
                const laborRate = projectSettings.laborRates[item.rateRole] || 0;
                const effectiveLaborRate = laborRate * (item.otDtMultiplier || 1.0);
                const laborTotal = item.hours * effectiveLaborRate;
                const lineTotal = laborTotal + item.materials + item.otherCosts;

                totalProjectSubtotal += lineTotal;
                totalLaborCost += laborTotal;
                totalMaterialCost += item.materials;
                totalLineItemOtherCosts += item.otherCosts;

                laborBreakdown[item.rateRole] += laborTotal;
                totalHoursByRole[item.rateRole] += item.hours;
            });

            // Sum up the global cost categories from projectSettings
            const globalOtherCosts = projectSettings.travelCost + projectSettings.equipmentCost +
                                     projectSettings.fixedCost + projectSettings.subcontractorCost +
                                     projectSettings.allowanceCost;
            
            // Total other costs for breakdown includes both line item specific and global
            const breakdownTotalOtherCosts = totalLineItemOtherCosts + globalOtherCosts;


            // Calculate main totals based on the screenshot's flow
            const totalMiscCostAmount = totalProjectSubtotal * (projectSettings.miscellaneous / 100);
            const subtotalBeforeProfitTax = totalProjectSubtotal + totalMiscCostAmount; // "Project Cost" in summary + "Total Misc Cost"
            const totalMarkupAmount = subtotalBeforeProfitTax * (projectSettings.profitMargin / 100);
            const estimateSubtotalAmount = subtotalBeforeProfitTax + totalMarkupAmount; // "Estimate Subtotal" in summary

            const salesTaxAmount = estimateSubtotalAmount * (projectSettings.salesTax / 100);
            const grandTotal = estimateSubtotalAmount + salesTaxAmount; // "Total Proposal"


            // Update NEW Top-level Summary UI
            summaryTotalProposalElem.textContent = formatCurrency(grandTotal);
            summaryOverallLaborHoursElem.textContent = estimateItems.reduce((acc, item) => acc + item.hours, 0).toFixed(2);


            // Update Executive Summary UI (left card)
            summaryProjectCost.textContent = formatCurrency(totalProjectSubtotal);
            summaryMiscCost.textContent = formatCurrency(totalMiscCostAmount);
            summaryMarkup.textContent = formatCurrency(totalMarkupAmount);
            summaryEstimateSubtotal.textContent = formatCurrency(estimateSubtotalAmount);
            summaryProfitMargin.textContent = `${projectSettings.profitMargin.toFixed(2)}%`;
            summarySalesTax.textContent = `${projectSettings.salesTax.toFixed(2)}%`;
            summaryMiscPercent.textContent = `${projectSettings.miscellaneous.toFixed(2)}%`;

            // Update Labor Breakdown (middle card)
            laborPMTotal.textContent = formatCurrency(laborBreakdown["Project Manager"]);
            laborSuperintendentTotal.textContent = formatCurrency(laborBreakdown["Superintendent"]);
            laborGeneralForemanTotal.textContent = formatCurrency(laborBreakdown["General Foreman"]);
            laborForemanTotal.textContent = formatCurrency(laborBreakdown["Foreman"]);
            laborJourneymanTotal.textContent = formatCurrency(laborBreakdown["Journeyman"]);
            laborApprenticeTotal.textContent = formatCurrency(laborBreakdown["Apprentice"]);

            // Update Project Cost Breakdown (right card)
            breakdownLaborTotal.textContent = formatCurrency(totalLaborCost);
            breakdownMaterialTotal.textContent = formatCurrency(totalMaterialCost);
            breakdownTravelTotal.textContent = formatCurrency(projectSettings.travelCost);
            breakdownEquipmentTotal.textContent = formatCurrency(projectSettings.equipmentCost);
            breakdownFixedTotal.textContent = formatCurrency(projectSettings.fixedCost);
            breakdownSubcontractorTotal.textContent = formatCurrency(projectSettings.subcontractorCost);
            breakdownAllowanceTotal.textContent = formatCurrency(projectSettings.allowanceCost);
            breakdownOtherTotal.textContent = formatCurrency(breakdownTotalOtherCosts); // Updated sum including new global costs

            // Render Pie Chart
            renderPieChart(totalLaborCost, totalMaterialCost);
        }

        // --- Pie Chart Rendering ---
        function renderPieChart(laborTotal, materialTotal) {
            if (laborMaterialPieChart) {
                laborMaterialPieChart.destroy(); // Destroy previous chart instance if it exists
            }

            const ctx = laborMaterialPieChartCanvas.getContext('2d');
            laborMaterialPieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Labor Cost', 'Material Cost'],
                    datasets: [{
                        data: [laborTotal, materialTotal],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)', // Blue for Labor
                            'rgba(16, 185, 129, 0.8)'  // Green for Materials
                        ],
                        borderColor: [
                            'rgba(255, 255, 255, 1)',
                            'rgba(255, 255, 255, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Allow canvas to resize freely
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        // Use formatCurrency for tooltip values
                                        label += formatCurrency(context.parsed);
                                    }
                                    return label;
                                }
                            }
                        },
                        title: {
                            display: false, /* Moved title to H4 tag in HTML */
                            text: 'Labor vs. Material Cost Distribution',
                            font: {
                                size: 16
                            },
                            color: '#1f2937'
                        }
                    }
                }
            });
        }

        // --- Report Generation ---

        function generateReport() {
            let totalProjectSubtotal = 0;
            let totalLaborCost = 0;
            let totalMaterialCost = 0;
            let totalLineItemOtherCosts = 0;
            let laborBreakdownReport = {};
            let totalLaborHoursReport = 0;

            for (const role in projectSettings.laborRates) {
                laborBreakdownReport[role] = 0;
            }

            estimateItems.forEach((item) => {
                const laborRate = projectSettings.laborRates[item.rateRole] || 0;
                const effectiveLaborRate = laborRate * (item.otDtMultiplier || 1.0);
                const laborTotal = item.hours * effectiveLaborRate;
                const lineTotal = laborTotal + item.materials + item.otherCosts;

                totalProjectSubtotal += lineTotal;
                totalLaborCost += laborTotal;
                totalMaterialCost += item.materials;
                totalLineItemOtherCosts += item.otherCosts;
                totalLaborHoursReport += item.hours;

                laborBreakdownReport[item.rateRole] += laborTotal;
            });

            // Add global costs to totalOtherCostsAggregated for report
            const globalOtherCosts = projectSettings.travelCost + projectSettings.equipmentCost +
                                         projectSettings.fixedCost + projectSettings.subcontractorCost +
                                         projectSettings.allowanceCost;
            
            const breakdownTotalOtherCosts = totalLineItemOtherCosts + globalOtherCosts;


            const totalMiscCostAmount = totalProjectSubtotal * (projectSettings.miscellaneous / 100);
            const subtotalBeforeProfitTax = totalProjectSubtotal + totalMiscCostAmount;
            const totalMarkupAmount = subtotalBeforeProfitTax * (projectSettings.profitMargin / 100);
            const estimateSubtotalAmount = subtotalBeforeProfitTax + totalMarkupAmount;

            const salesTaxAmount = estimateSubtotalAmount * (projectSettings.salesTax / 100);
            const grandTotal = estimateSubtotalAmount + salesTaxAmount;

            let reportContent = `CONSTRUCTION ESTIMATE REPORT\n`;
            reportContent += `============================\n\n`;
            reportContent += `Project: ${projectSettings.projectName}\n`;
            reportContent += `Project Type: ${projectSettings.projectType}\n`;
            reportContent += `Location: ${projectSettings.projectState}\n`;
            reportContent += `Date: ${new Date().toLocaleDateString()}\n\n`;

            reportContent += `OVERALL SUMMARY:\n`;
            reportContent += `-------------------------------------------------\n`;
            reportContent += `Total Proposal: ${formatCurrency(grandTotal)}\n`;
            reportContent += `Total Labor Hours: ${totalLaborHoursReport.toFixed(2)}\n\n`;


            reportContent += `EXECUTIVE SUMMARY DETAILS:\n`;
            reportContent += `-------------------------------------------------\n`;
            reportContent += `Total Project Cost (Line Items Base): ${formatCurrency(totalProjectSubtotal)}\n`;
            reportContent += `Total Miscellaneous Cost (${projectSettings.miscellaneous.toFixed(2)}%): ${formatCurrency(totalMiscCostAmount)}\n`;
            reportContent += `Total Markup (${projectSettings.profitMargin.toFixed(2)}%): ${formatCurrency(totalMarkupAmount)}\n`;
            reportContent += `Estimate Subtotal (before sales tax): ${formatCurrency(estimateSubtotalAmount)}\n`;
            reportContent += `Sales Tax (${projectSettings.salesTax.toFixed(2)}%): ${formatCurrency(salesTaxAmount)}\n\n`;


            reportContent += `LABOR BREAKDOWN:\n`;
            reportContent += `-------------------------------------------------\n`;
            for (const role in laborBreakdownReport) {
                reportContent += `${role}: ${formatCurrency(laborBreakdownReport[role])}\n`;
            }
            reportContent += `\n`; // Add extra newline for readability

            reportContent += `PROJECT COST BREAKDOWN:\n`;
            reportContent += `-------------------------------------------------\n`;
            reportContent += `Labor Total: ${formatCurrency(totalLaborCost)}\n`;
            reportContent += `Material Total: ${formatCurrency(totalMaterialCost)}\n`;
            reportContent += `Travel Total: ${formatCurrency(projectSettings.travelCost)}\n`;
            reportContent += `Equipment Total: ${formatCurrency(projectSettings.equipmentCost)}\n`;
            reportContent += `Fixed Total: ${formatCurrency(projectSettings.fixedCost)}\n`;
            reportContent += `Sub-contractor Total: ${formatCurrency(projectSettings.subcontractorCost)}\n`;
            reportContent += `Allowance Total: ${formatCurrency(projectSettings.allowanceCost)}\n`;
            reportContent += `Total Other Costs (Aggregated): ${formatCurrency(breakdownTotalOtherCosts)}\n\n`;


            reportContent += `ESTIMATE LINE ITEMS:\n`;
            reportContent += `====================\n`;

            estimateItems.forEach((item, index) => {
                const laborRate = projectSettings.laborRates[item.rateRole] || 0;
                const effectiveLaborRate = laborRate * (item.otDtMultiplier || 1.0);
                const laborTotal = item.hours * effectiveLaborRate;
                const lineTotal = laborTotal + item.materials + item.otherCosts;

                reportContent += `\nItem ${index + 1}: ${item.taskName || 'N/A'}\n`;
                reportContent += `  Description: ${item.description || 'No description'}\n`;
                reportContent += `  Hours: ${item.hours.toFixed(2)}\n`;
                reportContent += `  Rate: ${item.rateRole} (${formatCurrency(laborRate)}/hr)\n`;
                reportContent += `  OT/DT Multiplier: ${item.otDtMultiplier.toFixed(1)}\n`;
                reportContent += `  Effective Labor Rate: ${formatCurrency(effectiveLaborRate)}/hr\n`;
                reportContent += `  Labor Cost: ${formatCurrency(laborTotal)}\n`;
                reportContent += `  Materials: ${formatCurrency(item.materials)}\n`;
                reportContent += `  Other Costs (Line Item Specific): ${formatCurrency(item.otherCosts)}\n`;
                reportContent += `  Line Total: ${formatCurrency(lineTotal)}\n`;
            });

            reportContent += `\nEnd of Report\n`;

            // Download report
            const blob = new Blob([reportContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${projectSettings.projectName.replace(/\s/g, '_')}_Estimate_Report.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
