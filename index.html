import React, { useState } from 'react';
import { Calculator, Plus, Trash2, Download, FileText, Settings } from 'lucide-react';

const ConstructionEstimateCalculator = () => {
  const [trades, setTrades] = useState({
    'Engineering Services': false,
    'Concrete & Structural Systems': false,
    'Electrical': false,
    'HVAC/Plumbing/Controls': false,
    'Fire Suppression & Life Safety': false,
    'Demolition': false,
    'Flooring': false,
    'Inspections/Services': false,
    'Building Envelope': false,
    'Interior Finishes': false,
    'Millwork & Casework': false,
    'Landscaping & Exterior Improvements': false,
    'Specialty Equipment': false,
    'Miscellaneous / Other': false
  });

  const [laborRates] = useState({
    'Project Manager': 150,
    'Superintendent': 100,
    'General Foreman': 95,
    'Foreman': 90,
    'Journeyman': 85,
    'Apprentice': 60,
    'Other': 0
  });

  const [estimateItems, setEstimateItems] = useState([
    {
      id: 1,
      taskName: 'GENERAL REQUIREMENTS',
      description: 'Project management and coordination',
      overtime: 1,
      skillLevel: 'Foreman',
      hourlyRate: 90,
      hours: 5,
      laborTotal: 450,
      materialQty: 0,
      materialRate: 0,
      materialTotal: 0,
      travel: 0,
      equipment: 0,
      fixed: 0,
      subcontractor: 0,
      otherTotal: 0,
      subtotal: 450,
      allowances: 0,
      markupPercent: 0,
      markupAmount: 0,
      estimatedTotal: 450,
      allowanceTotal: 0,
      total: 450
    }
  ]);

  const [projectSettings, setProjectSettings] = useState({
    projectName: 'Commercial Construction Project',
    profitMargin: 15,
    salesTax: 8.25,
    miscPercent: 5
  });

  const addEstimateItem = () => {
    const newId = Math.max(...estimateItems.map(item => item.id)) + 1;
    const newItem = {
      id: newId,
      taskName: '',
      description: '',
      overtime: 1,
      skillLevel: 'Journeyman',
      hourlyRate: 85,
      hours: 0,
      laborTotal: 0,
      materialQty: 0,
      materialRate: 0,
      materialTotal: 0,
      travel: 0,
      equipment: 0,
      fixed: 0,
      subcontractor: 0,
      otherTotal: 0,
      subtotal: 0,
      allowances: 0,
      markupPercent: 0,
      markupAmount: 0,
      estimatedTotal: 0,
      allowanceTotal: 0,
      total: 0
    };
    setEstimateItems([...estimateItems, newItem]);
  };

  const removeEstimateItem = (id) => {
    setEstimateItems(estimateItems.filter(item => item.id !== id));
  };

  const updateEstimateItem = (id, field, value) => {
    setEstimateItems(items => items.map(item => {
      if (item.id === id) {
        const updatedItem = { ...item, [field]: value };
        
        // Auto-update hourly rate when skill level changes
        if (field === 'skillLevel') {
          updatedItem.hourlyRate = laborRates[value] || 0;
        }
        
        // Recalculate totals
        const hours = parseFloat(updatedItem.hours) || 0;
        const hourlyRate = parseFloat(updatedItem.hourlyRate) || 0;
        const overtime = parseFloat(updatedItem.overtime) || 1;
        
        updatedItem.laborTotal = hours * hourlyRate * overtime;
        
        const materialQty = parseFloat(updatedItem.materialQty) || 0;
        const materialRate = parseFloat(updatedItem.materialRate) || 0;
        updatedItem.materialTotal = materialQty * materialRate;
        
        const travel = parseFloat(updatedItem.travel) || 0;
        const equipment = parseFloat(updatedItem.equipment) || 0;
        const fixed = parseFloat(updatedItem.fixed) || 0;
        const subcontractor = parseFloat(updatedItem.subcontractor) || 0;
        
        updatedItem.otherTotal = travel + equipment + fixed + subcontractor;
        updatedItem.subtotal = updatedItem.laborTotal + updatedItem.materialTotal + updatedItem.otherTotal;
        
        const markupPercent = parseFloat(updatedItem.markupPercent) || 0;
        updatedItem.markupAmount = updatedItem.subtotal * (markupPercent / 100);
        updatedItem.estimatedTotal = updatedItem.subtotal + updatedItem.markupAmount;
        
        const allowances = parseFloat(updatedItem.allowances) || 0;
        updatedItem.allowanceTotal = allowances;
        updatedItem.total = updatedItem.estimatedTotal + updatedItem.allowanceTotal;
        
        return updatedItem;
      }
      return item;
    }));
  };

  const calculateTotals = () => {
    const totalProjectCost = estimateItems.reduce((sum, item) => sum + item.total, 0);
    const totalMiscCost = totalProjectCost * (projectSettings.miscPercent / 100);
    const subtotalWithMisc = totalProjectCost + totalMiscCost;
    const profitAmount = subtotalWithMisc * (projectSettings.profitMargin / 100);
    const subtotalWithProfit = subtotalWithMisc + profitAmount;
    const salesTaxAmount = subtotalWithProfit * (projectSettings.salesTax / 100);
    const grandTotal = subtotalWithProfit + salesTaxAmount;
    
    return {
      totalProjectCost,
      totalMiscCost,
      totalMarkup: estimateItems.reduce((sum, item) => sum + item.markupAmount, 0),
      profitAmount,
      salesTaxAmount,
      grandTotal
    };
  };

  const totals = calculateTotals();

  const exportEstimate = () => {
    const estimate = {
      projectName: projectSettings.projectName,
      date: new Date().toLocaleDateString(),
      trades,
      items: estimateItems,
      settings: projectSettings,
      totals
    };
    
    const dataStr = JSON.stringify(estimate, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `estimate_${projectSettings.projectName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    URL.revokeObjectURL(url);
  };

  const generateReport = () => {
    const selectedTrades = Object.entries(trades)
      .filter(([trade, selected]) => selected)
      .map(([trade]) => trade);

    const reportData = `
CONSTRUCTION ESTIMATE REPORT
============================

Project: ${projectSettings.projectName}
Date: ${new Date().toLocaleDateString()}

TRADES/DISCIPLINES REQUIRED:
${selectedTrades.length > 0 ? selectedTrades.map(trade => `• ${trade}`).join('\n') : 'No trades selected'}

ESTIMATE LINE ITEMS:
${estimateItems.map(item => `
${item.taskName}
Description: ${item.description}
Labor: ${item.hours} hrs × $${item.hourlyRate}/hr × ${item.overtime} = $${item.laborTotal.toLocaleString()}
Materials: ${item.materialQty} × $${item.materialRate} = $${item.materialTotal.toLocaleString()}
Other Costs: $${item.otherTotal.toLocaleString()}
Markup (${item.markupPercent}%): $${item.markupAmount.toLocaleString()}
Total: $${item.total.toLocaleString()}
`).join('\n')}

FINANCIAL SUMMARY:
================
Project Subtotal: $${totals.totalProjectCost.toLocaleString()}
Miscellaneous (${projectSettings.miscPercent}%): $${totals.totalMiscCost.toLocaleString()}
Profit Margin (${projectSettings.profitMargin}%): $${totals.profitAmount.toLocaleString()}
Sales Tax (${projectSettings.salesTax}%): $${totals.salesTaxAmount.toLocaleString()}

GRAND TOTAL: $${totals.grandTotal.toLocaleString()}
    `.trim();

    const dataBlob = new Blob([reportData], { type: 'text/plain' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `estimate_report_${projectSettings.projectName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
    link.click();
    URL.revokeObjectURL(url);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 sm:p-6">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="bg-white rounded-xl shadow-xl p-6 mb-6 border border-gray-200">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <div className="flex items-center gap-3">
              <div className="bg-blue-600 p-3 rounded-lg">
                <Calculator className="text-white w-8 h-8" />
              </div>
              <div>
                <h1 className="text-2xl sm:text-3xl font-bold text-gray-900">
                  Construction Estimate Calculator
                </h1>
                <p className="text-gray-600 mt-1">
                  Professional estimation tool for contractors and builders
                </p>
              </div>
            </div>
            <div className="flex flex-col sm:flex-row gap-2">
              <button
                onClick={generateReport}
                className="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-all duration-200 shadow-lg hover:shadow-xl"
              >
                <FileText className="w-4 h-4" />
                Generate Report
              </button>
              <button
                onClick={exportEstimate}
                className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-all duration-200 shadow-lg hover:shadow-xl"
              >
                <Download className="w-4 h-4" />
                Export Data
              </button>
            </div>
          </div>
        </div>

        <div className="grid grid-cols-1 xl:grid-cols-4 gap-6">
          {/* Left Sidebar */}
          <div className="xl:col-span-1 space-y-6">
            {/* Trades Required */}
            <div className="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
              <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                <Settings className="w-5 h-5 text-blue-600" />
                Trades/Disciplines Required
              </h3>
              <div className="space-y-2 max-h-64 overflow-y-auto">
                {Object.entries(trades).map(([trade, selected]) => (
                  <label key={trade} className="flex items-start space-x-2 text-sm cursor-pointer hover:bg-gray-50 p-2 rounded-lg transition-colors">
                    <input
                      type="checkbox"
                      checked={selected}
                      onChange={(e) => setTrades({ ...trades, [trade]: e.target.checked })}
                      className="rounded mt-0.5 text-blue-600 focus:ring-blue-500"
                    />
                    <span className={`leading-tight ${selected ? 'text-blue-600 font-medium' : 'text-gray-700'}`}>
                      {trade}
                    </span>
                  </label>
                ))}
              </div>
            </div>

            {/* Executive Summary */}
            <div className="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
              <h3 className="text-lg font-semibold mb-4 text-gray-900">Executive Summary</h3>
              <div className="space-y-3">
                <div className="flex justify-between items-center py-2 border-b border-gray-100">
                  <span className="text-gray-600 text-sm">Total Project Cost:</span>
                  <span className="font-semibold text-gray-900">${totals.totalProjectCost.toLocaleString()}</span>
                </div>
                <div className="flex justify-between items-center py-2 border-b border-gray-100">
                  <span className="text-gray-600 text-sm">Total Misc Cost:</span>
                  <span className="font-semibold text-gray-900">${totals.totalMiscCost.toLocaleString()}</span>
                </div>
                <div className="flex justify-between items-center py-2 border-b border-gray-100">
                  <span className="text-gray-600 text-sm">Total Markup:</span>
                  <span className="font-semibold text-gray-900">${totals.totalMarkup.toLocaleString()}</span>
                </div>
                <div className="flex justify-between items-center py-2 border-b border-gray-100">
                  <span className="text-gray-600 text-sm">Profit ({projectSettings.profitMargin}%):</span>
                  <span className="font-semibold text-green-600">${totals.profitAmount.toLocaleString()}</span>
                </div>
                <div className="flex justify-between items-center py-2 border-b border-gray-100">
                  <span className="text-gray-600 text-sm">Sales Tax ({projectSettings.salesTax}%):</span>
                  <span className="font-semibold text-gray-900">${totals.salesTaxAmount.toLocaleString()}</span>
                </div>
                <div className="bg-blue-50 p-4 rounded-lg mt-4">
                  <div className="flex justify-between items-center">
                    <span className="font-semibold text-gray-900">Grand Total:</span>
                    <span className="text-xl font-bold text-blue-600">${totals.grandTotal.toLocaleString()}</span>
                  </div>
                </div>
              </div>
            </div>

            {/* Labor Breakdown */}
            <div className="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
              <h3 className="text-lg font-semibold mb-4 text-gray-900">Labor Breakdown</h3>
              <div className="space-y-2">
                {Object.entries(laborRates).map(([role, rate]) => (
                  <div key={role} className="flex justify-between text-sm py-1">
                    <span className="text-gray-600">{role}:</span>
                    <span className="font-medium text-gray-900">${rate}/hr</span>
                  </div>
                ))}
              </div>
            </div>

            {/* Project Settings */}
            <div className="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
              <h3 className="text-lg font-semibold mb-4 text-gray-900">Project Settings</h3>
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Project Name
                  </label>
                  <input
                    type="text"
                    value={projectSettings.projectName}
                    onChange={(e) => setProjectSettings({ ...projectSettings, projectName: e.target.value })}
                    className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Profit Margin (%)
                  </label>
                  <input
                    type="number"
                    step="0.1"
                    value={projectSettings.profitMargin}
                    onChange={(e) => setProjectSettings({ ...projectSettings, profitMargin: parseFloat(e.target.value) || 0 })}
                    className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Sales Tax (%)
                  </label>
                  <input
                    type="number"
                    step="0.01"
                    value={projectSettings.salesTax}
                    onChange={(e) => setProjectSettings({ ...projectSettings, salesTax: parseFloat(e.target.value) || 0 })}
                    className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Misc. (%)
                  </label>
                  <input
                    type="number"
                    step="0.1"
                    value={projectSettings.miscPercent}
                    onChange={(e) => setProjectSettings({ ...projectSettings, miscPercent: parseFloat(e.target.value) || 0 })}
                    className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>
              </div>
            </div>
          </div>

          {/* Main Content - Estimate Items */}
          <div className="xl:col-span-3">
            <div className="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
              <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 gap-4">
                <h3 className="text-xl font-semibold text-gray-900">Estimate Line Items</h3>
                <button
                  onClick={addEstimateItem}
                  className="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-all duration-200 shadow-lg hover:shadow-xl"
                >
                  <Plus className="w-4 h-4" />
                  Add Item
                </button>
              </div>

              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead>
                    <tr className="border-b-2 border-gray-200 bg-gray-50">
                      <th className="text-left p-3 font-semibold text-gray-700">Task Name</th>
                      <th className="text-left p-3 font-semibold text-gray-700">Description</th>
                      <th className="text-left p-3 font-semibold text-gray-700">OT/DT</th>
                      <th className="text-left p-3 font-semibold text-gray-700">Skill Level</th>
                      <th className="text-left p-3 font-semibold text-gray-700">$/HR</th>
                      <th className="text-left p-3 font-semibold text-gray-700">Hours</th>
                      <th className="text-left p-3 font-semibold text-gray-700">Labor Total</th>
                      <th className="text-left p-3 font-semibold text-gray-700">Material Qty</th>
                      <th className="text-left p-3 font-semibold text-gray-700">$/Unit</th>
                      <th className="text-left p-3 font-semibold text-gray-700">Material Total</th>
                      <th className="text-left p-3 font-semibold text-gray-700">Other Costs</th>
                      <th className="text-left p-3 font-semibold text-gray-700">Markup %</th>
                      <th className="text-left p-3 font-semibold text-gray-700">Total</th>
                      <th className="text-left p-3 font-semibold text-gray-700">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {estimateItems.map((item, index) => (
                      <tr key={item.id} className={`border-b border-gray-100 hover:bg-blue-50 transition-colors ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>
                        <td className="p-3">
                          <input
                            type="text"
                            value={item.taskName}
                            onChange={(e) => updateEstimateItem(item.id, 'taskName', e.target.value)}
                            className="w-full border border-gray-300 rounded-md px-2 py-1 text-sm focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                            placeholder="Task name"
                          />
                        </td>
                        <td className="p-3">
                          <input
                            type="text"
                            value={item.description}
                            onChange={(e) => updateEstimateItem(item.id, 'description', e.target.value)}
                            className="w-full border border-gray-300 rounded-md px-2 py-1 text-sm focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                            placeholder="Description"
                          />
                        </td>
                        <td className="p-3">
                          <input
                            type="number"
                            step="0.1"
                            value={item.overtime}
                            onChange={(e) => updateEstimateItem(item.id, 'overtime', e.target.value)}
                            className="w-16 border border-gray-300 rounded-md px-2 py-1 text-sm focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                          />
                        </td>
                        <td className="p-3">
                          <select
                            value={item.skillLevel}
                            onChange={(e) => updateEstimateItem(item.id, 'skillLevel', e.target.value)}
                            className="w-full border border-gray-300 rounded-md px-2 py-1 text-sm focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                          >
                            {Object.keys(laborRates).map(role => (
                              <option key={role} value={role}>{role}</option>
                            ))}
                          </select>
                        </td>
                        <td className="p-3">
                          <input
                            type="number"
                            value={item.hourlyRate}
                            onChange={(e) => updateEstimateItem(item.id, 'hourlyRate', e.target.value)}
                            className="w-20 border border-gray-300 rounded-md px-2 py-1 text-sm focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                          />
                        </td>
                        <td className="p-3">
                          <input
                            type="number"
                            step="0.1"
                            value={item.hours}
                            onChange={(e) => updateEstimateItem(item.id, 'hours', e.target.value)}
                            className="w-20 border border-gray-300 rounded-md px-2 py-1 text-sm focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                          />
                        </td>
                        <td className="p-3 font-semibold text-blue-600">
                          ${item.laborTotal.toLocaleString()}
                        </td>
                        <td className="p-3">
                          <input
                            type="number"
                            value={item.materialQty}
                            onChange={(e) => updateEstimateItem(item.id, 'materialQty', e.target.value)}
                            className="w-20 border border-gray-300 rounded-md px-2 py-1 text-sm focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                            placeholder="Qty"
                          />
                        </td>
                        <td className="p-3">
                          <input
                            type="number"
                            step="0.01"
                            value={item.materialRate}
                            onChange={(e) => updateEstimateItem(item.id, 'materialRate', e.target.value)}
                            className="w-20 border border-gray-300 rounded-md px-2 py-1 text-sm focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                            placeholder="Rate"
                          />
                        </td>
                        <td className="p-3 font-semibold text-green-600">
                          ${item.materialTotal.toLocaleString()}
                        </td>
                        <td className="p-3">
                          <div className="space-y-1">
                            <input
                              type="number"
                              value={item.travel}
                              onChange={(e) => updateEstimateItem(item.id, 'travel', e.target.value)}
                              className="w-16 border border-gray-300 rounded-md px-1 py-1 text-xs focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                              placeholder="Travel"
                            />
                            <input
                              type="number"
                              value={item.equipment}
                              onChange={(e) => updateEstimateItem(item.id, 'equipment', e.target.value)}
                              className="w-16 border border-gray-300 rounded-md px-1 py-1 text-xs focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                              placeholder="Equipment"
                            />
                            <input
                              type="number"
                              value={item.subcontractor}
                              onChange={(e) => updateEstimateItem(item.id, 'subcontractor', e.target.value)}
                              className="w-16 border border-gray-300 rounded-md px-1 py-1 text-xs focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                              placeholder="Sub"
                            />
                          </div>
                        </td>
                        <td className="p-3">
                          <input
                            type="number"
                            step="0.1"
                            value={item.markupPercent}
                            onChange={(e) => updateEstimateItem(item.id, 'markupPercent', e.target.value)}
                            className="w-16 border border-gray-300 rounded-md px-2 py-1 text-sm focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                            placeholder="%"
                          />
                        </td>
                        <td className="p-3 font-bold text-lg text-blue-600">
                          ${item.total.toLocaleString()}
                        </td>
                        <td className="p-3">
                          <button
                            onClick={() => removeEstimateItem(item.id)}
                            className="text-red-600 hover:text-red-800 hover:bg-red-50 p-2 rounded-lg transition-colors"
                            disabled={estimateItems.length === 1}
                            title="Remove item"
                          >
                            <Trash2 className="w-4 h-4" />
                          </button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              {/* Totals Summary */}
              <div className="mt-8 pt-6 border-t-2 border-gray-200">
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                  <div className="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-xl border border-blue-200">
                    <div className="text-sm text-blue-700 font-medium">Project Subtotal</div>
                    <div className="text-2xl font-bold text-blue-800 mt-1">
                      ${totals.totalProjectCost.toLocaleString()}
                    </div>
                  </div>
                  <div className="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-xl border border-green-200">
                    <div className="text-sm text-green-700 font-medium">Profit</div>
                    <div className="text-2xl font-bold text-green-800 mt-1">
                      ${totals.profitAmount.toLocaleString()}
                    </div>
                  </div>
                  <div className="bg-gradient-to-br from-yellow-50 to-yellow-100 p-6 rounded-xl border border-yellow-200">
                    <div className="text-sm text-yellow-700 font-medium">Sales Tax</div>
                    <div className="text-2xl font-bold text-yellow-800 mt-1">
                      ${totals.salesTaxAmount.toLocaleString()}
                    </div>
                  </div>
                  <div className="bg-gradient-to-br from-purple-50 to-purple-100 p-6 rounded-xl border border-purple-200">
                    <div className="text-sm text-purple-700 font-medium">Grand Total</div>
                    <div className="text-2xl font-bold text-purple-800 mt-1">
                      ${totals.grandTotal.toLocaleString()}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default ConstructionEstimateCalculator;
