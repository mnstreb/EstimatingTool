 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construction Estimate Calculator</title>
    <!-- Link to Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Link to Chart.js for the pie chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Base styles and UI improvements */
        body {
            margin: 0;
            font-family: 'Inter var', system-ui, -apple-system, sans-serif; /* Added Inter var for modern feel */
            background: linear-gradient(135deg, #e0f2fe 0%, #c1e0fa 100%); /* Lighter, softer blue gradient */
            min-height: 100vh;
            color: #374151; /* Default text color */
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .card {
            background: white;
            border-radius: 16px; /* Slightly more rounded */
            box-shadow: 0 6px 25px rgba(0,0,0,0.08); /* Softer, larger shadow */
            padding: 30px; /* More padding */
            margin-bottom: 25px;
        }
        .input-field {
            width: 100%;
            padding: 10px 14px; /* Larger padding */
            border: 1px solid #d1d5db; /* Softer border */
            border-radius: 8px; /* More rounded */
            font-size: 15px; /* Slightly larger font */
            transition: border-color 0.2s, box-shadow 0.2s;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.04); /* Subtle inner shadow */
        }
        .input-field:focus {
            outline: none;
            border-color: #60a5fa; /* Lighter blue focus */
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.3); /* Subtle blue glow */
        }
        .btn {
            padding: 12px 25px; /* More padding */
            border-radius: 10px; /* More rounded */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out; /* Smoother transition */
            border: none;
            font-size: 15px;
        }
        .btn-primary {
            background: #2563eb; /* Deeper blue (Tailwind blue-600) */
            color: white;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.2);
        }
        .btn-primary:hover {
            background: #1D4ED8; /* Even deeper blue (Tailwind blue-700) */
            box-shadow: 0 6px 20px rgba(29, 78, 216, 0.3);
            transform: translateY(-1px); /* Slight lift */
        }
        .btn-green {
            background: #10b981; /* Brighter green (Tailwind emerald-500) */
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2);
        }
        .btn-green:hover {
            background: #059669; /* Deeper green (Tailwind emerald-600) */
            box-shadow: 0 6px 20px rgba(5, 150, 105, 0.3);
            transform: translateY(-1px);
        }
        .btn-red {
            background: #ef4444; /* Brighter red (Tailwind red-500) */
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.2);
        }
        .btn-red:hover {
            background: #dc2626; /* Deeper red (Tailwind red-600) */
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.3);
            transform: translateY(-1px);
        }

        table {
            width: 100%;
            border-collapse: separate; /* Allows border-radius on cells */
            border-spacing: 0; /* Remove space between cells */
        }
        th, td {
            padding: 15px; /* More padding */
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        th {
            background: #f3f4f6; /* Softer header background */
            font-weight: 600;
            color: #4b5563;
            position: sticky; /* Sticky header for scrollable tables */
            top: 0;
            z-index: 1;
        }
        /* Rounded corners for table header */
        th:first-child { border-top-left-radius: 10px; }
        th:last-child { border-top-right-radius: 10px; } /* This might apply to the last TH of the whole table. Need to be mindful of multi-colspan headers. */

        tr:nth-child(even) {
            background: #f8fafc; /* Subtle zebra striping */
        }
        tr:hover {
            background: #e0f2fe; /* Light blue on hover */
            transition: background 0.15s ease-in-out;
        }
        .setup-wizard {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6); /* Slightly darker overlay */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px); /* Subtle blur effect */
        }
        .wizard-content {
            background: white;
            border-radius: 20px; /* More rounded */
            padding: 45px; /* More padding */
            max-width: 650px; /* Slightly wider */
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); /* Stronger shadow */
        }
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 35px; /* More spacing */
        }
        .step {
            width: 45px; /* Larger step circles */
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 12px;
            font-weight: bold;
            font-size: 18px; /* Larger number */
            transition: background 0.3s, color 0.3s;
        }
        .step.active {
            background: #3b82f6;
            color: white;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
        }
        .step.inactive {
            background: #e5e7eb;
            color: #6b7280;
        }
        .form-group {
            margin-bottom: 25px; /* More spacing between form groups */
        }
        .label {
            display: block;
            margin-bottom: 8px; /* More space below label */
            font-weight: 600;
            color: #4b5563; /* Softer label color */
            font-size: 15px;
        }
        h1 {
            font-size: 32px;
            color: #1f2937;
            margin-bottom: 15px !important; /* Ensure consistent heading margin */
        }
        h2 {
            font-size: 26px;
            color: #1f2937;
            margin-bottom: 25px !important;
        }
        h3 {
            font-size: 22px;
            color: #1f2937;
            margin-bottom: 20px !important;
        }
        /* Specific styles for the project info header in main app */
        .header-info-container {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap; /* Allows wrapping on smaller screens */
        }
        .header-icon-box {
            background: #3b82f6;
            padding: 15px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .header-title-container {
            line-height: 1.3;
        }
        .header-title {
            margin: 0;
            color: #1f2937;
            font-size: 28px;
            font-weight: 700; /* Make title bolder */
        }
        .header-subtitle {
            margin: 5px 0 0 0;
            color: #6b7280;
            font-size: 16px;
        }
        /* Small adjustment for the action buttons in the header */
        .header-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px; /* Add margin for small screens */
        }

        /* Top Summary Row Styles (3 columns: Proposal, Hours, Chart) */
        .top-summary-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3 columns on large screens */
            gap: 20px;
            margin-bottom: 25px;
        }
        .summary-overall-metric-card {
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%); /* Deeper blue gradient for prominence */
            color: white;
            text-align: center;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(29, 78, 216, 0.3);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 150px; /* Ensure some height */
        }
        .summary-overall-metric-card .label {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: rgba(255,255,255,0.9);
        }
        .summary-overall-metric-card .value {
            font-size: 3rem; /* Larger font for main value */
            font-weight: 800;
            line-height: 1;
        }
         /* Pie Chart specific styles (now in top row, also a card) */
        .chart-container.card { /* Make it a card for consistent styling */
            padding: 20px; /* Adjust padding for visual balance */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 150px; /* Match height of other top cards if possible */
        }
        .chart-canvas {
            max-width: 100%; /* Make chart responsive */
            max-height: 200px; /* Adjust max height for top row display */
            height: auto;
            width: auto; /* Allow chart.js to manage width within limits */
        }
        .chart-container.card h4 { /* Style the title of the chart in the new layout */
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 10px;
            text-align: center;
        }


        /* Executive Summary Grid (now 3 columns) specific styles */
        .executive-summary-grid-3col { /* Renamed class for clarity */
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* Explicitly 3 columns on large screens */
            gap: 20px;
        }
        .executive-summary-grid-3col .card { /* Ensure cards within this grid don't have extra bottom margin */
            margin-bottom: 0;
        }
        .summary-block h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 10px;
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 0.95rem;
            color: #4b5563;
        }
        .summary-item strong {
            color: #1f2937;
        }
        .summary-item.total {
            font-weight: bold;
            font-size: 1.1rem;
            color: #0d47a1; /* Darker blue for totals */
            border-top: 1px dashed #cbd5e1;
            margin-top: 8px;
            padding-top: 8px;
        }


        /* Responsive adjustments */
        @media (max-width: 1024px) { /* Adjust grid for medium screens */
            .top-summary-row {
                grid-template-columns: repeat(2, 1fr); /* 2 columns on medium screens */
            }
            .executive-summary-grid-3col { /* Renamed class */
                grid-template-columns: repeat(2, 1fr); /* 2 columns on medium screens */
            }
        }

        @media (max-width: 768px) {
            .card, .wizard-content {
                padding: 20px;
                margin-bottom: 15px;
            }
            .btn {
                padding: 10px 20px;
                font-size: 14px;
            }
            .header-title {
                font-size: 24px;
            }
            .header-subtitle {
                font-size: 15px;
            }
            th, td {
                padding: 10px;
                font-size: 14px;
            }
            .summary-overall-metric-card {
                padding: 20px;
            }
            .summary-overall-metric-card .label {
                font-size: 1.2rem;
            }
            .summary-overall-metric-card .value {
                font-size: 2.5rem;
            }
            .top-summary-row, .executive-summary-grid-3col { /* Renamed class */
                grid-template-columns: 1fr; /* Stack columns on small screens */
            }
            .chart-container.card h4 {
                font-size: 1rem; /* Smaller title for chart on mobile */
            }
        }

        /* Specific styles for multi-select dropdown */
        .multi-select-container {
            position: relative;
        }
        .multi-select-dropdown {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 8px;
            max-height: 150px;
            overflow-y: auto;
            background-color: white;
            position: absolute;
            width: 100%;
            z-index: 10;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .multi-select-dropdown label {
            display: block;
            padding: 6px 10px;
            cursor: pointer;
        }
        .multi-select-dropdown label:hover {
            background-color: #f3f4f6;
        }
        .multi-select-dropdown input[type="checkbox"] {
            margin-right: 8px;
        }
        .selected-trades-display {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            min-height: 40px;
            cursor: pointer;
            background-color: white;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }
        .selected-trade-tag {
            background-color: #e0f2fe; /* Light blue tag */
            color: #1e40af; /* Dark blue text */
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .selected-trade-tag .remove-tag {
            cursor: pointer;
            font-weight: bold;
            color: #94a3b8; /* Gray for X */
        }
        /* Styles for dynamic labor rate inputs in wizard */
        .trade-labor-rates-group {
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #fcfcfc;
        }
        .trade-labor-rates-group h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.25rem;
            color: #1f2937;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Main Application Interface -->
    <div id="mainApp" class="container hidden">
        <div class="card mb-6">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
                <div class="header-info-container">
                    <div class="header-icon-box">
                        <span style="color: white; font-size: 32px;">üèóÔ∏è</span>
                    </div>
                    <div class="header-title-container">
                        <h1 class="header-title">Construction Estimate Calculator</h1>
                        <p class="header-subtitle" id="projectInfo">Commercial Construction Project</p>
                    </div>
                </div>
                <div class="header-buttons">
                    <button class="btn btn-primary" onclick="showSetup()">‚öôÔ∏è Reconfigure</button>
                    <button class="btn btn-green" onclick="generateReport()">üìÑ Generate Report</button>
                </div>
            </div>
        </div>

        <!-- NEW: Top-level summary boxes with Pie Chart (3 columns) -->
        <div class="top-summary-row mb-6">
            <div class="summary-overall-metric-card">
                <span class="label">Total Proposal</span>
                <span class="value" id="summaryTotalProposal">$0.00</span>
            </div>
            <div class="summary-overall-metric-card">
                <span class="label">Total Labor Hours</span>
                <span class="value" id="summaryOverallLaborHours">0</span>
            </div>
            <!-- Pie Chart Container moved here -->
            <div class="chart-container card">
                <h4 style="margin-top:0;">Labor vs. Material Cost Distribution</h4>
                <canvas id="laborMaterialPieChart" class="chart-canvas"></canvas>
            </div>
        </div>

        <!-- Executive Summary Grid (now 3 columns) -->
        <div class="executive-summary-section mb-6">
            <div class="executive-summary-grid-3col"> <!-- Class name changed -->
                <div class="card summary-block">
                    <h4>Executive Summary</h4>
                    <div class="summary-item"><span>Total Project Cost:</span> <strong id="summaryProjectCost">$0.00</strong></div>
                    <div class="summary-item"><span>Total Misc Cost:</span> <strong id="summaryMiscCost">$0.00</strong></div>
                    <div class="summary-item"><span>Total Markup:</span> <strong id="summaryMarkup">$0.00</strong></div>
                    <div class="summary-item"><span>Estimate Subtotal:</span> <strong id="summaryEstimateSubtotal">$0.00</strong></div>
                    <div class="summary-item"><span>Profit Margin (%):</span> <strong id="summaryProfitMargin">15.00%</strong></div>
                    <div class="summary-item"><span>Sales Tax (%):</span> <strong id="summarySalesTax">8.25%</strong></div>
                    <div class="summary-item"><span>Misc. (%):</span> <strong id="summaryMiscPercent">5.00%</strong></div>
                </div>

                <div class="card summary-block">
                    <h4>Labor Breakdown</h4>
                    <div class="summary-item"><span>Project Manager:</span> <strong id="laborPMTotal">$0.00</strong></div>
                    <div class="summary-item"><span>Superintendent:</span> <strong id="laborSuperintendentTotal">$0.00</strong></div>
                    <div class="summary-item"><span>General Foreman:</span> <strong id="laborGeneralForemanTotal">$0.00</strong></div>
                    <div class="summary-item"><span>Foreman:</span> <strong id="laborForemanTotal">$0.00</strong></div>
                    <div class="summary-item"><span>Journeyman:</span> <strong id="laborJourneymanTotal">$0.00</strong></div>
                    <div class="summary-item"><span>Apprentice:</span> <strong id="laborApprenticeTotal">$0.00</strong></div>
                </div>

                <div class="card summary-block">
                    <h4>Project Cost Breakdown</h4>
                    <div class="summary-item"><span>Labor Total:</span> <strong id="breakdownLaborTotal">$0.00</strong></div>
                    <div class="summary-item"><span>Material Total:</span> <strong id="breakdownMaterialTotal">$0.00</strong></div>
                    <div class="summary-item"><span>Travel Total:</span> <strong id="breakdownTravelTotal">$0.00</strong></div>
                    <div class="summary-item"><span>Equipment Total:</span> <strong id="breakdownEquipmentTotal">$0.00</strong></div>
                    <div class="summary-item"><span>Fixed Total:</span> <strong id="breakdownFixedTotal">$0.00</strong></div>
                    <div class="summary-item"><span>Sub-contractor Total:</span> <strong id="breakdownSubcontractorTotal">$0.00</strong></div>
                    <div class="summary-item"><span>Allowance Total:</span> <strong id="breakdownAllowanceTotal">$0.00</strong></div>
                    <div class="summary-item total"><span>Total Other Costs:</span> <strong id="breakdownOtherTotal">$0.00</strong></div>
                </div>
            </div>
        </div>

        <div class="card overflow-x-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-semibold text-gray-800">Estimate Line Items</h3>
                <button class="btn btn-green" onclick="addItem()">‚ûï Add Item</button>
            </div>
            <table class="min-w-full">
                <thead>
                    <tr>
                        <th rowspan="2">Task Name</th>
                        <th rowspan="2">Description</th>
                        <th colspan="3" class="text-center">BURDENED LABOR</th> <!-- Reduced from 4 due to Rate being displayed, not input -->
                        <th colspan="2" class="text-center">MATERIALS</th>
                        <th colspan="4" class="text-center">OTHER</th>
                        <th colspan="2" class="text-center">UNDEFINED SCOPE</th>
                        <th colspan="2" class="text-center">MARKUP</th>
                        <th colspan="2" class="text-center">ESTIMATED TOTAL</th>
                        <th rowspan="2">Actions</th>
                    </tr>
                    <tr>
                        <th>Trade</th>
                        <th>Hours</th>
                        <th>Skill Level / HR</th> <!-- Now displays the rate -->
                        <th>OT/DT</th>
                        <th>Labor Total</th>
                        <th>Materials $/Unit</th>
                        <th>Materials Total</th>
                        <th>Equipment/Travel</th>
                        <th>Fixed</th>
                        <th>Sub-contractor</th>
                        <th>Other Total</th>
                        <th>Allowances</th>
                        <th>Allowance Total</th>
                        <th>Est. Allowance %</th>
                        <th>Allowance $</th>
                        <th>Total</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody id="estimateTableBody">
                    </tbody>
            </table>
        </div>
    </div>

    <div id="setupWizard" class="setup-wizard">
        <div class="wizard-content">
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="background: #3b82f6; width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;">
                    <span style="color: white; font-size: 36px;">üèóÔ∏è</span>
                </div>
                <h1>Project Setup</h1>
                <p style="color: #6b7280;">Let's configure your estimate for accuracy</p>
            </div>

            <div class="step-indicator">
                <div id="step1" class="step active">1</div>
                <div id="step2" class="step inactive">2</div>
                <div id="step3" class="step inactive">3</div>
            </div>

            <div id="wizardStep1">
                <h2 class="text-xl font-semibold mb-6">Project Information</h2>
                <div class="form-group">
                    <label for="projectName" class="label">Project Name:</label>
                    <input type="text" id="projectName" class="input-field" value="Commercial Construction Project">
                </div>
                <div class="form-group">
                    <label for="projectType" class="label">Project Type:</label>
                    <select id="projectType" class="input-field">
                        <option value="Commercial">Commercial</option>
                        <option value="Residential">Residential</option>
                        <option value="Industrial">Industrial</option>
                        <option value="Renovation">Renovation</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="projectState" class="label">State/Location:</label>
                    <select id="projectState" class="input-field">
                        <option value="CA">California</option>
                        <option value="TX">Texas</option>
                        <option value="NY">New York</option>
                        <option value="FL">Florida</option>
                        <option value="WA">Washington</option>
                        <option value="IL">Illinois</option>
                        <option value="AL">Alabama</option> <option value="AK">Alaska</option> <option value="AZ">Arizona</option> <option value="AR">Arkansas</option> <option value="CO">Colorado</option> <option value="CT">Connecticut</option> <option value="DE">Delaware</option> <option value="GA">Georgia</option> <option value="HI">Hawaii</option> <option value="ID">Idaho</option> <option value="IN">Indiana</option> <option value="IA">Iowa</option> <option value="KS">Kansas</option> <option value="KY">Kentucky</option> <option value="LA">Louisiana</option> <option value="ME">Maine</option> <option value="MD">Maryland</option> <option value="MA">Massachusetts</option> <option value="MI">Michigan</option> <option value="MN">Minnesota</option> <option value="MS">Mississippi</option> <option value="MO">Missouri</option> <option value="MT">Montana</option> <option value="NE">Nebraska</option> <option value="NV">Nevada</option> <option value="NH">New Hampshire</option> <option value="NJ">New Jersey</option> <option value="NM">New Mexico</option> <option value="NC">North Carolina</option> <option value="ND">North Dakota</option> <option value="OH">Ohio</option> <option value="OK">Oklahoma</option> <option value="OR">Oregon</option> <option value="PA">Pennsylvania</option> <option value="RI">Rhode Island</option> <option value="SC">South Carolina</option> <option value="SD">South Dakota</option> <option value="TN">Tennessee</option> <option value="UT">Utah</option> <option value="VT">Vermont</option> <option value="VA">Virginia</option> <option value="WV">West Virginia</option> <option value="WI">Wisconsin</option> <option value="WY">Wyoming</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="tradesInvolved" class="label">Trades Involved (Select multiple):</label>
                    <div class="multi-select-container">
                        <div id="selectedTradesDisplay" class="selected-trades-display" onclick="toggleTradeDropdown()">
                            Click to select trades...
                        </div>
                        <div id="tradesDropdown" class="multi-select-dropdown hidden">
                            <!-- Checkboxes will be populated here by JS -->
                        </div>
                    </div>
                </div>

                <div class="flex justify-end gap-3 mt-8">
                    <button class="btn btn-primary" onclick="nextStep(1)">Next</button>
                </div>
            </div>

            <div id="wizardStep2" class="hidden">
                <h2 class="text-xl font-semibold mb-6">Labor Rates Configuration</h2>
                <p class="text-gray-600 mb-4">Enter the hourly rates for each skill level within the selected trades.</p>
                <div id="dynamicLaborRateInputs" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Dynamic labor rate input fields will be injected here -->
                </div>
                
                <div class="flex justify-between gap-3 mt-8">
                    <button class="btn btn-primary" onclick="prevStep(2)">Previous</button>
                    <button class="btn btn-primary" onclick="nextStep(2)">Next</button>
                </div>
            </div>

            <div id="wizardStep3" class="hidden">
                <h2 class="text-xl font-semibold mb-6">Project Settings</h2>
                <div class="form-group">
                    <label for="profitMargin" class="label">Profit Margin (%):</label>
                    <input type="number" id="profitMargin" class="input-field" value="15">
                </div>
                <div class="form-group">
                    <label for="salesTax" class="label">Sales Tax (%):</label>
                    <input type="number" id="salesTax" class="input-field" value="8.25" step="0.01">
                </div>
                <div class="form-group">
                    <label for="miscellaneous" class="label">Miscellaneous (%):</label>
                    <input type="number" id="miscellaneous" class="input-field" value="5">
                </div>
                <div class="flex justify-between gap-3 mt-8">
                    <button class="btn btn-primary" onclick="prevStep(3)">Previous</button>
                    <button class="btn btn-green" onclick="startEstimating()">Start Estimating</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Helper function for currency formatting
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        // Global variables for project settings
        let projectSettings = {
            projectName: "Commercial Construction Project",
            projectType: "Commercial",
            projectState: "CA",
            profitMargin: 15,
            salesTax: 8.25,
            miscellaneous: 5,
            // Define labor rates nested by trade
            allTradeLaborRates: {
                "General": {
                    "Project Manager": 120,
                    "Superintendent": 100,
                    "General Foreman": 90,
                    "Foreman": 85,
                    "Journeyman": 75,
                    "Apprentice": 50
                },
                "Electrical": {
                    "Project Manager": 135,
                    "Superintendent": 110,
                    "General Foreman": 100,
                    "Foreman": 95,
                    "Journeyman": 80,
                    "Apprentice": 55
                },
                "Plumbing": {
                    "Project Manager": 125,
                    "Superintendent": 105,
                    "General Foreman": 95,
                    "Foreman": 90,
                    "Journeyman": 78,
                    "Apprentice": 52
                },
                "HVAC": {
                    "Project Manager": 130,
                    "Superintendent": 108,
                    "General Foreman": 98,
                    "Foreman": 92,
                    "Journeyman": 77,
                    "Apprentice": 53
                },
                "Carpentry": {
                    "Project Manager": 115,
                    "Superintendent": 95,
                    "General Foreman": 85,
                    "Foreman": 80,
                    "Journeyman": 70,
                    "Apprentice": 48
                },
                "Concrete": { "Project Manager": 110, "Superintendent": 90, "General Foreman": 80, "Foreman": 75, "Journeyman": 68, "Apprentice": 45 },
                "Roofing": { "Project Manager": 120, "Superintendent": 98, "General Foreman": 88, "Foreman": 83, "Journeyman": 73, "Apprentice": 47 },
                "Painting": { "Project Manager": 105, "Superintendent": 88, "General Foreman": 78, "Foreman": 73, "Journeyman": 65, "Apprentice": 42 },
                "Drywall": { "Project Manager": 112, "Superintendent": 92, "General Foreman": 82, "Foreman": 77, "Journeyman": 69, "Apprentice": 44 },
                "Masonry": { "Project Manager": 128, "Superintendent": 102, "General Foreman": 93, "Foreman": 88, "Journeyman": 76, "Apprentice": 51 },
                "Landscaping": { "Project Manager": 100, "Superintendent": 85, "General Foreman": 75, "Foreman": 70, "Journeyman": 60, "Apprentice": 40 }
            },
            activeTrades: ["General"], // Array to store selected trades
            // Placeholder global costs (as discussed, could be inputs later)
            travelCost: 1000,
            equipmentCost: 2000,
            fixedCost: 500,
            subcontractorCost: 3000,
            allowanceCost: 1500
        };

        // Estimate data structure
        let estimateItems = [];

        // UI Element references
        const setupWizard = document.getElementById('setupWizard');
        const mainApp = document.getElementById('mainApp');
        const wizardSteps = [
            document.getElementById('wizardStep1'),
            document.getElementById('wizardStep2'),
            document.getElementById('wizardStep3')
        ];
        const stepIndicators = [
            document.getElementById('step1'),
            document.getElementById('step2'),
            document.getElementById('step3')
        ];
        const estimateTableBody = document.getElementById('estimateTableBody');
        const dynamicLaborRateInputs = document.getElementById('dynamicLaborRateInputs'); // NEW: Reference for Step 2 dynamic rates display

        // Top-level summary elements
        const summaryTotalProposalElem = document.getElementById('summaryTotalProposal');
        const summaryOverallLaborHoursElem = document.getElementById('summaryOverallLaborHours');

        // Executive Summary elements
        const summaryProjectCost = document.getElementById('summaryProjectCost');
        const summaryMiscCost = document.getElementById('summaryMiscCost');
        const summaryMarkup = document.getElementById('summaryMarkup');
        const summaryEstimateSubtotal = document.getElementById('summaryEstimateSubtotal');
        const summaryProfitMargin = document.getElementById('summaryProfitMargin');
        const summarySalesTax = document.getElementById('summarySalesTax');
        const summaryMiscPercent = document.getElementById('summaryMiscPercent');

        const laborPMTotal = document.getElementById('laborPMTotal');
        const laborSuperintendentTotal = document.getElementById('laborSuperintendentTotal');
        const laborGeneralForemanTotal = document.getElementById('laborGeneralForemanTotal');
        const laborForemanTotal = document.getElementById('laborForemanTotal');
        const laborJourneymanTotal = document.getElementById('laborJourneymanTotal');
        const laborApprenticeTotal = document.getElementById('laborApprenticeTotal');

        const breakdownLaborTotal = document.getElementById('breakdownLaborTotal');
        const breakdownMaterialTotal = document.getElementById('breakdownMaterialTotal');
        const breakdownTravelTotal = document.getElementById('breakdownTravelTotal');
        const breakdownEquipmentTotal = document.getElementById('breakdownEquipmentTotal');
        const breakdownFixedTotal = document.getElementById('breakdownFixedTotal');
        const breakdownSubcontractorTotal = document.getElementById('breakdownSubcontractorTotal');
        const breakdownAllowanceTotal = document.getElementById('breakdownAllowanceTotal');
        const breakdownOtherTotal = document.getElementById('breakdownOtherTotal'); // Sum of all other costs

        const projectInfoElem = document.getElementById('projectInfo');
        const laborMaterialPieChartCanvas = document.getElementById('laborMaterialPieChart');
        let laborMaterialPieChart; // To store the Chart.js instance

        // Trade multi-select elements
        const tradesDropdown = document.getElementById('tradesDropdown');
        const selectedTradesDisplay = document.getElementById('selectedTradesDisplay');

        // Initial setup - show wizard
        document.addEventListener('DOMContentLoaded', () => {
            showSetup();
            // Set initial state tax
            updateSalesTaxForState(projectSettings.projectState);

            // Populate trades dropdown and display
            populateTradesDropdown();
            updateSelectedTradesDisplay();
            // populateWizardStep2LaborRates() called in showStep(2)
        });

        // --- Wizard Navigation ---
        let currentStep = 1;

        function showStep(stepNumber) {
            wizardSteps.forEach((stepDiv, index) => {
                if (index + 1 === stepNumber) {
                    stepDiv.classList.remove('hidden');
                } else {
                    stepDiv.classList.add('hidden');
                }
            });
            stepIndicators.forEach((indicator, index) => {
                if (index + 1 === stepNumber) {
                    indicator.classList.add('active');
                    indicator.classList.remove('inactive');
                } else {
                    indicator.classList.remove('active');
                    indicator.classList.add('inactive');
                }
            });
            currentStep = stepNumber;

            // Populate Step 2 dynamically when it's shown
            if (stepNumber === 2) {
                populateWizardStep2LaborRates();
            }
        }

        function nextStep(stepNumber) {
            if (stepNumber === 1) {
                // Save Project Info & Active Trades
                projectSettings.projectName = document.getElementById('projectName').value;
                projectSettings.projectType = document.getElementById('projectType').value;
                projectSettings.projectState = document.getElementById('projectState').value;
                // Active trades are updated via event listener on checkboxes
                updateSalesTaxForState(projectSettings.projectState);
            } else if (stepNumber === 2) {
                // No explicit save needed here as input changes update projectSettings directly
            }
            showStep(stepNumber + 1);
        }

        function prevStep(stepNumber) {
            showStep(stepNumber - 1);
        }

        function showSetup() {
            setupWizard.classList.remove('hidden');
            mainApp.classList.add('hidden');
            showStep(1); // Always start from step 1 when reconfiguring
            populateWizardInputs(); // Load current settings into wizard inputs
            populateTradesDropdown(); // Re-populate and sync trades checkboxes
            updateSelectedTradesDisplay(); // Update trade display
        }

        function startEstimating() {
            // Ensure at least one trade is selected
            if (projectSettings.activeTrades.length === 0) {
                renderMessageBox("Please select at least one trade involved in the project before starting the estimate.");
                return; // Stop function execution
            }
            // Ensure activeTrades have labor rates configured
            const allRoles = ["Project Manager", "Superintendent", "General Foreman", "Foreman", "Journeyman", "Apprentice"];
            for (const trade of projectSettings.activeTrades) {
                if (!projectSettings.allTradeLaborRates[trade]) {
                    renderMessageBox(`Labor rates for trade "${trade}" are not defined. Please define them or deselect this trade.`);
                    return;
                }
                for (const role of allRoles) {
                    if (projectSettings.allTradeLaborRates[trade][role] === undefined || projectSettings.allTradeLaborRates[trade][role] < 0) {
                        renderMessageBox(`Labor rate for "${role}" in "${trade}" is not valid. Please ensure all rates are non-negative numbers.`);
                        return;
                    }
                }
            }


            // Save final settings from Wizard
            projectSettings.projectName = document.getElementById('projectName').value;
            projectSettings.projectType = document.getElementById('projectType').value;
            projectSettings.projectState = document.getElementById('projectState').value;
            // Labor rates are handled by projectSettings.allTradeLaborRates and activeTrades
            projectSettings.profitMargin = parseFloat(document.getElementById('profitMargin').value) || 0;
            projectSettings.salesTax = parseFloat(document.getElementById('salesTax').value) || 0;
            projectSettings.miscellaneous = parseFloat(document.getElementById('miscellaneous').value) || 0;

            // Hide wizard, show main app
            setupWizard.classList.add('hidden');
            mainApp.classList.remove('hidden');

            // Update project info in main app header
            projectInfoElem.textContent = `${projectSettings.projectType} - ${projectSettings.projectName} - ${projectSettings.projectState}`;

            // Initial render of items (if any exist) and calculate totals
            // If no items, add a default one to start
            if (estimateItems.length === 0) {
                addItem();
            } else {
                renderItems();
            }
        }

        // --- Data Management Functions ---

        function populateWizardInputs() {
            document.getElementById('projectName').value = projectSettings.projectName;
            document.getElementById('projectType').value = projectSettings.projectType;
            document.getElementById('projectState').value = projectSettings.projectState;
            document.getElementById('profitMargin').value = projectSettings.profitMargin;
            document.getElementById('salesTax').value = projectSettings.salesTax;
            document.getElementById('miscellaneous').value = projectSettings.miscellaneous;
            // labor rates handled by populateWizardStep2LaborRates
        }

        const stateSalesTax = {
            'CA': 8.25, 'TX': 6.25, 'NY': 4.0, 'FL': 6.0, 'WA': 6.5, 'IL': 6.25,
            'AL': 4.0, 'AK': 0.0, 'AZ': 5.6, 'AR': 6.5, 'CO': 2.9, 'CT': 6.35, 'DE': 0.0,
            'GA': 4.0, 'HI': 4.0, 'ID': 6.0, 'IN': 7.0, 'IA': 6.0, 'KS': 6.5, 'KY': 6.0,
            'LA': 4.45, 'ME': 5.5, 'MD': 6.0, 'MA': 6.25, 'MI': 6.0, 'MN': 6.875, 'MS': 7.0,
            'MO': 4.225, 'MT': 0.0, 'NE': 5.5, 'NV': 6.85, 'NH': 0.0, 'NJ': 6.625, 'NM': 5.125,
            'NC': 4.75, 'ND': 5.0, 'OH': 5.75, 'OK': 4.5, 'OR': 0.0, 'PA': 6.0, 'RI': 7.0,
            'SC': 6.0, 'SD': 4.5, 'TN': 7.0, 'UT': 4.85, 'VT': 6.0, 'VA': 5.3, 'WV': 6.0,
            'WI': 5.0, 'WY': 4.0
        };

        function updateSalesTaxForState(stateCode) {
            const taxRate = stateSalesTax[stateCode] || 0; // Default to 0 if state not found
            document.getElementById('salesTax').value = taxRate;
            projectSettings.salesTax = taxRate; // Update project settings immediately
        }

        document.getElementById('projectState').addEventListener('change', (event) => {
            updateSalesTaxForState(event.target.value);
        });

        // NEW: Function to dynamically populate labor rates in Step 2 of the wizard for input
        function populateWizardStep2LaborRates() {
            dynamicLaborRateInputs.innerHTML = ''; // Clear existing content

            const allRoles = ["Project Manager", "Superintendent", "General Foreman", "Foreman", "Journeyman", "Apprentice"];

            if (projectSettings.activeTrades.length === 0) {
                dynamicLaborRateInputs.innerHTML = `<p class="text-gray-600">Please select trades in Step 1 to configure their labor rates here.</p>`;
                return;
            }

            projectSettings.activeTrades.forEach(trade => {
                let tradeRatesHtml = `
                    <div class="trade-labor-rates-group">
                        <h3>${trade} Labor Rates</h3>`;
                
                allRoles.forEach(role => {
                    // Ensure the trade and role exist in allTradeLaborRates, provide default if not
                    if (!projectSettings.allTradeLaborRates[trade]) {
                        projectSettings.allTradeLaborRates[trade] = {};
                    }
                    if (projectSettings.allTradeLaborRates[trade][role] === undefined) {
                        // Use a reasonable default if a role rate isn't set for a new trade
                        projectSettings.allTradeLaborRates[trade][role] = 75; // Default for new roles/trades
                    }

                    const inputId = `rate-${trade.replace(/\s/g, '')}-${role.replace(/\s/g, '')}`;
                    tradeRatesHtml += `
                        <div class="form-group">
                            <label for="${inputId}" class="label">${role} ($/hr):</label>
                            <input type="number" id="${inputId}" class="input-field" value="${projectSettings.allTradeLaborRates[trade][role]}"
                                onchange="updateLaborRate('${trade}', '${role}', this.value)">
                        </div>
                    `;
                });
                tradeRatesHtml += `</div>`;
                dynamicLaborRateInputs.innerHTML += tradeRatesHtml;
            });
        }

        // NEW: Function to update labor rates in projectSettings from wizard inputs
        function updateLaborRate(trade, role, value) {
            const parsedValue = parseFloat(value);
            if (!isNaN(parsedValue) && parsedValue >= 0) {
                projectSettings.allTradeLaborRates[trade][role] = parsedValue;
            } else {
                // Optionally provide feedback if input is invalid
                console.error(`Invalid input for ${trade} ${role} rate: ${value}`);
                // Revert to old value or set to 0 if invalid
                const inputId = `rate-${trade.replace(/\s/g, '')}-${role.replace(/\s/g, '')}`;
                document.getElementById(inputId).value = projectSettings.allTradeLaborRates[trade][role];
            }
            // No need to call renderItems here immediately, it will be called on startEstimating or next steps.
        }


        // --- Custom Message Box (instead of alert) ---
        function renderMessageBox(message) {
            const messageBoxOverlay = document.createElement('div');
            messageBoxOverlay.id = 'messageBoxOverlay';
            messageBoxOverlay.className = 'fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[1001] backdrop-filter backdrop-blur-sm';
            
            const messageBox = document.createElement('div');
            messageBox.className = 'bg-white rounded-xl p-8 shadow-2xl max-w-sm mx-auto text-center';
            messageBox.innerHTML = `
                <p class="text-lg font-semibold text-gray-800 mb-6">${message}</p>
                <button class="btn btn-primary" onclick="closeMessageBox()">OK</button>
            `;
            messageBoxOverlay.appendChild(messageBox);
            document.body.appendChild(messageBoxOverlay);
        }

        function closeMessageBox() {
            const messageBoxOverlay = document.getElementById('messageBoxOverlay');
            if (messageBoxOverlay) {
                messageBoxOverlay.remove();
            }
        }

        // --- Multi-Select Trade Logic ---
        function populateTradesDropdown() {
            tradesDropdown.innerHTML = ''; // Clear existing checkboxes
            const allTrades = Object.keys(projectSettings.allTradeLaborRates);

            allTrades.forEach(trade => {
                const checkboxId = `trade-${trade.replace(/\s/g, '-')}`;
                const isChecked = projectSettings.activeTrades.includes(trade);

                const label = document.createElement('label');
                label.className = 'flex items-center';
                label.innerHTML = `
                    <input type="checkbox" id="${checkboxId}" value="${trade}" ${isChecked ? 'checked' : ''} onchange="handleTradeSelection(this)">
                    <span>${trade}</span>
                `;
                tradesDropdown.appendChild(label);
            });
        }

        function handleTradeSelection(checkbox) {
            const trade = checkbox.value;
            if (checkbox.checked) {
                if (!projectSettings.activeTrades.includes(trade)) {
                    projectSettings.activeTrades.push(trade);
                    // If a new trade is selected, ensure it has default labor rates initialized
                    if (!projectSettings.allTradeLaborRates[trade]) {
                        projectSettings.allTradeLaborRates[trade] = {
                            "Project Manager": 120, "Superintendent": 100, "General Foreman": 90,
                            "Foreman": 85, "Journeyman": 75, "Apprentice": 50
                        };
                    }
                }
            } else {
                projectSettings.activeTrades = projectSettings.activeTrades.filter(t => t !== trade);
                // Also remove any line items associated with this trade if it's deselected
                estimateItems = estimateItems.filter(item => item.trade !== trade);
            }
            updateSelectedTradesDisplay();
            renderItems(); // Re-render table to reflect trade changes
            populateWizardStep2LaborRates(); // Re-populate Step 2 to show/hide relevant trade rate inputs
        }

        function toggleTradeDropdown() {
            tradesDropdown.classList.toggle('hidden');
        }

        function updateSelectedTradesDisplay() {
            selectedTradesDisplay.innerHTML = '';
            if (projectSettings.activeTrades.length === 0) {
                selectedTradesDisplay.textContent = 'Click to select trades...';
            } else {
                projectSettings.activeTrades.forEach(trade => {
                    const span = document.createElement('span');
                    span.className = 'selected-trade-tag';
                    span.innerHTML = `${trade} <span class="remove-tag" data-trade="${trade}">&times;</span>`;
                    selectedTradesDisplay.appendChild(span);
                });
            }
        }

        // Add event listener for removing tags
        selectedTradesDisplay.addEventListener('click', (event) => {
            if (event.target.classList.contains('remove-tag')) {
                const tradeToRemove = event.target.dataset.trade;
                const checkboxId = `trade-${tradeToRemove.replace(/\s/g, '-')}`;
                const checkbox = document.getElementById(checkboxId);
                if (checkbox) {
                    checkbox.checked = false;
                    handleTradeSelection(checkbox);
                }
            }
        });

        // Close trade dropdown if clicking outside
        document.addEventListener('click', (event) => {
            if (!tradesDropdown.contains(event.target) && !selectedTradesDisplay.contains(event.target)) {
                tradesDropdown.classList.add('hidden');
            }
        });


        // --- Estimate Item Management ---

        function addItem() {
            // Use the first active trade as default, or "General" if no specific trades are active
            const defaultTrade = projectSettings.activeTrades.length > 0 ? projectSettings.activeTrades[0] : "General";
            const defaultRole = "Journeyman"; // Default role

            const newItem = {
                id: Date.now(), // Unique ID for each item
                taskName: '',
                description: '',
                trade: defaultTrade, // Assign default trade
                rateRole: defaultRole, // Default to Journeyman
                hours: 0,
                otDtMultiplier: 1.0, // New: OT/DT multiplier
                materialPerUnit: 0, // NEW
                materialUnits: 0, // NEW (can be unit cost * quantity)
                equipmentTravel: 0, // NEW
                fixedCostLineItem: 0, // NEW
                subcontractorCostLineItem: 0, // NEW
                otherCostLineItem: 0, // NEW (general 'other' for line item)
                allowances: 0, // NEW
                estimatedAllowancePercent: 0 // NEW
            };
            estimateItems.push(newItem);
            renderItems();
        }

        function deleteItem(id) {
            estimateItems = estimateItems.filter(item => item.id !== id);
            renderItems();
        }

        function updateItem(id, field, value) {
            const item = estimateItems.find(item => item.id === id);
            if (item) {
                if (['hours', 'materialPerUnit', 'materialUnits', 'equipmentTravel', 'fixedCostLineItem', 'subcontractorCostLineItem', 'otherCostLineItem', 'allowances', 'estimatedAllowancePercent', 'otDtMultiplier'].includes(field)) {
                    item[field] = parseFloat(value) || 0;
                } else { // For text fields like taskName, description, trade, rateRole
                    item[field] = value;
                }
                renderItems(); // Re-render to update calculations
            }
        }

        function renderItems() {
            estimateTableBody.innerHTML = ''; // Clear existing rows
            let totalLaborHoursVal = 0; // To accumulate total labor hours for the overall metric

            estimateItems.forEach(item => {
                // Ensure the item's trade is still active, default to "General" if not
                if (!projectSettings.activeTrades.includes(item.trade)) {
                    item.trade = projectSettings.activeTrades.length > 0 ? projectSettings.activeTrades[0] : "General";
                }
                
                const laborRate = projectSettings.allTradeLaborRates[item.trade]?.[item.rateRole] || 0;
                const effectiveLaborRate = laborRate * (item.otDtMultiplier || 1.0);
                const laborTotal = item.hours * effectiveLaborRate;
                const materialsTotal = item.materialPerUnit * item.materialUnits;
                const otherCategoryTotal = item.equipmentTravel + item.fixedCostLineItem + item.subcontractorCostLineItem + item.otherCostLineItem;
                const allowanceTotal = item.allowances; // Direct allowance amount
                const markupAllowance = allowanceTotal * (item.estimatedAllowancePercent / 100);

                const lineTotalEstimate = laborTotal + materialsTotal + otherCategoryTotal;
                const lineTotalAllowance = allowanceTotal + markupAllowance;

                totalLaborHoursVal += item.hours;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="text" value="${item.taskName}" onchange="updateItem(${item.id}, 'taskName', this.value)" class="input-field"></td>
                    <td><input type="text" value="${item.description}" onchange="updateItem(${item.id}, 'description', this.value)" class="input-field"></td>
                    
                    <td>
                        <select onchange="updateItem(${item.id}, 'trade', this.value)" class="input-field">
                            ${projectSettings.activeTrades.map(trade => `
                                <option value="${trade}" ${item.trade === trade ? 'selected' : ''}>
                                    ${trade}
                                </option>
                            `).join('')}
                             ${projectSettings.activeTrades.length === 0 ? '<option value="General" selected>General (No Trades Selected)</option>' : ''}
                        </select>
                    </td>
                    <td><input type="number" value="${item.hours}" onchange="updateItem(${item.id}, 'hours', this.value)" class="input-field"></td>
                    <td>
                        <!-- Skill Level / HR (read-only display) -->
                        <select onchange="updateItem(${item.id}, 'rateRole', this.value)" class="input-field">
                            ${(projectSettings.allTradeLaborRates[item.trade] ? Object.keys(projectSettings.allTradeLaborRates[item.trade]) : []).map(role => `
                                <option value="${role}" ${item.rateRole === role ? 'selected' : ''}>
                                    ${role} (${formatCurrency(projectSettings.allTradeLaborRates[item.trade][role])}/hr)
                                </option>
                            `).join('')}
                            ${!projectSettings.allTradeLaborRates[item.trade] || Object.keys(projectSettings.allTradeLaborRates[item.trade]).length === 0 ? '<option value="" selected>No Rates for Trade</option>' : ''}
                        </select>
                    </td>
                    <td>
                        <select onchange="updateItem(${item.id}, 'otDtMultiplier', this.value)" class="input-field">
                            <option value="1.0" ${item.otDtMultiplier === 1.0 ? 'selected' : ''}>1.0</option>
                            <option value="1.5" ${item.otDtMultiplier === 1.5 ? 'selected' : ''}>1.5</option>
                            <option value="2.0" ${item.otDtMultiplier === 2.0 ? 'selected' : ''}>2.0</option>
                        </select>
                    </td>
                    <td>${formatCurrency(laborTotal)}</td>
                    <td><input type="number" value="${item.materialPerUnit}" onchange="updateItem(${item.id}, 'materialPerUnit', this.value)" class="input-field"></td>
                    <td>${formatCurrency(materialsTotal)}</td>
                    <td><input type="number" value="${item.equipmentTravel}" onchange="updateItem(${item.id}, 'equipmentTravel', this.value)" class="input-field"></td>
                    <td><input type="number" value="${item.fixedCostLineItem}" onchange="updateItem(${item.id}, 'fixedCostLineItem', this.value)" class="input-field"></td>
                    <td><input type="number" value="${item.subcontractorCostLineItem}" onchange="updateItem(${item.id}, 'subcontractorCostLineItem', this.value)" class="input-field"></td>
                    <td><input type="number" value="${item.otherCostLineItem}" onchange="updateItem(${item.id}, 'otherCostLineItem', this.value)" class="input-field"></td>
                    <td><input type="number" value="${item.allowances}" onchange="updateItem(${item.id}, 'allowances', this.value)" class="input-field"></td>
                    <td>${formatCurrency(allowanceTotal)}</td>
                    <td><input type="number" value="${item.estimatedAllowancePercent}" onchange="updateItem(${item.id}, 'estimatedAllowancePercent', this.value)" class="input-field"></td>
                    <td>${formatCurrency(markupAllowance)}</td>
                    <td class="font-bold text-gray-900">${formatCurrency(lineTotalEstimate)}</td>
                    <td class="font-bold text-gray-900">${formatCurrency(lineTotalAllowance)}</td>
                    <td><button class="btn btn-red btn-sm" onclick="deleteItem(${item.id})">üóëÔ∏è</button></td>
                `;
                estimateTableBody.appendChild(row);
            });
            summaryOverallLaborHoursElem.textContent = totalLaborHoursVal.toFixed(2); // Update overall labor hours
            calculateTotals(); // Recalculate and update executive summary
        }

        // --- Calculations ---

        function calculateTotals() {
            let totalProjectSubtotal = 0; // Sum of all line item estimate totals
            let totalLaborCost = 0;
            let totalMaterialCost = 0;
            let totalLineItemOtherCostsSum = 0;
            let totalAllowanceAmount = 0;
            let totalMarkupAllowance = 0;

            let laborBreakdown = {}; // To store labor cost per role
            // Initialize labor breakdown totals across all trades
            // Only consider roles that are actually present in any active trade
            const allPossibleRoles = new Set();
            projectSettings.activeTrades.forEach(trade => {
                if (projectSettings.allTradeLaborRates[trade]) {
                    Object.keys(projectSettings.allTradeLaborRates[trade]).forEach(role => allPossibleRoles.add(role));
                }
            });
            allPossibleRoles.forEach(role => {
                laborBreakdown[role] = 0;
            });


            estimateItems.forEach(item => {
                const laborRate = projectSettings.allTradeLaborRates[item.trade]?.[item.rateRole] || 0;
                const effectiveLaborRate = laborRate * (item.otDtMultiplier || 1.0);
                const laborTotal = item.hours * effectiveLaborRate;
                const materialsTotal = item.materialPerUnit * item.materialUnits;
                const otherCategoryTotal = item.equipmentTravel + item.fixedCostLineItem + item.subcontractorCostLineItem + item.otherCostLineItem;
                const allowanceLineTotal = item.allowances;
                const markupAllowanceLineItem = allowanceLineTotal * (item.estimatedAllowancePercent / 100);

                const lineTotalEstimate = laborTotal + materialsTotal + otherCategoryTotal;

                totalProjectSubtotal += lineTotalEstimate;
                totalLaborCost += laborTotal;
                totalMaterialCost += materialsTotal;
                totalLineItemOtherCostsSum += otherCategoryTotal;
                totalAllowanceAmount += allowanceLineTotal;
                totalMarkupAllowance += markupAllowanceLineItem;

                // Aggregate labor costs by role, regardless of trade
                if (laborBreakdown[item.rateRole] !== undefined) {
                    laborBreakdown[item.rateRole] += laborTotal;
                }
            });

            // Sum up the global cost categories from projectSettings
            const globalOtherCosts = projectSettings.travelCost + projectSettings.equipmentCost +
                                     projectSettings.fixedCost + projectSettings.subcontractorCost +
                                     projectSettings.allowanceCost;
            
            // Total 'Other Costs' for breakdown includes line item specific, global fixed costs
            const breakdownTotalOtherCosts = totalLineItemOtherCostsSum + globalOtherCosts;


            // Calculate main totals based on the screenshot's flow
            const totalMiscCostAmount = totalProjectSubtotal * (projectSettings.miscellaneous / 100);
            const subtotalBeforeProfitTax = totalProjectSubtotal + totalMiscCostAmount; // "Project Cost" in summary + "Total Misc Cost"
            const totalMarkupAmount = subtotalBeforeProfitTax * (projectSettings.profitMargin / 100);
            const estimateSubtotalAmount = subtotalBeforeProfitTax + totalMarkupAmount; // "Estimate Subtotal" in summary

            const salesTaxAmount = estimateSubtotalAmount * (projectSettings.salesTax / 100);
            const grandTotal = estimateSubtotalAmount + salesTaxAmount + totalAllowanceAmount + totalMarkupAllowance; // "Total Proposal"


            // Update NEW Top-level Summary UI
            summaryTotalProposalElem.textContent = formatCurrency(grandTotal);
            summaryOverallLaborHoursElem.textContent = estimateItems.reduce((acc, item) => acc + item.hours, 0).toFixed(2);


            // Update Executive Summary UI (left card)
            summaryProjectCost.textContent = formatCurrency(totalProjectSubtotal);
            summaryMiscCost.textContent = formatCurrency(totalMiscCostAmount);
            summaryMarkup.textContent = formatCurrency(totalMarkupAmount);
            summaryEstimateSubtotal.textContent = formatCurrency(estimateSubtotalAmount);
            summaryProfitMargin.textContent = `${projectSettings.profitMargin.toFixed(2)}%`;
            summarySalesTax.textContent = `${projectSettings.salesTax.toFixed(2)}%`;
            summaryMiscPercent.textContent = `${projectSettings.miscellaneous.toFixed(2)}%`;

            // Update Labor Breakdown (middle card)
            laborPMTotal.textContent = formatCurrency(laborBreakdown["Project Manager"] || 0);
            laborSuperintendentTotal.textContent = formatCurrency(laborBreakdown["Superintendent"] || 0);
            laborGeneralForemanTotal.textContent = formatCurrency(laborBreakdown["General Foreman"] || 0);
            laborForemanTotal.textContent = formatCurrency(laborBreakdown["Foreman"] || 0);
            laborJourneymanTotal.textContent = formatCurrency(laborBreakdown["Journeyman"] || 0);
            laborApprenticeTotal.textContent = formatCurrency(laborBreakdown["Apprentice"] || 0);

            // Update Project Cost Breakdown (right card)
            breakdownLaborTotal.textContent = formatCurrency(totalLaborCost);
            breakdownMaterialTotal.textContent = formatCurrency(totalMaterialCost);
            breakdownTravelTotal.textContent = formatCurrency(projectSettings.travelCost);
            breakdownEquipmentTotal.textContent = formatCurrency(projectSettings.equipmentCost);
            breakdownFixedTotal.textContent = formatCurrency(projectSettings.fixedCost);
            breakdownSubcontractorTotal.textContent = formatCurrency(projectSettings.subcontractorCost);
            breakdownAllowanceTotal.textContent = formatCurrency(totalAllowanceAmount); // Sum of allowances from line items
            breakdownOtherTotal.textContent = formatCurrency(breakdownTotalOtherCosts); // Updated sum including new global costs

            // Render Pie Chart
            renderPieChart(totalLaborCost, totalMaterialCost);
        }

        // --- Pie Chart Rendering ---
        function renderPieChart(laborTotal, materialTotal) {
            if (laborMaterialPieChart) {
                laborMaterialPieChart.destroy(); // Destroy previous chart instance if it exists
            }

            const ctx = laborMaterialPieChartCanvas.getContext('2d');
            laborMaterialPieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Labor Cost', 'Material Cost'],
                    datasets: [{
                        data: [laborTotal, materialTotal],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)', // Blue for Labor
                            'rgba(16, 185, 129, 0.8)'  // Green for Materials
                        ],
                        borderColor: [
                            'rgba(255, 255, 255, 1)',
                            'rgba(255, 255, 255, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Allow canvas to resize freely
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        // Use formatCurrency for tooltip values
                                        label += formatCurrency(context.parsed);
                                    }
                                    return label;
                                }
                            }
                        },
                        title: {
                            display: false, /* Moved title to H4 tag in HTML */
                            text: 'Labor vs. Material Cost Distribution',
                            font: {
                                size: 16
                            },
                            color: '#1f2937'
                        }
                    }
                }
            });
        }

        // --- Report Generation ---

        function generateReport() {
            let totalProjectSubtotal = 0;
            let totalLaborCost = 0;
            let totalMaterialCost = 0;
            let totalLineItemOtherCostsSum = 0;
            let totalAllowanceAmount = 0;
            let totalMarkupAllowance = 0;

            let laborBreakdownReport = {};
            let totalLaborHoursReport = 0;

            // Initialize labor breakdown totals across all trades
            const allPossibleRolesReport = new Set();
            projectSettings.activeTrades.forEach(trade => {
                if (projectSettings.allTradeLaborRates[trade]) {
                    Object.keys(projectSettings.allTradeLaborRates[trade]).forEach(role => allPossibleRolesReport.add(role));
                }
            });
            allPossibleRolesReport.forEach(role => {
                laborBreakdownReport[role] = 0;
            });


            estimateItems.forEach((item) => {
                const laborRate = projectSettings.allTradeLaborRates[item.trade]?.[item.rateRole] || 0;
                const effectiveLaborRate = laborRate * (item.otDtMultiplier || 1.0);
                const laborTotal = item.hours * effectiveLaborRate;
                const materialsTotal = item.materialPerUnit * item.materialUnits;
                const otherCategoryTotal = item.equipmentTravel + item.fixedCostLineItem + item.subcontractorCostLineItem + item.otherCostLineItem;
                const allowanceLineTotal = item.allowances;
                const markupAllowanceLineItem = allowanceLineTotal * (item.estimatedAllowancePercent / 100);

                const lineTotalEstimate = laborTotal + materialsTotal + otherCategoryTotal;

                totalProjectSubtotal += lineTotalEstimate;
                totalLaborCost += laborTotal;
                totalMaterialCost += materialsTotal;
                totalLineItemOtherCostsSum += otherCategoryTotal;
                totalAllowanceAmount += allowanceLineTotal;
                totalMarkupAllowance += markupAllowanceLineItem;
                totalLaborHoursReport += item.hours;

                // Aggregate labor costs by role, regardless of trade
                if (laborBreakdownReport[item.rateRole] !== undefined) {
                    laborBreakdownReport[item.rateRole] += laborTotal;
                }
            });

            // Add global costs to totalOtherCostsAggregated for report
            const globalOtherCosts = projectSettings.travelCost + projectSettings.equipmentCost +
                                         projectSettings.fixedCost + projectSettings.subcontractorCost +
                                         projectSettings.allowanceCost;
            
            const breakdownTotalOtherCosts = totalLineItemOtherCostsSum + globalOtherCosts;


            const totalMiscCostAmount = totalProjectSubtotal * (projectSettings.miscellaneous / 100);
            const subtotalBeforeProfitTax = totalProjectSubtotal + totalMiscCostAmount;
            const totalMarkupAmount = subtotalBeforeProfitTax * (projectSettings.profitMargin / 100);
            const estimateSubtotalAmount = subtotalBeforeProfitTax + totalMarkupAmount;

            const salesTaxAmount = estimateSubtotalAmount * (projectSettings.salesTax / 100);
            const grandTotal = estimateSubtotalAmount + salesTaxAmount + totalAllowanceAmount + totalMarkupAllowance; // "Total Proposal"


            let reportContent = `CONSTRUCTION ESTIMATE REPORT\n`;
            reportContent += `============================\n\n`;
            reportContent += `Project: ${projectSettings.projectName}\n`;
            reportContent += `Project Type: ${projectSettings.projectType}\n`;
            reportContent += `Location: ${projectSettings.projectState}\n`;
            reportContent += `Date: ${new Date().toLocaleDateString()}\n\n`;

            reportContent += `OVERALL SUMMARY:\n`;
            reportContent += `-------------------------------------------------\n`;
            reportContent += `Total Proposal: ${formatCurrency(grandTotal)}\n`;
            reportContent += `Total Labor Hours: ${totalLaborHoursReport.toFixed(2)}\n\n`;


            reportContent += `EXECUTIVE SUMMARY DETAILS:\n`;
            reportContent += `-------------------------------------------------\n`;
            reportContent += `Total Project Cost (Line Items Base): ${formatCurrency(totalProjectSubtotal)}\n`;
            reportContent += `Total Miscellaneous Cost (${projectSettings.miscellaneous.toFixed(2)}%): ${formatCurrency(totalMiscCostAmount)}\n`;
            reportContent += `Total Markup (${projectSettings.profitMargin.toFixed(2)}%): ${formatCurrency(totalMarkupAmount)}\n`;
            reportContent += `Estimate Subtotal (before sales tax): ${formatCurrency(estimateSubtotalAmount)}\n`;
            reportContent += `Sales Tax (${projectSettings.salesTax.toFixed(2)}%): ${formatCurrency(salesTaxAmount)}\n\n`;


            reportContent += `LABOR BREAKDOWN:\n`;
            reportContent += `-------------------------------------------------\n`;
            for (const role in laborBreakdownReport) {
                reportContent += `${role}: ${formatCurrency(laborBreakdownReport[role])}\n`;
            }
            reportContent += `\n`; // Add extra newline for readability

            reportContent += `PROJECT COST BREAKDOWN:\n`;
            reportContent += `-------------------------------------------------\n`;
            reportContent += `Labor Total: ${formatCurrency(totalLaborCost)}\n`;
            reportContent += `Material Total: ${formatCurrency(totalMaterialCost)}\n`;
            reportContent += `Travel Total: ${formatCurrency(projectSettings.travelCost)}\n`;
            reportContent += `Equipment Total: ${formatCurrency(projectSettings.equipmentCost)}\n`;
            reportContent += `Fixed Total: ${formatCurrency(projectSettings.fixedCost)}\n`;
            reportContent += `Sub-contractor Total: ${formatCurrency(projectSettings.subcontractorCost)}\n`;
            reportContent += `Allowance Total: ${formatCurrency(totalAllowanceAmount)}\n`;
            reportContent += `Total Other Costs (Aggregated): ${formatCurrency(breakdownTotalOtherCosts)}\n\n`;


            reportContent += `ESTIMATE LINE ITEMS:\n`;
            reportContent += `====================\n`;

            estimateItems.forEach((item, index) => {
                const laborRate = projectSettings.allTradeLaborRates[item.trade]?.[item.rateRole] || 0;
                const effectiveLaborRate = laborRate * (item.otDtMultiplier || 1.0);
                const laborTotal = item.hours * effectiveLaborRate;
                const materialsTotal = item.materialPerUnit * item.materialUnits;
                const otherCategoryTotal = item.equipmentTravel + item.fixedCostLineItem + item.subcontractorCostLineItem + item.otherCostLineItem;
                const allowanceLineTotal = item.allowances;
                const markupAllowanceLineItem = allowanceLineTotal * (item.estimatedAllowancePercent / 100);

                const lineTotalEstimate = laborTotal + materialsTotal + otherCategoryTotal;
                const lineTotalAllowance = allowanceLineTotal + markupAllowanceLineItem;

                reportContent += `\nItem ${index + 1}: ${item.taskName || 'N/A'}\n`;
                reportContent += `  Description: ${item.description || 'No description'}\n`;
                reportContent += `  Trade: ${item.trade}\n`;
                reportContent += `  Hours: ${item.hours.toFixed(2)}\n`;
                reportContent += `  Skill Level / HR: ${item.rateRole} (${formatCurrency(laborRate)}/hr)\n`;
                reportContent += `  OT/DT Multiplier: ${item.otDtMultiplier.toFixed(1)}\n`;
                reportContent += `  Effective Labor Rate: ${formatCurrency(effectiveLaborRate)}/hr\n`;
                reportContent += `  Labor Total: ${formatCurrency(laborTotal)}\n`;
                reportContent += `  Materials Per Unit: ${formatCurrency(item.materialPerUnit)}\n`;
                reportContent += `  Material Units: ${item.materialUnits}\n`;
                reportContent += `  Materials Total: ${formatCurrency(materialsTotal)}\n`;
                reportContent += `  Equipment/Travel: ${formatCurrency(item.equipmentTravel)}\n`;
                reportContent += `  Fixed Cost (Line Item): ${formatCurrency(item.fixedCostLineItem)}\n`;
                reportContent += `  Sub-contractor (Line Item): ${formatCurrency(item.subcontractorCostLineItem)}\n`;
                reportContent += `  Other Cost (Line Item): ${formatCurrency(item.otherCostLineItem)}\n`;
                reportContent += `  Total Other (Line Item Category): ${formatCurrency(otherCategoryTotal)}\n`;
                reportContent += `  Allowance Amount: ${formatCurrency(item.allowances)}\n`;
                reportContent += `  Estimated Allowance %: ${item.estimatedAllowancePercent.toFixed(2)}%\n`;
                reportContent += `  Allowance Markup: ${formatCurrency(markupAllowanceLineItem)}\n`;
                reportContent += `  Line Total (Estimate Portion): ${formatCurrency(lineTotalEstimate)}\n`;
                reportContent += `  Line Total (Allowance Portion): ${formatCurrency(lineTotalAllowance)}\n`;
            });

            reportContent += `\nEnd of Report\n`;

            // Download report
            const blob = new Blob([reportContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${projectSettings.projectName.replace(/\s/g, '_')}_Estimate_Report.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
